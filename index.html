<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TerraRun | Захват Территории</title>

    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Подключение Leaflet JS и CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Подключение Turf.js для гео-анализа -->
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    
    <!-- Подключение плагина Leaflet.TextPath для текста вдоль линии -->
    <script src="https://unpkg.com/leaflet-textpath/leaflet.textpath.js"></script>
    
    <!-- Подключение Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Подключение Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            overscroll-behavior: none;
            background: linear-gradient(170deg, #f3f4f6, #e5e7eb);
        }
        #map, .mini-map {
            z-index: 10;
            background-color: #f3f4f6;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 80px;
        }
        .view {
            display: none;
            height: calc(100vh - 80px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transition: opacity 0.3s ease-in-out;
        }
        .view.active {
            display: block;
        }
        .nav-btn.active svg, .nav-btn.active span {
            color: #3b82f6;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-gradient {
            background-image: linear-gradient(to right, #3b82f6, #60a5fa);
        }
        .btn-gradient-red {
             background-image: linear-gradient(to right, #ef4444, #f87171);
        }
        .avatar-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 15px rgba(0,0,0,0.4);
            background-size: cover;
            background-position: center;
            transition: transform 0.2s ease-in-out;
        }
        .avatar-marker:hover {
            transform: scale(1.1);
        }
        .current-user-marker {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 2px 15px rgba(0,0,0,0.4), 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 2px 15px rgba(0,0,0,0.4), 0 0 0 15px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 2px 15px rgba(0,0,0,0.4), 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="font-sans antialiased overflow-hidden">

    <!-- Экран-заглушка / Вход -->
    <div id="auth-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center p-4 z-50">
        <div id="login-map-bg" class="absolute inset-0 z-10 filter blur-sm brightness-90"></div>
        <div id="auth-content" class="z-20">
            <!-- Содержимое будет сгенерировано JS -->
        </div>
    </div>

    <!-- Основной контейнер приложения -->
    <div id="app-container" class="hidden">
        <!-- Вид 1: Карта -->
        <div id="map-view" class="view active">
            <div id="map"></div>
            <button id="recenter-btn" class="z-20 fixed top-4 right-4 bg-white/80 backdrop-blur-md p-3 rounded-full shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0zM15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
            <div id="run-controls" class="fixed bottom-24 left-0 right-0 p-4 z-20">
                <div class="max-w-md mx-auto bg-white/80 backdrop-blur-md rounded-2xl shadow-xl p-4 flex items-center justify-between fade-in">
                    <div class="flex flex-col">
                        <span id="username-display" class="font-bold text-gray-800 text-lg">TerraRun</span>
                        <span id="area-display" class="text-sm text-gray-600">Площадь: 0 м²</span>
                    </div>
                    <button id="toggle-run-btn" class="btn-gradient text-white font-bold py-3 px-6 rounded-full transition-all duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300">
                        Старт
                    </button>
                </div>
            </div>
        </div>

        <!-- Вид 2: Лента -->
        <div id="feed-view" class="view bg-gray-50 p-4 fade-in">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 px-2">Лента</h1>
            <div id="feed-container" class="space-y-4"></div>
        </div>

        <!-- Вид 3: Топ пользователей -->
        <div id="top-view" class="view bg-gray-50 p-4 fade-in">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 px-2">Топ Бегунов</h1>
            <div id="leaderboard" class="space-y-3"></div>
        </div>

        <!-- Вид 4: Профиль -->
        <div id="profile-view" class="view bg-gray-50 p-4 fade-in">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 px-2">Профиль</h1>
            <div class="bg-white rounded-2xl shadow-lg p-6 space-y-6">
                <div class="flex items-center space-x-4">
                    <div id="profile-avatar-wrapper" class="w-20 h-20 rounded-full border-4 flex-shrink-0">
                        <img src="https://placehold.co/80x80/E2E8F0/4A5568?text=?" id="profile-avatar-img" class="w-full h-full rounded-full object-cover" alt="avatar">
                    </div>
                    <div>
                        <h2 id="profile-name" class="text-2xl font-bold text-gray-800">Загрузка...</h2>
                        <p class="text-gray-500">Энтузиаст захвата территорий</p>
                    </div>
                </div>
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <p class="text-sm text-blue-700">Общая площадь</p>
                    <p id="profile-area" class="text-3xl font-bold text-blue-800">0 м²</p>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 my-6 px-2">Мои посты</h2>
            <div id="profile-feed-container" class="space-y-4"></div>
        </div>
    </div>

    <!-- Нижний навбар -->
    <nav id="bottom-navbar" class="hidden fixed bottom-0 left-0 right-0 h-20 bg-white/80 backdrop-blur-md shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.1)] flex justify-around items-center z-30">
        <button class="nav-btn active text-gray-500 flex flex-col items-center space-y-1 transition-transform transform hover:scale-110" onclick="showView('map-view')"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span>Карта</span></button>
        <button class="nav-btn text-gray-500 flex flex-col items-center space-y-1 transition-transform transform hover:scale-110" onclick="showView('feed-view')"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3h2m0 0h2" /></svg><span>Лента</span></button>
        <button class="nav-btn text-gray-500 flex flex-col items-center space-y-1 transition-transform transform hover:scale-110" onclick="showView('top-view')"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg><span>Топ</span></button>
        <button class="nav-btn text-gray-500 flex flex-col items-center space-y-1 transition-transform transform hover:scale-110" onclick="showView('profile-view')"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><span>Профиль</span></button>
    </nav>
    
    <!-- Модальное окно -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50"><div class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full fade-in"><p id="modal-message" class="text-lg text-gray-700 mb-6"></p><button onclick="closeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-full transition-all">OK</button></div></div>

    <!-- Модальное окно создания поста -->
    <div id="create-post-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md fade-in space-y-4">
            <h2 class="text-2xl font-bold text-gray-800">Новое достижение!</h2>
            <p class="text-gray-600">Дайте название вашей новой территории и поделитесь с другими.</p>
            <div>
                <label for="post-title" class="block text-sm font-medium text-gray-700">Название</label>
                <input type="text" id="post-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Например, 'Утренний захват парка'">
            </div>
            <div>
                 <label for="post-photo-input" class="block text-sm font-medium text-gray-700">Фото</label>
                 <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                    <div class="space-y-1 text-center">
                        <img id="post-photo-preview" src="" alt="Предпросмотр фото" class="hidden mx-auto h-24 w-auto mb-4 rounded">
                        <svg id="post-photo-icon" class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                        <div class="flex text-sm text-gray-600">
                            <label for="post-photo-input" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                <span>Загрузите файл</span>
                                <input id="post-photo-input" name="post-photo-input" type="file" class="sr-only" accept="image/*">
                            </label>
                            <p class="pl-1">или перетащите</p>
                        </div>
                        <p class="text-xs text-gray-500">PNG, JPG, GIF до 10MB</p>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-post-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-all">Пропустить</button>
                <button id="save-post-btn" class="btn-gradient text-white font-bold py-2 px-4 rounded-full transition-all flex items-center justify-center">
                    <span id="save-post-text">Опубликовать</span>
                    <svg id="save-post-loader" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно с комментариями -->
    <div id="comments-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-end z-40 opacity-0 hidden transition-opacity duration-300">
        <div id="comments-content" class="w-full h-3/4 bg-white rounded-t-2xl shadow-2xl flex flex-col transform translate-y-full transition-transform duration-300 ease-in-out">
            <div class="w-full flex justify-center p-4 flex-shrink-0" ontouchstart="handleTouchStart(event, 'comments')" ontouchmove="handleTouchMove(event, 'comments')" ontouchend="handleTouchEnd('comments')">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>
            <h2 class="text-xl font-bold text-gray-800 px-4 pb-2 flex-shrink-0">Комментарии</h2>
            <div id="comments-list" class="flex-grow overflow-y-auto p-4 space-y-4">
                <!-- Комментарии будут здесь -->
            </div>
            <div id="comment-form" class="p-4 border-t border-gray-200 flex-shrink-0 bg-white">
                <div class="flex items-center space-x-2">
                    <input type="text" id="comment-input" placeholder="Ваш комментарий..." class="flex-grow block w-full rounded-full border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <button id="send-comment-btn" class="btn-gradient p-3 rounded-full text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                    </button>
                </div>
                <div id="reply-info" class="text-xs text-gray-500 mt-1 hidden">Ответ пользователю <span id="reply-to-name" class="font-bold"></span> <button id="cancel-reply-btn" class="text-red-500 ml-2">[Отменить]</button></div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Глобальные переменные ---
        const tg = window.Telegram.WebApp;
        let map;
        let detailMap = null;
        let supabase;
        let telegramUser = null;
        let isRunning = false;
        let watchId = null;
        let currentRunPath = [];
        let currentPathPolyline = null;
        let userTerritory = null;
        let userColor = '#3b82f6';
        let currentUserMarker = null;
        let allUserLayers = {};
        let allProfilesData = [];
        let loginAnimationInterval = null;
        let lastCaptureData = null;
        let currentPostIdForComment = null;
        let currentReplyToCommentId = null;

        // --- Элементы DOM ---
        const authScreen = document.getElementById('auth-screen');
        const authContent = document.getElementById('auth-content');
        const appContainer = document.getElementById('app-container');
        const bottomNavbar = document.getElementById('bottom-navbar');
        const toggleRunBtn = document.getElementById('toggle-run-btn');
        const areaDisplay = document.getElementById('area-display');
        const usernameDisplay = document.getElementById('username-display');
        const profileAreaDisplay = document.getElementById('profile-area');
        const profileName = document.getElementById('profile-name');
        const profileAvatarImg = document.getElementById('profile-avatar-img');
        const profileAvatarWrapper = document.getElementById('profile-avatar-wrapper');
        const leaderboardDiv = document.getElementById('leaderboard');
        const modal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const recenterBtn = document.getElementById('recenter-btn');
        const userDetailModal = document.getElementById('user-detail-modal');
        const userDetailContent = document.getElementById('user-detail-content');
        const createPostModal = document.getElementById('create-post-modal');
        const savePostBtn = document.getElementById('save-post-btn');
        const cancelPostBtn = document.getElementById('cancel-post-btn');
        const postTitleInput = document.getElementById('post-title');
        const postPhotoInput = document.getElementById('post-photo-input');
        const postPhotoPreview = document.getElementById('post-photo-preview');
        const postPhotoIcon = document.getElementById('post-photo-icon');
        const savePostText = document.getElementById('save-post-text');
        const savePostLoader = document.getElementById('save-post-loader');
        const feedContainer = document.getElementById('feed-container');
        const profileFeedContainer = document.getElementById('profile-feed-container');
        const commentsModal = document.getElementById('comments-modal');
        const commentsContent = document.getElementById('comments-content');
        const commentsList = document.getElementById('comments-list');
        const commentInput = document.getElementById('comment-input');
        const sendCommentBtn = document.getElementById('send-comment-btn');
        const replyInfo = document.getElementById('reply-info');
        const replyToName = document.getElementById('reply-to-name');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');

        // --- Функции UI ---
        function showView(viewId) {
            tg.HapticFeedback.impactOccurred('light');
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="showView('${viewId}')"]`).classList.add('active');
        }

        function showMessage(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }
        function closeModal() {
            modal.classList.add('hidden');
        }

        function generateColorFromId(id) {
            const strId = String(id);
            let hash = 0;
            for (let i = 0; i < strId.length; i++) {
                hash = strId.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = hash % 360;
            return `hsl(${h}, 80%, 65%)`;
        }
        
        function focusOnUser(userId) {
            showView('map-view');
            const userLayerGroup = allUserLayers[userId];
            if (userLayerGroup && map && userLayerGroup.getLayers().length > 0) {
                setTimeout(() => {
                    map.flyToBounds(userLayerGroup.getBounds(), { padding: [50, 50], duration: 1, maxZoom: 16 });
                }, 100);
            } else {
                showMessage("У этого пользователя еще нет захваченных территорий.");
            }
        }
        
        // --- Логика модальных окон ---
        let touchStartY = 0;
        let currentY = 0;
        let isDragging = false;

        function handleTouchStart(e, modalType) {
            isDragging = true;
            touchStartY = e.touches[0].clientY;
            const content = modalType === 'comments' ? commentsContent : userDetailContent;
            content.style.transition = 'none';
        }

        function handleTouchMove(e, modalType) {
            if (!isDragging) return;
            currentY = e.touches[0].clientY;
            const deltaY = currentY - touchStartY;
            const content = modalType === 'comments' ? commentsContent : userDetailContent;
            if (deltaY > 0) {
                content.style.transform = `translateY(${deltaY}px)`;
            }
        }

        function handleTouchEnd(modalType) {
            if (!isDragging) return;
            isDragging = false;
            const content = modalType === 'comments' ? commentsContent : userDetailContent;
            content.style.transition = 'transform 0.3s ease-in-out';
            const deltaY = currentY - touchStartY;

            if (deltaY > content.clientHeight * 0.3) {
                if (modalType === 'comments') hideCommentsModal();
                else hideUserDetailModal();
            } else {
                content.style.transform = '';
            }
        }

        async function showUserDetailModal(userId) {
            // ... (без изменений) ...
        }

        function hideUserDetailModal() {
            // ... (без изменений) ...
        }

        function showCreatePostModal(newCapture) {
            lastCaptureData = newCapture;
            postTitleInput.value = '';
            postPhotoInput.value = '';
            postPhotoPreview.classList.add('hidden');
            postPhotoIcon.classList.remove('hidden');
            createPostModal.classList.remove('hidden');
        }

        function hideCreatePostModal() {
            createPostModal.classList.add('hidden');
            lastCaptureData = null;
        }

        async function showCommentsModal(postId) {
            currentPostIdForComment = postId;
            tg.HapticFeedback.impactOccurred('medium');
            
            commentsList.innerHTML = '<p class="text-center text-gray-500">Загрузка комментариев...</p>';
            commentsModal.classList.remove('hidden');
            setTimeout(() => {
                commentsModal.classList.remove('opacity-0');
                commentsContent.classList.remove('translate-y-full');
            }, 10);
            
            await renderComments(postId);
        }

        function hideCommentsModal() {
            commentsModal.classList.add('opacity-0');
            commentsContent.classList.add('translate-y-full');
            setTimeout(() => {
                commentsModal.classList.add('hidden');
                currentPostIdForComment = null;
                cancelReply();
            }, 300);
        }
        
        // --- Логика анимации входа ---
        function startLoginAnimation() {
            // ... (без изменений) ...
        }
        
        // --- Основная логика ---
        async function startApp() {
            // ... (без изменений) ...
        }

        async function initializeWithUser() {
             // ... (без изменений) ...
        }
        
        async function setupUser() {
            try {
                await upsertUserProfile();
                initMap();
                updateUI();
                listenToAllProfiles();
                listenToPosts();
                
                authScreen.style.display = 'none';
                appContainer.classList.remove('hidden');
                bottomNavbar.classList.remove('hidden');
            } catch (error) {
                console.error("Error during user setup:", error);
                authContent.innerHTML = `
                    <h1 class="text-2xl font-bold text-red-600 mb-4">Ошибка</h1>
                    <p class="text-gray-600">Произошла ошибка при настройке вашего профиля. Пожалуйста, попробуйте перезапустить приложение.</p>
                    <p class="text-xs text-gray-400 mt-4">${error.message}</p>
                `;
            }
        }

        function updateUI() {
            // ... (без изменений) ...
        }

        function initMap() {
            // ... (без изменений) ...
        }

        function updateCurrentUserMarker(latLng) {
            // ... (без изменений) ...
        }
        
        // --- Логика бега и территории ---
        function startRun() {
            // ... (без изменений) ...
        }

        function stopRun() {
            // ... (без изменений) ...
        }

        function processRunPath() {
            // ... (без изменений) ...
        }
        
        async function updateTerritory(newCapture) {
            // ... (без изменений, кроме вызова showCreatePostModal) ...
        }
        
        // --- Supabase ---
        async function upsertUserProfile() {
            // ... (без изменений) ...
        }

        async function saveUserData() {
            // ... (без изменений) ...
        }

        async function handlePostSubmission() {
            // ... (без изменений) ...
        }

        function listenToAllProfiles() {
            // ... (без изменений) ...
        }

        async function fetchAllProfilesAndDraw() {
            // ... (без изменений) ...
        }
        
        function updateLeaderboard(profiles) {
            // ... (без изменений) ...
        }

        function refreshAllStats() {
            // ... (без изменений) ...
        }

        // --- Лента, Лайки, Комментарии ---
        function listenToPosts() {
            supabase.channel('public:posts')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, () => renderFeed())
              .subscribe();
            supabase.channel('public:likes')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'likes' }, () => renderFeed())
              .subscribe();
            supabase.channel('public:comments')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, payload => {
                if (currentPostIdForComment) renderComments(currentPostIdForComment);
              })
              .subscribe();
            renderFeed();
        }

        async function renderFeed() {
            const { data: posts, error } = await supabase.from('posts').select('*, likes(user_id), comments(id)').order('created_at', { ascending: false });
            if (error) { console.error("Error fetching posts:", error); return; }

            const feedHTML = posts.map(post => generatePostHTML(post)).join('');
            feedContainer.innerHTML = feedHTML || '<p class="text-center text-gray-500">В ленте пока нет постов.</p>';
            
            const userPostsHTML = posts.filter(p => p.user_id === telegramUser.id).map(post => generatePostHTML(post)).join('');
            profileFeedContainer.innerHTML = userPostsHTML || '<p class="text-center text-gray-500">У вас еще нет постов.</p>';

            posts.forEach(post => {
                const miniMap = L.map(`mini-map-${post.id}`, { zoomControl: false, attributionControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false });
                const mapboxAccessToken = 'pk.eyJ1IjoieXVuZ3JlemFjIiwiYSI6ImNtOW10ZzJ6bDBjNHUyanI3ejc5eXo1d2MifQ._tryk9cXjfReUGLGnNkm6Q';
                L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v12/tiles/256/{z}/{x}/{y}?access_token={accessToken}', { maxZoom: 19, accessToken: mapboxAccessToken }).addTo(miniMap);
                const territoryLayer = L.geoJSON(post.territory_captured, { style: { color: post.user_color, weight: 2, opacity: 0.8, fillColor: post.user_color, fillOpacity: 0.5 } }).addTo(miniMap);
                miniMap.fitBounds(territoryLayer.getBounds(), { padding: [10, 10] });
            });
        }

        function generatePostHTML(post) {
            const avatar = post.user_avatar_url || `https://placehold.co/40x40/E5E7EB/4B5563?text=${post.user_name.charAt(0)}`;
            const area = post.area_captured || 0;
            const formattedArea = area > 10000 ? `${(area / 1000000).toFixed(2)} км²` : `${Math.round(area)} м²`;
            const userHasLiked = post.likes.some(like => like.user_id === telegramUser.id);
            const likeButtonClass = userHasLiked ? 'text-red-500' : 'text-gray-500';

            return `
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <div class="p-4">
                        <div class="flex items-center space-x-3">
                            <img src="${avatar}" class="w-10 h-10 rounded-full" alt="avatar">
                            <div>
                                <p class="font-bold text-gray-800">${post.user_name}</p>
                                <p class="text-xs text-gray-500">${new Date(post.created_at).toLocaleString('ru-RU')}</p>
                            </div>
                        </div>
                        <p class="mt-4 text-gray-700">${post.title}</p>
                    </div>
                    ${post.photo_url ? `<img src="${post.photo_url}" class="w-full h-64 object-cover" alt="Post photo">` : ''}
                    <div id="mini-map-${post.id}" class="h-48 w-full mini-map"></div>
                    <div class="p-4 bg-gray-50 flex items-center justify-between">
                        <p class="font-semibold text-gray-700">Захвачено: <span class="font-bold text-blue-600">${formattedArea}</span></p>
                        <div class="flex items-center space-x-4">
                            <button onclick="toggleLike(${post.id})" class="flex items-center space-x-1 ${likeButtonClass} hover:text-red-500 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="${userHasLiked ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z" /></svg>
                                <span>${post.likes.length}</span>
                            </button>
                            <button onclick="showCommentsModal(${post.id})" class="flex items-center space-x-1 text-gray-500 hover:text-blue-500 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                                <span>${post.comments.length}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function toggleLike(postId) {
            tg.HapticFeedback.impactOccurred('light');
            const { data, error } = await supabase.from('likes').select('*').eq('post_id', postId).eq('user_id', telegramUser.id);
            if (error) { console.error("Error checking like:", error); return; }

            if (data.length > 0) {
                // Unlike
                await supabase.from('likes').delete().eq('post_id', postId).eq('user_id', telegramUser.id);
            } else {
                // Like
                await supabase.from('likes').insert({ post_id: postId, user_id: telegramUser.id });
            }
        }

        async function renderComments(postId) {
            const { data, error } = await supabase.from('comments').select('*').eq('post_id', postId).order('created_at', { ascending: true });
            if (error) { console.error("Error fetching comments:", error); return; }

            const commentsByParent = data.reduce((acc, comment) => {
                (acc[comment.parent_id || 'root'] = acc[comment.parent_id || 'root'] || []).push(comment);
                return acc;
            }, {});

            const buildHtml = (comments) => {
                return comments.map(comment => {
                    const avatar = comment.user_avatar_url || `https://placehold.co/32x32/E5E7EB/4B5563?text=${comment.user_name.charAt(0)}`;
                    const replies = commentsByParent[comment.id] || [];
                    return `
                        <div class="flex space-x-3">
                            <img src="${avatar}" class="w-8 h-8 rounded-full flex-shrink-0" alt="avatar">
                            <div class="flex-grow">
                                <div class="bg-gray-100 rounded-lg p-2">
                                    <p class="font-bold text-sm text-gray-800">${comment.user_name}</p>
                                    <p class="text-sm text-gray-600">${comment.text}</p>
                                </div>
                                <button onclick="setReplyTo(${comment.id}, '${comment.user_name}')" class="text-xs text-blue-500 mt-1">Ответить</button>
                                ${replies.length > 0 ? `<div class="mt-2 space-y-2 pl-4 border-l-2 border-gray-200">${buildHtml(replies)}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            };
            
            commentsList.innerHTML = buildHtml(commentsByParent['root'] || []) || '<p class="text-center text-gray-500">Комментариев пока нет.</p>';
        }

        function setReplyTo(commentId, name) {
            currentReplyToCommentId = commentId;
            replyToName.textContent = name;
            replyInfo.classList.remove('hidden');
            commentInput.focus();
        }

        function cancelReply() {
            currentReplyToCommentId = null;
            replyInfo.classList.add('hidden');
        }

        async function addComment() {
            const text = commentInput.value.trim();
            if (!text) return;

            const { error } = await supabase.from('comments').insert({
                post_id: currentPostIdForComment,
                user_id: telegramUser.id,
                parent_id: currentReplyToCommentId,
                text: text,
                user_name: telegramUser.first_name,
                user_avatar_url: telegramUser.photo_url
            });

            if (error) {
                console.error("Error adding comment:", error);
                showMessage("Не удалось добавить комментарий.");
            } else {
                commentInput.value = '';
                cancelReply();
            }
        }

        // --- Обработчики событий ---
        function setupEventListeners() {
            toggleRunBtn.addEventListener('click', () => { if (!isRunning) startRun(); else stopRun(); });
            recenterBtn.addEventListener('click', () => {
                 if (currentUserMarker) map.flyTo(currentUserMarker.getLatLng(), 16);
            });
            userDetailModal.addEventListener('click', (e) => {
                if (e.target.id === 'user-detail-modal') hideUserDetailModal();
            });
            commentsModal.addEventListener('click', (e) => {
                if (e.target.id === 'comments-modal') hideCommentsModal();
            });
            savePostBtn.addEventListener('click', handlePostSubmission);
            cancelPostBtn.addEventListener('click', hideCreatePostModal);
            postPhotoInput.addEventListener('change', () => {
                const file = postPhotoInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        postPhotoPreview.src = e.target.result;
                        postPhotoPreview.classList.remove('hidden');
                        postPhotoIcon.classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
            sendCommentBtn.addEventListener('click', addComment);
            cancelReplyBtn.addEventListener('click', cancelReply);
        }
        
        // --- Глобальные функции для HTML ---
        window.showView = showView;
        window.closeModal = closeModal;
        window.showUserDetailModal = showUserDetailModal;
        window.hideUserDetailModal = hideUserDetailModal;
        window.onTelegramAuth = async (user) => {
            telegramUser = user;
            await initializeWithUser();
        };
        window.handleTouchStart = handleTouchStart;
        window.handleTouchMove = handleTouchMove;
        window.handleTouchEnd = handleTouchEnd;
        window.toggleLike = toggleLike;
        window.showCommentsModal = showCommentsModal;
        window.setReplyTo = setReplyTo;

        // Запускаем приложение
        document.addEventListener('DOMContentLoaded', () => {
            startApp();
            setupEventListeners();
        });
    </script>

</body>
</html>
