<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, shrink-to-fit=no, viewport-fit=cover">
    <title>Trollbay Маркетплейс</title>

    <!-- SDK и библиотеки -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #111827);
            --tg-hint: var(--tg-theme-hint-color, #6b7280);
            --tg-link: var(--tg-theme-link-color, #3b82f6);
            --tg-button: var(--tg-theme-button-color, #3b82f6);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f3f4f6);
            --tg-danger: #ef4444;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        html, body {
            overscroll-behavior: none;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            flex-direction: column;
        }
        #app-root {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .view {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            flex-grow: 1; 
        }
        .view.active {
            display: flex; 
            flex-direction: column;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .product-card {
            background-color: var(--tg-secondary-bg);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07);
        }

        .favorite-btn {
            position: absolute; top: 12px; right: 12px;
            background-color: rgba(255,255,255,0.7);
            border-radius: 50%; width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
        }
        .favorite-btn:hover { transform: scale(1.1); }
        .favorite-btn.pop { animation: pop 0.3s ease; }
        @keyframes pop { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }

        .skeleton-card { background-color: var(--tg-secondary-bg); border-radius: var(--radius-lg); overflow: hidden; }
        .skeleton-img { height: 128px; background-color: var(--tg-hint); opacity: 0.2; }
        .skeleton-text { height: 20px; margin: 12px; background-color: var(--tg-hint); opacity: 0.2; border-radius: 6px; }
        .skeleton-text-short { width: 60%; }
        .shimmer { position: relative; overflow: hidden; }
        .shimmer::after {
            content: ''; position: absolute; top: 0; left: -150%; width: 150%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 100% { left: 150%; } }

        #bottom-navbar {
            position: relative;
            flex-shrink: 0;
            height: calc(70px + env(safe-area-inset-bottom, 0px));
            background-color: var(--tg-bg);
            border-top: 1px solid var(--tg-secondary-bg);
            display: flex; justify-content: space-around; align-items: flex-start;
            padding: 10px 10px env(safe-area-inset-bottom, 0px) 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03); z-index: 100;
            transition: transform 0.3s ease-in-out;
        }
        #bottom-navbar.hidden {
            display: none;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; cursor: pointer; color: var(--tg-hint);
            transition: all 0.2s ease; flex-grow: 1; height: 100%;
            border-radius: var(--radius-md);
        }
        .nav-item.active { color: var(--tg-button); font-weight: 600; }
        .nav-item:active { transform: scale(0.95); }
        .nav-item svg { width: 26px; height: 26px; }
        .nav-item span:last-child { font-size: 11px; margin-top: 4px; }

        #create-ad-fab {
            position: fixed; bottom: calc(70px + env(safe-area-inset-bottom, 0px) + 20px); right: 20px;
            width: 60px; height: 60px;
            background: var(--tg-button); color: var(--tg-button-text);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4); z-index: 50; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #create-ad-fab:hover { transform: scale(1.05) rotate(10deg); }
        #create-ad-fab.hidden { opacity: 0; pointer-events: none; transform: scale(0.8) translateY(20px); }

        .form-label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 14px; }
        .form-input {
            width: 100%; padding: 12px 14px; border-radius: var(--radius-md); border: 1px solid var(--tg-secondary-bg);
            background-color: var(--tg-secondary-bg); color: var(--tg-text); transition: all 0.2s;
            box-sizing: border-box; font-size: 16px;
        }
        .form-input:focus { border-color: var(--tg-button); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); background-color: var(--tg-bg); }
        .form-input.invalid { border-color: var(--tg-danger); }
        
        .action-button {
            background-color: var(--tg-button); color: var(--tg-button-text);
            padding: 14px 20px; border-radius: var(--radius-md); font-weight: 600;
            cursor: pointer; transition: all 0.2s; text-align: center; border: none;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2), 0 2px 4px -2px rgba(59, 130, 246, 0.2);
        }
        .action-button:hover:not(:disabled) { opacity: 0.9; box-shadow: 0 8px 15px -3px rgba(59, 130, 246, 0.25), 0 4px 6px -4px rgba(59, 130, 246, 0.25); transform: translateY(-2px); }
        .action-button:disabled { background-color: var(--tg-hint); opacity: 0.7; cursor: not-allowed; }
        .danger-button { background-color: var(--tg-danger); box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2), 0 2px 4px -2px rgba(239, 68, 68, 0.2); }
        .danger-button:hover { box-shadow: 0 8px 15px -3px rgba(239, 68, 68, 0.25), 0 4px 6px -4px rgba(239, 68, 68, 0.25); }
        .secondary-button { background-color: var(--tg-secondary-bg); color: var(--tg-text); box-shadow: none; }

        #modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.4);
            display: flex; align-items: flex-end; justify-content: center;
            z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }
        #modal-overlay.visible { opacity: 1; pointer-events: auto; }
        #modal-content {
            background-color: var(--tg-bg); padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            width: 100%; max-width: 100%;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #modal-overlay.visible #modal-content { transform: translateY(0); }

        #toast-container {
            position: fixed; top: 15px; left: 15px; right: 15px;
            z-index: 300; display: flex; flex-direction: column; align-items: center;
            gap: 10px; pointer-events: none;
        }
        .toast {
            background-color: rgba(17, 17, 17, 0.9); color: white; padding: 12px 20px;
            border-radius: var(--radius-md); font-size: 15px; backdrop-filter: blur(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: toast-in 0.5s cubic-bezier(0.25, 1, 0.5, 1), toast-out 0.5s cubic-bezier(0.5, 0, 0.75, 0) 3.5s forwards;
            opacity: 0;
        }
        @keyframes toast-in { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
        
        #categories-bar::-webkit-scrollbar { display: none; }
        .category-chip {
            transition: all 0.2s ease-in-out; border: 1px solid transparent;
        }
        .category-chip.active {
            color: var(--tg-button-text) !important; background-color: var(--tg-button) !important; font-weight: 600;
        }
        .category-chip:not(.active) { background-color: var(--tg-secondary-bg); color: var(--tg-text); }
        .category-chip:hover:not(.active) {
            transform: translateY(-2px); background-color: var(--tg-bg); border-color: var(--tg-button);
        }

        .create-step { display: none; animation: step-in 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .create-step.active { display: block; }
        @keyframes step-in { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        #city-search-results {
            max-height: 200px; overflow-y: auto; border: 1px solid var(--tg-secondary-bg);
            border-radius: var(--radius-md); margin-top: 8px;
        }
        .city-result-item { padding: 12px 14px; cursor: pointer; transition: background-color 0.2s; }
        .city-result-item:hover { background-color: var(--tg-secondary-bg); }
        .city-result-item.selected, .city-result-item.selected:hover { background-color: var(--tg-button); color: var(--tg-button-text); }
        .city-result-item.selected p, .city-result-item.selected span { color: var(--tg-button-text) !important; }

        .spinner {
            width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%; border-top-color: var(--tg-text);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #photo-thumbnails {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px;
        }
        .thumbnail-container {
            position: relative; width: 100%; padding-top: 100%;
            border-radius: var(--radius-md); overflow: hidden;
        }
        .thumbnail-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
        }
        .thumbnail-delete {
            position: absolute; top: 4px; right: 4px; width: 24px; height: 24px;
            background-color: rgba(0,0,0,0.5); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 14px; border: none;
        }
        #photo-picker {
            height: 80px; width: 80px; border: 2px dashed var(--tg-hint);
            border-radius: var(--radius-md); cursor: pointer; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            color: var(--tg-hint);
        }

        /* === CHAT & PURCHASE STYLES === */
        .chat-list-item {
            display: flex; align-items: center; padding: 12px 15px; cursor: pointer;
            border-bottom: 1px solid var(--tg-secondary-bg); transition: background-color 0.2s;
        }
        .chat-list-item:hover { background-color: var(--tg-secondary-bg); }
        .chat-avatar {
            width: 56px; height: 56px; border-radius: 50%; margin-right: 12px;
            object-fit: cover; background-color: var(--tg-secondary-bg);
            flex-shrink: 0;
        }
        .chat-info { flex-grow: 1; overflow: hidden; }
        .chat-name { font-weight: 600; }
        .chat-last-message {
            color: var(--tg-hint); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .chat-meta {
            text-align: right; font-size: 12px; color: var(--tg-hint);
            display: flex; flex-direction: column; align-items: flex-end;
            flex-shrink: 0;
        }
        .chat-time { margin-bottom: 4px; }
        .chat-unread-badge {
            background-color: var(--tg-button); color: var(--tg-button-text);
            border-radius: 50%; font-weight: 600; font-size: 12px;
            min-width: 22px; height: 22px; display: inline-flex;
            align-items: center; justify-content: center; padding: 0 4px;
        }

        /* REFACTORED Chat View */
        #chat-view { height: 100%; }
        .chat-header {
            flex-shrink: 0; display: flex; align-items: center; padding: 10px 15px;
            border-bottom: 1px solid var(--tg-secondary-bg); background-color: var(--tg-bg);
            justify-content: space-between;
        }
        #chat-messages-container {
            flex-grow: 1; overflow-y: auto; padding: 15px;
        }
        .messages-wrapper { display: flex; flex-direction: column; gap: 12px; }
        .message-bubble {
            padding: 10px 15px; border-radius: var(--radius-lg);
            max-width: 75%; word-wrap: break-word;
        }
        .message-row { display: flex; }
        .message-row.sent { justify-content: flex-end; }
        .message-row.sent .message-bubble {
            background-color: var(--tg-button); color: var(--tg-button-text); border-bottom-right-radius: 4px;
        }
        .message-row.received { justify-content: flex-start; }
        .message-row.received .message-bubble {
            background-color: var(--tg-secondary-bg); color: var(--tg-text); border-bottom-left-radius: 4px;
        }
        .chat-input-area {
            flex-shrink: 0; display: flex; align-items: center; padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            border-top: 1px solid var(--tg-secondary-bg); background-color: var(--tg-bg);
        }
        #chat-message-input {
            flex-grow: 1; border: none; background-color: var(--tg-secondary-bg);
            padding: 12px 15px; border-radius: var(--radius-md); margin-right: 10px;
            font-size: 16px;
        }
        #chat-message-input:focus { outline: none; }
        #chat-send-btn {
            background-color: var(--tg-button); color: var(--tg-button-text); border: none;
            width: 44px; height: 44px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s;
            flex-shrink: 0;
        }
        #chat-send-btn:disabled { background-color: var(--tg-hint); cursor: not-allowed; }
        #chat-send-btn:active:not(:disabled) { transform: scale(0.9); }

        /* REFACTORED Details View */
        #details-view { height: 100%; }
        .details-content-wrapper { flex-grow: 1; overflow-y: auto; }
        .details-actions-footer {
            flex-shrink: 0; padding: 15px; background-color: var(--tg-bg);
            border-top: 1px solid var(--tg-secondary-bg);
            padding-bottom: calc(15px + env(safe-area-inset-bottom, 0px));
        }
        
        /* === NEW SLIDER & LIGHTBOX STYLES === */
        #details-image-container {
            position: relative;
        }
        #details-image-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch; /* For smooth scrolling on iOS */
            scrollbar-width: none; /* For Firefox */
        }
        #details-image-slider::-webkit-scrollbar {
            display: none; /* For Chrome, Safari, and Opera */
        }
        .details-image-slide {
            flex-shrink: 0;
            width: 100%;
            height: 100%;
            scroll-snap-align: center;
        }
        #image-indicator {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            backdrop-filter: blur(4px);
            transition: opacity 0.2s;
        }

        #lightbox-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 999; backdrop-filter: blur(8px);
            opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        #lightbox-overlay.visible {
            opacity: 1; pointer-events: auto;
        }
        #lightbox-close {
            position: absolute; top: 20px; right: 20px;
            width: 44px; height: 44px;
            background: rgba(0,0,0,0.3); color: white;
            border: none; border-radius: 50%;
            font-size: 24px; line-height: 1;
            cursor: pointer;
        }
        #lightbox-slider {
            width: 100%; height: 100%;
            display: flex; align-items: center;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .lightbox-slide {
            width: 100%; height: 100%;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            scroll-snap-align: center;
        }
        .lightbox-slide img {
            max-width: 100vw; max-height: 100vh;
            object-fit: contain;
        }
        .archived-overlay {
            position: absolute; inset: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex; align-items: center; justify-content: center;
            color: var(--tg-text); font-weight: 600;
            text-align: center; padding: 10px;
            z-index: 10; /* Ensure it's above the image */
        }

        /* === NEW SETTINGS TOGGLE SWITCH === */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--tg-secondary-bg);
            transition: .4s;
            border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--tg-button);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* === NEW PROFILE TABS & ORDER LIST === */
        .profile-tabs {
            display: flex;
            border-bottom: 1px solid var(--tg-secondary-bg);
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .profile-tab {
            flex-grow: 1;
            text-align: center;
            padding: 12px 8px;
            font-weight: 500;
            color: var(--tg-hint);
            cursor: pointer;
            position: relative;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .profile-tab.active {
            color: var(--tg-button);
            font-weight: 600;
            border-bottom-color: var(--tg-button);
        }

        .order-list-item {
            display: flex;
            padding: 12px;
            background-color: var(--tg-secondary-bg);
            border-radius: var(--radius-lg);
            gap: 12px;
            align-items: center;
        }
        .order-item-img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }
        .order-item-info {
            flex-grow: 1;
            overflow: hidden;
        }
        .order-item-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .order-item-price {
            font-weight: 500;
            color: var(--tg-text);
        }
        .order-status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }
        .status-processing { background-color: #f59e0b20; color: #d97706; } /* Amber */
        .status-shipped { background-color: #3b82f620; color: #2563eb; } /* Blue */
        .status-delivered { background-color: #16a34a20; color: #15803d; } /* Green */
        .status-cancelled { background-color: #ef444420; color: #b91c1c; } /* Red */

    </style>
</head>
<body>

    <div id="app-root">
        <!-- Views will be dynamically rendered here -->
    </div>

    <!-- Нижняя панель навигации -->
    <nav id="bottom-navbar"></nav>
    
    <!-- Плавающая кнопка создания (FAB) -->
    <button id="create-ad-fab">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>

    <!-- Модальное окно для фильтров и подтверждений -->
    <div id="modal-overlay">
        <div id="modal-content"></div>
    </div>

    <!-- Контейнер для Toast-уведомлений -->
    <div id="toast-container"></div>

    <!-- Лайтбокс для изображений -->
    <div id="lightbox-overlay">
        <button id="lightbox-close">&times;</button>
        <div id="lightbox-slider"></div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // Небольшая задержка, чтобы скрипт Telegram успел полностью загрузиться
            setTimeout(runApp, 100);
        });

        function runApp() {
            const tg = window.Telegram.WebApp;
            
            const STORAGE_KEY = 'trollbay_data';

            const getInitialData = () => {
                const now = new Date();
                const daysAgo = (days) => new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

                return {
                    users: {
                        'user-1': { id: 'user-1', firstName: 'Елена', tgUsername: 'elena_roller', photoUrl: 'https://placehold.co/96x96/7e22ce/ffffff?text=Е', balance: 5000 },
                        'user-2': { id: 'user-2', firstName: 'Максим', tgUsername: 'max_speed', photoUrl: 'https://placehold.co/96x96/be185d/ffffff?text=М', balance: 1200 },
                        'user-3': { id: 'user-3', firstName: 'Анна', tgUsername: 'ann_skates', photoUrl: 'https://placehold.co/96x96/059669/ffffff?text=А', balance: 8400 },
                    },
                    listings: [
                        { id: 'item-1', title: 'Агрессивные ролики USD Aeon 60', price: 18500, city: 'Москва', category: 'Ролики', description: 'Почти новые, размер 42. Катаны 5 раз в парке. Продаю, так как не подошел размер.', images: ['https://placehold.co/800x800/3b82f6/ffffff?text=Фото+1', 'https://placehold.co/800x800/3b82f6/ffffff?text=Фото+2'], ownerId: 'user-1', createdAt: daysAgo(0), status: 'active', condition: 'used' },
                        { id: 'item-2', title: 'Колеса Undercover 80мм/88А', price: 3200, city: 'Санкт-Петербург', category: 'Колеса', description: 'Комплект из 8 колес. Износ минимальный, не более 10%. Отлично держат на асфальте.', images: ['https://placehold.co/800x800/16a34a/ffffff?text=Колеса'], ownerId: 'user-2', createdAt: daysAgo(1), status: 'active', condition: 'used' },
                        { id: 'item-3', title: 'Рамы Kizer Fluid V', price: 4500, city: 'Екатеринбург', category: 'Рамы', description: 'Классические рамы для агрессива. Прочные, с большим H-блоком. Есть потертости, на скольжение не влияют.', images: ['https://placehold.co/800x800/f97316/ffffff?text=Рамы+Kizer'], ownerId: 'user-1', createdAt: daysAgo(2), status: 'archived', condition: 'used' },
                        { id: 'item-4', title: 'Защита коленей G-Form', price: 2800, city: 'Москва', category: 'Защита', description: 'Размер L. Очень удобная, не сползает. Идеальна для фрискейта.', images: ['https://placehold.co/800x800/9333ea/ffffff?text=Защита'], ownerId: 'user-3', createdAt: daysAgo(3), status: 'active', condition: 'new' },
                        { id: 'item-5', title: 'Подшипники Twincam ILQ-9 Pro', price: 2500, city: 'Новосибирск', category: 'Подшипники', description: '16 штук. Промыты и смазаны. Отличный накат.', images: ['https://placehold.co/800x800/d946ef/ffffff?text=Подшипники'], ownerId: 'user-2', createdAt: daysAgo(0), status: 'active', condition: 'new' },
                        { id: 'item-6', title: 'Ботинки Rollerblade Twister Edge', price: 12000, city: 'Москва', category: 'Ботинки', description: 'Только бут, без рамы и колес. Размер 43. Состояние отличное.', images: ['https://placehold.co/800x800/65a30d/ffffff?text=Ботинки+RB', 'https://placehold.co/800x800/65a30d/ffffff?text=Фото+2', 'https://placehold.co/800x800/65a30d/ffffff?text=Фото+3'], ownerId: 'user-3', createdAt: daysAgo(4), status: 'active', condition: 'used' },
                    ],
                    chats: [
                        {
                            chatId: 'chat-user-1-item-1', participantIds: ['local_user_id', 'user-1'], listingId: 'item-1',
                            messages: [
                                { senderId: 'local_user_id', text: 'Здравствуйте! Ролики еще в продаже?', timestamp: daysAgo(0) },
                                { senderId: 'user-1', text: 'Добрый день! Да, актуально.', timestamp: daysAgo(0) }
                            ],
                        },
                        {
                            chatId: 'chat-user-2-item-2', participantIds: ['local_user_id', 'user-2'], listingId: 'item-2',
                            messages: [
                                { senderId: 'local_user_id', text: 'Привет! Готов забрать колеса, если отправите доставкой.', timestamp: daysAgo(1) }
                            ],
                        }
                    ],
                    orders: [
                        {
                            orderId: 'order-1',
                            listingId: 'item-4', 
                            buyerId: 'local_user_id',
                            sellerId: 'user-3',
                            createdAt: daysAgo(1).toISOString(),
                            status: 'processing'
                        },
                        {
                            orderId: 'order-2',
                            listingId: 'item-5',
                            buyerId: 'local_user_id',
                            sellerId: 'user-2',
                            createdAt: daysAgo(3).toISOString(),
                            status: 'delivered'
                        }
                    ]
                };
            };

            const app = {
                state: {
                    currentUser: null,
                    userId: null,
                    history: [],
                    currentView: null,
                    viewParams: {},
                    filter: { query: '', category: 'all', city: '', sort: 'newest', minPrice: '', maxPrice: '', condition: 'all' },
                    allListings: [],
                    allChats: [],
                    allUsers: {},
                    allOrders: [],
                    categories: ['Ролики', 'Колеса', 'Рамы', 'Ботинки', 'Подшипники', 'Защита', 'Аксессуары'],
                    sortOptions: { newest: 'Сначала новые', price_asc: 'Цена: по возрастанию', price_desc: 'Цена: по убыванию' },
                    createAdState: {},
                    createAdCurrentStep: 1,
                    russianCities: [],
                    isLightboxOpen: false,
                },

                elements: {
                    root: document.getElementById('app-root'),
                    bottomNavbar: document.getElementById('bottom-navbar'),
                    createAdFab: document.getElementById('create-ad-fab'),
                    modalOverlay: document.getElementById('modal-overlay'),
                    modalContent: document.getElementById('modal-content'),
                    toastContainer: document.getElementById('toast-container'),
                    lightbox: {
                        overlay: document.getElementById('lightbox-overlay'),
                        slider: document.getElementById('lightbox-slider'),
                        closeBtn: document.getElementById('lightbox-close'),
                    }
                },
                
                init() {
                    this.telegram.init();
                    this.storage.load();
                    this.data.fetchCities();
                    this.initEventListeners();
                    this.views.renderNavbar();
                    
                    const startParam = tg.initDataUnsafe?.start_param;
                    if (startParam) {
                        const [type, id] = startParam.split(/:(.*)/s);
                        if (type === 'product' && this.data.getListingById(id)) {
                            this.navigateTo('details', { itemId: id });
                        } else if (type === 'profile' && this.data.getUserProfile(id)) {
                            this.navigateTo('profile', { userId: id });
                        } else {
                            this.navigateTo('feed');
                        }
                    } else {
                        this.navigateTo('feed');
                    }
                },

                navigateTo(viewName, params = {}) {
                    const lastHistoryState = this.state.history[this.state.history.length - 1];
                    if (lastHistoryState && lastHistoryState.view === viewName && JSON.stringify(lastHistoryState.params) === JSON.stringify(params)) {
                        // NEW: If navigating to profile, but with a different tab, allow re-render
                        if (viewName === 'profile' && lastHistoryState.params.initialTab !== params.initialTab) {
                           // continue
                        } else {
                           return;
                        }
                    }

                    const newState = { view: viewName, params: params };
                    const tabViews = ['feed', 'favorites', 'chatsList', 'profile'];
                    const isMainTabView = tabViews.includes(viewName) && !(viewName === 'profile' && params.userId && params.userId !== this.state.userId);

                    if (isMainTabView) {
                        this.state.history = [newState];
                    } else {
                        this.state.history.push(newState);
                    }
                    
                    this.state.currentView = viewName;
                    this.state.viewParams = params;
                    this._renderCurrentView();
                },

                navigateBack() {
                    if (this.state.history.length <= 1) {
                        tg.close();
                        return;
                    }
                    this.state.history.pop();
                    const previousState = this.state.history[this.state.history.length - 1];
                    
                    this.state.currentView = previousState.view;
                    this.state.viewParams = previousState.params;
                    
                    this._renderCurrentView();
                },

                _renderCurrentView() {
                    const viewName = this.state.currentView;
                    const rendererName = `render${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`;
                    const renderer = this.views[rendererName];
                    
                    if (typeof renderer === 'function') {
                        if (viewName === 'feed') this.views.renderSkeletonFeed();
                        
                        setTimeout(() => {
                            renderer.call(this.views, this.state.viewParams);
                            this._updateUIChrome();
                            this.elements.root.scrollTo(0, 0);
                        }, 10);
                    } else {
                        console.error(`No renderer found for view: ${viewName}`);
                        this.elements.root.innerHTML = `<div class="p-8 text-center text-[var(--tg-danger)]">Ошибка: Экран "${viewName}" не найден.</div>`;
                    }
                },

                _updateUIChrome() {
                    const { currentView, viewParams, history, isLightboxOpen } = this.state;
                    
                    if (history.length > 1 || isLightboxOpen) {
                        tg.BackButton.show();
                    } else {
                        tg.BackButton.hide();
                    }

                    if (currentView === 'create') {
                        const buttonText = this.state.createAdCurrentStep === 4 ? 'Опубликовать' : 'Далее';
                        tg.MainButton.setText(buttonText).show();
                    } else {
                        tg.MainButton.hide();
                    }

                    const isPublicProfile = currentView === 'profile' && viewParams.userId && viewParams.userId !== this.state.userId;
                    const tabViews = ['feed', 'favorites', 'chatsList', 'profile', 'settings'];
                    const isTabVisible = tabViews.includes(currentView) && !isPublicProfile;
                    this.elements.bottomNavbar.classList.toggle('hidden', !isTabVisible);

                    const isFabVisible = ['feed', 'favorites', 'chatsList'].includes(currentView) || (currentView === 'profile' && !isPublicProfile);
                    this.elements.createAdFab.classList.toggle('hidden', !isFabVisible);

                    document.querySelectorAll('#bottom-navbar .nav-item').forEach(item => {
                        const isSettingsActive = currentView === 'settings' && item.dataset.view === 'profile';
                        item.classList.toggle('active', !isPublicProfile && (item.dataset.view === currentView || isSettingsActive));
                    });
                },

                views: {
                    renderNavbar() {
                        app.elements.bottomNavbar.innerHTML = `
                            <div class="nav-item active" data-view="feed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span>Главная</span></div>
                            <div class="nav-item" data-view="favorites"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>Избранное</span></div>
                            <div class="nav-item" data-view="chatsList"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg><span>Сообщения</span></div>
                            <div class="nav-item" data-view="profile"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span>Профиль</span></div>
                        `;
                    },

                    renderFeed() {
                        const { query } = app.state.filter;
                        const categoriesHtml = `
                            <div id="categories-bar" class="flex space-x-2 overflow-x-auto pb-3 mb-4 -mx-[15px] px-[15px]">
                                <div class="category-chip shrink-0 cursor-pointer px-4 py-2 rounded-full text-sm font-medium ${app.state.filter.category === 'all' ? 'active' : ''}" data-category="all">Все</div>
                                ${app.state.categories.map(cat => `<div class="category-chip shrink-0 cursor-pointer px-4 py-2 rounded-full text-sm font-medium ${app.state.filter.category === cat ? 'active' : ''}" data-category="${cat}">${cat}</div>`).join('')}
                            </div>`;
                        
                        app.elements.root.innerHTML = `
                            <div id="feed-view" class="view active p-4">
                                <header class="flex justify-between items-center mb-4"><h1 class="text-3xl font-bold tracking-tighter">Trollbay</h1></header>
                                <div class="flex items-stretch space-x-3 mb-4">
                                    <div class="relative flex-grow">
                                        <input type="text" id="search-input" placeholder="Найти ролики, колеса..." class="form-input pl-10 w-full !py-3" value="${query}">
                                        <span class="absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span>
                                    </div>
                                    <button id="filter-btn" class="px-4 rounded-lg flex items-center justify-center" style="background-color: var(--tg-secondary-bg);"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg></button>
                                </div>
                                ${categoriesHtml}
                                <div id="listings-container"></div>
                            </div>`;
                        this._updateFeedContent();
                        this._attachFeedListeners();
                    },

                    _updateFeedContent() {
                        const container = document.getElementById('listings-container');
                        if (!container) return;

                        document.querySelectorAll('#categories-bar .category-chip').forEach(chip => {
                            chip.classList.toggle('active', chip.dataset.category === app.state.filter.category);
                        });

                        const { query, category, city, sort, minPrice, maxPrice, condition } = app.state.filter;
                        let filtered = [...app.state.allListings]
                            .filter(item => item.status === 'active')
                            .filter(item => {
                                const searchMatch = item.title.toLowerCase().includes(query.toLowerCase()) || (item.description && item.description.toLowerCase().includes(query.toLowerCase()));
                                const categoryMatch = category === 'all' || item.category === category;
                                const cityMatch = !city || item.city.toLowerCase().includes(city.toLowerCase());
                                const minPriceMatch = !minPrice || item.price >= parseInt(minPrice, 10);
                                const maxPriceMatch = !maxPrice || item.price <= parseInt(maxPrice, 10);
                                const conditionMatch = condition === 'all' || item.condition === condition;
                                return searchMatch && categoryMatch && cityMatch && minPriceMatch && maxPriceMatch && conditionMatch;
                            });

                        filtered.sort((a, b) => {
                            if (sort === 'price_asc') return a.price - b.price;
                            if (sort === 'price_desc') return b.price - a.price;
                            return new Date(b.createdAt) - new Date(a.createdAt);
                        });

                        const gridHtml = filtered.length > 0
                            ? `<div id="listings-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">${filtered.map(item => this._renderCard(item)).join('')}</div>`
                            : `<div class="text-center py-16 flex-grow flex flex-col items-center justify-center"><div class="text-6xl mb-4">🤷‍♀️</div><p class="mt-5 font-bold text-lg">Ничего не найдено</p><p class="text-sm mt-1 max-w-xs mx-auto" style="color: var(--tg-hint);">Попробуйте изменить поисковый запрос или сбросить фильтры.</p></div>`;

                        container.innerHTML = gridHtml;
                        this._attachGridListeners();
                    },
                    
                    renderDetails({ itemId }) {
                        const item = app.data.getListingById(itemId);
                        if (!item) {
                            app.ui.showToast("Объявление не найдено", true);
                            app.navigateBack();
                            return;
                        }

                        const seller = app.data.getUserProfile(item.ownerId);
                        const isFavorited = app.state.currentUser.favorites.includes(item.id);
                        const isMyAd = item.ownerId === app.state.userId;
                        const images = item.images?.length > 0 ? item.images : ['https://placehold.co/800x800/e2e8f0/475569?text=Image'];

                        const sellerHtml = seller ? `<div class="border-t pt-6 mt-6" style="border-color: var(--tg-secondary-bg);"><h3 class="font-bold text-lg mb-4">Продавец</h3><div class="flex items-center p-4 rounded-lg bg-[var(--tg-secondary-bg)] cursor-pointer" id="seller-profile-link" data-user-id="${seller.id}"><img src="${seller.photoUrl}" onerror="this.onerror=null;this.src='https://placehold.co/96x96/e2e8f0/475569?text=?'" class="w-12 h-12 rounded-full mr-4"><div><p class="font-semibold text-lg">${seller.firstName}</p>${seller.tgUsername ? `<p class="text-sm" style="color: var(--tg-link);">@${seller.tgUsername}</p>` : ''}</div></div></div>` : '';
                        const ownerActionsHtml = `<div class="flex items-stretch space-x-3"><button class="action-button secondary-button w-full" id="toggle-publish-btn" data-id="${item.id}">${item.status === 'active' ? 'Снять с публикации' : 'Опубликовать'}</button><button class="action-button w-full edit-btn" data-id="${item.id}">Редактировать</button></div>`;
                        const buyerActionsHtml = `<div class="flex items-stretch space-x-3"><button class="action-button secondary-button px-4 favorite-btn-details flex items-center justify-center" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${isFavorited ? 'var(--tg-danger)' : 'none'}" stroke="${isFavorited ? 'var(--tg-danger)' : 'currentColor'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></button><button class="action-button secondary-button w-full" id="contact-seller-btn" data-seller-id="${seller?.id}" data-listing-id="${item.id}">Написать</button><button class="action-button w-full" id="buy-btn" data-id="${item.id}" ${item.status !== 'active' ? 'disabled' : ''}>Купить</button></div>`;
                        const imageSliderHtml = images.map(src => `<div class="details-image-slide"><img src="${src}" onerror="this.onerror=null;this.src='https://placehold.co/800x800/e2e8f0/475569?text=Image'" alt="${item.title}" class="w-full h-full object-cover"></div>`).join('');

                        app.elements.root.innerHTML = `
                            <div id="details-view" class="view active">
                                <div class="flex-shrink-0 flex justify-end items-center p-2 sticky top-0 bg-[var(--tg-bg)] z-10">
                                     <button id="share-btn" class="p-2 rounded-full hover:bg-[var(--tg-secondary-bg)]" data-type="product" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg></button>
                                </div>
                                <div class="details-content-wrapper px-4 pb-4">
                                    <div id="details-image-container" class="w-full aspect-square rounded-lg bg-[var(--tg-secondary-bg)] overflow-hidden cursor-pointer">${imageSliderHtml}${images.length > 1 ? `<div id="image-indicator">1 / ${images.length}</div>` : ''}</div>
                                    <div class="mt-4">
                                        <h2 class="text-3xl font-bold tracking-tight mb-2">${item.title}</h2>
                                        <p class="text-4xl font-extrabold tracking-tighter mb-4">${item.price.toLocaleString('ru-RU')} ₽</p>
                                        <div class="grid grid-cols-2 gap-3 text-sm mb-6"><div class="flex items-center p-3 rounded-lg bg-[var(--tg-secondary-bg)]"><span class="mr-2">🏷️</span> ${item.category}</div><div class="flex items-center p-3 rounded-lg bg-[var(--tg-secondary-bg)]"><span class="mr-2">📍</span> ${item.city}</div></div>
                                        <p class="mb-8 whitespace-pre-wrap leading-relaxed">${item.description}</p>
                                        ${sellerHtml}
                                    </div>
                                </div>
                                <div class="details-actions-footer">${isMyAd ? ownerActionsHtml : buyerActionsHtml}</div>
                            </div>`;
                        this._attachDetailsListeners(item);
                    },

                    renderChat({ chatId }) {
                        const chat = app.state.allChats.find(c => c.chatId === chatId);
                        if (!chat) {
                            app.ui.showToast("Чат не найден", true);
                            app.navigateBack();
                            return;
                        }
                        
                        const otherUserId = chat.participantIds.find(id => id !== app.state.userId);
                        const otherUser = app.data.getUserProfile(otherUserId);
                        const listing = app.data.getListingById(chat.listingId);
                        const listingImage = listing?.images?.[0] || 'https://placehold.co/96x96/e2e8f0/475569?text=?';
                        
                        app.elements.root.innerHTML = `
                            <div id="chat-view" class="view active">
                                <div class="chat-header">
                                    <div class="flex items-center overflow-hidden"><img src="${otherUser?.photoUrl}" alt="${otherUser?.firstName}" class="w-10 h-10 rounded-full mr-3 flex-shrink-0"><div class="overflow-hidden"><p class="font-semibold truncate">${otherUser?.firstName || 'Пользователь'}</p><p class="text-sm text-[var(--tg-hint)] truncate">${listing?.title || 'Товар'}</p></div></div>
                                    <div id="chat-header-product" class="ml-4 cursor-pointer" data-item-id="${listing?.id}"><img src="${listingImage}" alt="${listing?.title}" class="w-10 h-10 rounded-md object-cover flex-shrink-0"></div>
                                </div>
                                <div id="chat-messages-container"><div class="messages-wrapper">${chat.messages.map(msg => this._renderMessageBubble(msg)).join('')}</div></div>
                                <div class="chat-input-area"><input type="text" id="chat-message-input" placeholder="Сообщение..." autocomplete="off"><button id="chat-send-btn" disabled><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button></div>
                            </div>`;
                        this._attachChatListeners();
                        const messagesContainer = document.getElementById('chat-messages-container');
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    },

                    renderFavorites() {
                        const favoriteItems = app.state.allListings.filter(i => app.state.currentUser.favorites.includes(i.id));
                        const gridHtml = favoriteItems.length > 0
                            ? `<div id="favorites-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">${favoriteItems.map(item => this._renderCard(item)).join('')}</div>`
                            : `<div class="text-center py-16 flex-grow flex flex-col items-center justify-center"><div class="text-6xl mb-4">💔</div><p class="mt-5 font-bold text-lg">В избранном пусто</p><p class="text-sm mt-1 max-w-xs mx-auto" style="color: var(--tg-hint);">Нажимайте на ❤️ в объявлениях, чтобы сохранить их здесь.</p></div>`;
                        
                        app.elements.root.innerHTML = `<div id="favorites-view" class="view active p-4"><h2 class="text-3xl font-bold tracking-tighter mb-6">Избранное</h2>${gridHtml}</div>`;
                        this._attachGridListeners();
                    },
                    
                    renderChatsList() {
                        const chats = app.data.getChatsForUser(app.state.userId);
                        const listHtml = chats?.length > 0 ?
                            `<div id="chats-list-container">${chats.map(chat => {
                                const otherUserId = chat.participantIds.find(id => id !== app.state.userId);
                                const otherUser = app.data.getUserProfile(otherUserId);
                                const lastMessage = chat.messages[chat.messages.length - 1];
                                const unreadCount = app.data.getUnreadCount(chat.chatId);
                                return `<div class="chat-list-item" data-chat-id="${chat.chatId}"><img src="${otherUser?.photoUrl}" alt="${otherUser?.firstName}" class="chat-avatar"><div class="chat-info"><div class="chat-name">${otherUser?.firstName || 'Пользователь'}</div><div class="chat-last-message">${lastMessage ? (lastMessage.senderId === app.state.userId ? 'Вы: ' : '') + lastMessage.text : 'Нет сообщений'}</div></div><div class="chat-meta"><div class="chat-time">${lastMessage ? app.utils.formatTimestamp(lastMessage.timestamp) : ''}</div>${unreadCount > 0 ? `<div class="chat-unread-badge">${unreadCount}</div>` : ''}</div></div>`;
                            }).join('')}</div>` :
                            `<div class="text-center py-16 flex-grow flex flex-col items-center justify-center"><div class="text-6xl mb-4">📭</div><p class="mt-5 font-bold text-lg">Нет диалогов</p><p class="text-sm mt-1 max-w-xs mx-auto" style="color: var(--tg-hint);">Когда вы напишете продавцу, ваш диалог появится здесь.</p></div>`;

                        app.elements.root.innerHTML = `<div id="chats-list-view" class="view active p-4"><h2 class="text-3xl font-bold tracking-tighter mb-6">Сообщения</h2>${listHtml}</div>`;
                        this._attachChatsListListeners();
                    },
                    
                    renderProfile({ userId, initialTab = 'listings' } = {}) {
                        const profileUserId = userId || app.state.userId;
                        const user = app.data.getUserProfile(profileUserId);
                        if (!user) {
                            app.ui.showToast("Пользователь не найден", true);
                            app.navigateBack();
                            return;
                        }

                        const isMyProfile = profileUserId === app.state.userId;

                        const headerButtons = isMyProfile ? `
                            <button id="share-btn" class="p-3 rounded-lg bg-[var(--tg-secondary-bg)] flex items-center justify-center" data-type="profile" data-id="${profileUserId}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                            </button>
                            <button id="settings-btn" class="p-3 rounded-lg bg-[var(--tg-secondary-bg)] flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                            </button>` : '';
                        
                        const tabsHtml = isMyProfile ? `
                            <div class="profile-tabs">
                                <div class="profile-tab" data-tab="listings">Объявления</div>
                                <div class="profile-tab" data-tab="orders">Мои заказы</div>
                                <div class="profile-tab" data-tab="sales">Мои продажи</div>
                            </div>
                        ` : `<h3 class="text-xl font-bold mb-4 mt-8">Объявления пользователя</h3>`;

                        app.elements.root.innerHTML = `
                            <div id="profile-view" class="view active p-4">
                                <div class="flex items-start justify-between mb-8">
                                    <div class="flex items-center"><img src="${user.photoUrl}" class="w-20 h-20 rounded-full mr-4 bg-[var(--tg-secondary-bg)]"><div><h2 class="text-3xl font-bold tracking-tight">${user.firstName} ${user.lastName || ''}</h2><div class="flex items-center gap-2"><p class="text-md" style="color: var(--tg-hint);">${app.state.allListings.filter(item => item.ownerId === profileUserId).length} объявлений</p>${isMyProfile ? `<p class="font-semibold text-lg" style="color: var(--tg-button);">${(user.balance || 0).toLocaleString('ru-RU')} ₽</p>` : ''}</div></div></div>
                                    <div class="flex items-center space-x-2">${headerButtons}</div>
                                </div>
                                ${tabsHtml}
                                <div id="profile-content-container"></div>
                            </div>`;
                        
                        this._renderProfileTabContent(isMyProfile, profileUserId, isMyProfile ? initialTab : 'listings');
                        this._attachProfileListeners(isMyProfile, profileUserId);
                    },

                    _renderProfileTabContent(isMyProfile, profileUserId, tabName) {
                        const container = document.getElementById('profile-content-container');
                        if (!container) return;

                        if (isMyProfile) {
                            document.querySelectorAll('.profile-tab').forEach(tab => {
                                tab.classList.toggle('active', tab.dataset.tab === tabName);
                            });
                        }

                        let contentHtml = '';
                        switch(tabName) {
                            case 'orders':
                                contentHtml = this._renderProfileOrders(profileUserId);
                                break;
                            case 'sales':
                                contentHtml = this._renderProfileSales(profileUserId);
                                break;
                            case 'listings':
                            default:
                                contentHtml = this._renderProfileListings(profileUserId, isMyProfile);
                                break;
                        }
                        container.innerHTML = contentHtml;
                        
                        if (tabName === 'listings') {
                            this._attachGridListeners();
                        } else {
                            document.querySelectorAll('.order-list-item[data-order-id]').forEach(item => {
                                item.addEventListener('click', e => {
                                    const orderId = e.currentTarget.dataset.orderId;
                                    if (orderId) app.actions.handleOrderClick(orderId);
                                });
                            });
                        }
                    },

                    _renderProfileListings(profileUserId, isMyProfile) {
                        const userListings = app.state.allListings.filter(item => item.ownerId === profileUserId && (isMyProfile || item.status === 'active'));
                        if (userListings.length > 0) {
                            return `<div id="my-listings-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">${userListings.map(item => this._renderCard(item, isMyProfile)).join('')}</div>`;
                        }
                        return `<div class="text-center py-16"><div class="text-6xl mb-4">📦</div><p class="mt-5 font-bold text-lg">${isMyProfile ? 'У вас пока нет объявлений' : 'У пользователя нет объявлений'}</p>${isMyProfile ? '<p class="text-sm mt-1" style="color: var(--tg-hint);">Нажмите на + чтобы создать первое.</p>' : ''}</div>`;
                    },

                    _renderProfileOrders(profileUserId) {
                        const myOrders = app.state.allOrders.filter(o => o.buyerId === profileUserId);
                        if (myOrders.length === 0) {
                            return `<div class="text-center py-16"><div class="text-6xl mb-4">🛒</div><p class="mt-5 font-bold text-lg">У вас еще нет заказов</p><p class="text-sm mt-1" style="color: var(--tg-hint);">Найдите что-нибудь интересное на главной!</p></div>`;
                        }

                        const ordersHtml = myOrders.map(order => {
                            const item = app.data.getListingById(order.listingId);
                            if (!item) return '';
                            return `
                                <div class="order-list-item cursor-pointer" data-order-id="${order.orderId}">
                                    <img src="${item.images[0]}" class="order-item-img" onerror="this.onerror=null;this.src='https://placehold.co/128x128/e2e8f0/475569?text=?'">
                                    <div class="order-item-info">
                                        <p class="order-item-title">${item.title}</p>
                                        <p class="order-item-price">${item.price.toLocaleString('ru-RU')} ₽</p>
                                    </div>
                                    <div>
                                        <span class="order-status-badge status-${order.status}">${app.utils.getOrderStatusText(order.status)}</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        return `<div class="space-y-3">${ordersHtml}</div>`;
                    },

                    _renderProfileSales(profileUserId) {
                        const mySales = app.state.allOrders.filter(o => o.sellerId === profileUserId);
                         if (mySales.length === 0) {
                            return `<div class="text-center py-16"><div class="text-6xl mb-4">💰</div><p class="mt-5 font-bold text-lg">У вас еще нет продаж</p><p class="text-sm mt-1" style="color: var(--tg-hint);">Ваши проданные товары появятся здесь.</p></div>`;
                        }
                        const salesHtml = mySales.map(sale => {
                             const item = app.data.getListingById(sale.listingId);
                             if (!item) return '';
                             const buyer = app.data.getUserProfile(sale.buyerId);
                             return `
                                <div class="order-list-item cursor-pointer" data-order-id="${sale.orderId}">
                                     <img src="${item.images[0]}" class="order-item-img" onerror="this.onerror=null;this.src='https://placehold.co/128x128/e2e8f0/475569?text=?'">
                                     <div class="order-item-info">
                                         <p class="order-item-title">${item.title}</p>
                                         <p class="text-sm text-[var(--tg-hint)]">Покупатель: ${buyer.firstName}</p>
                                     </div>
                                     <div>
                                         <span class="order-status-badge status-${sale.status}">${app.utils.getOrderStatusText(sale.status)}</span>
                                     </div>
                                </div>
                             `;
                        }).join('');
                        return `<div class="space-y-3">${salesHtml}</div>`;
                    },

                    renderSettings() {
                        const user = app.state.currentUser;
                        app.elements.root.innerHTML = `
                            <div id="settings-view" class="view active p-4">
                                <h2 class="text-3xl font-bold tracking-tighter mb-8">Настройки</h2>
                                <div class="space-y-5">
                                    <div><label class="form-label">Имя</label><input type="text" id="settings-name-input" placeholder="Ваше имя" class="form-input" value="${user.firstName || ''}"></div>
                                    <div><label class="form-label">Имя пользователя Telegram</label><div class="relative"><span class="absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400">@</span><input type="text" id="settings-username-input" placeholder="username" class="form-input pl-8" value="${user.tgUsername || ''}"></div></div>
                                    <div><label class="form-label">Город по умолчанию</label><input type="text" id="settings-city-input" placeholder="Ваш город" class="form-input" value="${user.city || ''}"></div>
                                    <div class="flex items-center justify-between pt-2"><div><p class="font-medium">Push-уведомления</p><p class="text-sm text-[var(--tg-hint)]">Уведомления о новых сообщениях</p></div><label class="toggle-switch"><input type="checkbox" id="settings-notifications-toggle" ${user.settings.notifications ? 'checked' : ''}><span class="toggle-slider"></span></label></div>
                                    <button id="save-settings-btn" class="action-button w-full !mt-8">Сохранить</button>
                                </div>
                                <div class="mt-12 border-t pt-8" style="border-color: var(--tg-secondary-bg);"><h3 class="text-lg font-bold text-[var(--tg-danger)]">Опасная зона</h3><p class="text-sm mt-1 mb-4" style="color: var(--tg-hint);">Это действие нельзя будет отменить.</p><button id="clear-data-btn" class="action-button danger-button w-full">Очистить мои данные</button></div>
                            </div>`;
                        this._attachSettingsListeners();
                    },
                    
                    renderCreate() {
                        app.actions.initCreateForm();
                    },

                    renderSkeletonFeed() {
                        const skeletonHtml = Array(6).fill('<div class="skeleton-card shimmer"><div class="skeleton-img"></div><div class="p-3"><div class="skeleton-text rounded-md"></div><div class="skeleton-text skeleton-text-short rounded-md"></div></div></div>').join('');
                        app.elements.root.innerHTML = `<div class="p-4"><div class="grid grid-cols-2 sm:grid-cols-3 gap-4">${skeletonHtml}</div></div>`;
                    },

                    _renderCard(item, isMyListing = false) {
                        const isFavorited = app.state.currentUser.favorites.includes(item.id);
                        const firstImage = item.images?.[0] || 'https://placehold.co/600x400/e2e8f0/475569?text=Image';
                        const favoriteButtonHtml = `<div class="favorite-btn" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="${isFavorited ? 'var(--tg-danger)' : 'none'}" stroke="${isFavorited ? 'var(--tg-danger)' : 'currentColor'}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none transition-all"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></div>`;
                        const myListingButtonsHtml = `<div class="absolute bottom-3 right-3 flex space-x-2"><button class="edit-btn p-2 bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 transition-all flex items-center justify-center w-9 h-9" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="delete-btn p-2 bg-red-500 text-white rounded-full shadow-lg hover:bg-red-600 transition-all flex items-center justify-center w-9 h-9" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button></div>`;
                        const archivedOverlayHtml = item.status === 'archived' ? `<div class="archived-overlay"><span>Продано</span></div>` : '';

                        return `<div class="product-card-wrapper cursor-pointer" data-id="${item.id}"><div class="product-card"><div class="relative"><img src="${firstImage}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/475569?text=Image'" alt="${item.title}" class="w-full h-32 object-cover">${!isMyListing ? favoriteButtonHtml : ''}${isMyListing ? archivedOverlayHtml : ''}</div><div class="p-3"><p class="font-bold text-lg">${item.price.toLocaleString('ru-RU')} ₽</p><h3 class="font-medium leading-tight truncate mt-1">${item.title}</h3><p class="text-sm truncate mt-2" style="color: var(--tg-hint);">${item.city}</p></div>${isMyListing ? myListingButtonsHtml : ''}</div></div>`;
                    },

                    _renderMessageBubble(msg) {
                        return `<div class="message-row ${msg.senderId === app.state.userId ? 'sent' : 'received'}"><div class="message-bubble">${msg.text}</div></div>`;
                    },

                    _attachFeedListeners() {
                        document.getElementById('search-input')?.addEventListener('input', app.utils.debounce(e => { app.state.filter.query = e.target.value; this._updateFeedContent(); }, 300));
                        document.getElementById('filter-btn')?.addEventListener('click', () => app.ui.showModal('filter'));
                        document.getElementById('categories-bar')?.addEventListener('click', e => {
                            const categoryChip = e.target.closest('.category-chip');
                            if (categoryChip && app.state.filter.category !== categoryChip.dataset.category) {
                                tg?.HapticFeedback.selectionChanged();
                                app.state.filter.category = categoryChip.dataset.category;
                                this._updateFeedContent();
                            }
                        });
                        this._attachGridListeners();
                    },
                    _attachGridListeners() {
                        document.querySelectorAll('.product-card-wrapper').forEach(card => card.addEventListener('click', e => app.actions.handleCardClick(e)));
                        document.querySelectorAll('.favorite-btn').forEach(btn => btn.addEventListener('click', e => app.actions.handleFavoriteClick(e)));
                        document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', e => app.actions.handleEditClick(e)));
                        document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', e => app.actions.handleDeleteClick(e)));
                    },
                    _attachDetailsListeners(item) {
                        const slider = document.getElementById('details-image-slider');
                        const indicator = document.getElementById('image-indicator');
                        if (slider) {
                            slider.addEventListener('scroll', app.utils.debounce(() => {
                                const index = Math.round(slider.scrollLeft / slider.clientWidth);
                                if(indicator) indicator.textContent = `${index + 1} / ${item.images.length}`;
                            }, 50));
                        }
                        document.getElementById('details-image-container')?.addEventListener('click', () => {
                            const currentIndex = slider ? Math.round(slider.scrollLeft / slider.clientWidth) : 0;
                            app.ui.showLightbox(item.images, currentIndex);
                        });
                        document.getElementById('seller-profile-link')?.addEventListener('click', e => app.navigateTo('profile', { userId: e.currentTarget.dataset.userId }));
                        document.getElementById('share-btn')?.addEventListener('click', e => app.actions.handleShare(e.currentTarget.dataset));
                        document.querySelector('.favorite-btn-details')?.addEventListener('click', e => app.actions.handleFavoriteClick(e));
                        document.querySelector('#contact-seller-btn')?.addEventListener('click', () => app.actions.handleContactSeller(item.ownerId, item.id));
                        document.querySelector('#buy-btn')?.addEventListener('click', () => app.actions.handleBuyClick(item.id));
                        document.querySelector('.edit-btn')?.addEventListener('click', e => app.actions.handleEditClick(e));
                        document.querySelector('#toggle-publish-btn')?.addEventListener('click', e => app.actions.handleTogglePublish(e));
                    },
                    _attachChatListeners() {
                        const messageInput = document.getElementById('chat-message-input');
                        const sendButton = document.getElementById('chat-send-btn');
                        
                        document.getElementById('chat-header-product')?.addEventListener('click', e => {
                            if (e.currentTarget.dataset.itemId) app.navigateTo('details', { itemId: e.currentTarget.dataset.itemId });
                        });

                        messageInput.addEventListener('input', () => { sendButton.disabled = messageInput.value.trim() === ''; });
                        sendButton.addEventListener('click', () => app.actions.handleSendMessage());
                        messageInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !sendButton.disabled) { e.preventDefault(); app.actions.handleSendMessage(); }});
                        messageInput.focus();
                    },
                    _attachChatsListListeners() {
                        document.querySelectorAll('.chat-list-item').forEach(item => {
                            item.addEventListener('click', () => {
                                const chatId = item.dataset.chatId;
                                app.data.markChatAsRead(chatId);
                                app.navigateTo('chat', { chatId });
                            });
                        });
                    },
                    _attachProfileListeners(isMyProfile, profileUserId) {
                        document.getElementById('settings-btn')?.addEventListener('click', () => app.navigateTo('settings'));
                        document.getElementById('share-btn')?.addEventListener('click', e => app.actions.handleShare(e.currentTarget.dataset));
                        
                        if (isMyProfile) {
                            document.querySelectorAll('.profile-tab').forEach(tab => {
                                tab.addEventListener('click', (e) => {
                                    const tabName = e.currentTarget.dataset.tab;
                                    this._renderProfileTabContent(isMyProfile, profileUserId, tabName);
                                });
                            });
                        }

                        // NEW: Listener for order items is now inside _renderProfileTabContent
                        // to be re-attached every time content changes.
                    },
                    _attachSettingsListeners() {
                        document.getElementById('save-settings-btn')?.addEventListener('click', () => app.actions.handleSaveSettings());
                        document.getElementById('clear-data-btn')?.addEventListener('click', () => app.actions.handleClearData());
                    }
                },

                storage: {
                    save() {
                        const dataToSave = {
                            users: app.state.allUsers,
                            listings: app.state.allListings,
                            chats: app.state.allChats,
                            orders: app.state.allOrders,
                        };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                    },
                    load() {
                        const savedData = localStorage.getItem(STORAGE_KEY);
                        const data = savedData ? JSON.parse(savedData) : getInitialData();
                        
                        const tgUser = tg.initDataUnsafe?.user || { id: 'local_user_id', first_name: 'Тест', username: 'test_user' };
                        app.state.userId = tgUser.id.toString();

                        app.state.allUsers = data.users;
                        app.state.allListings = data.listings;
                        app.state.allChats = data.chats;
                        app.state.allOrders = data.orders || [];

                        if (!app.state.allUsers[app.state.userId]) {
                            app.state.allUsers[app.state.userId] = {
                                id: app.state.userId,
                                tgUsername: tgUser.username,
                                firstName: tgUser.first_name,
                                lastName: tgUser.last_name || '',
                                photoUrl: tgUser.photo_url || `https://placehold.co/96x96/1d4ed8/ffffff?text=${(tgUser.first_name || 'T')[0]}`,
                                city: 'Москва',
                                favorites: [],
                                settings: { notifications: true },
                                balance: 15000 // NEW: Initial balance
                            };
                        }
                        
                        app.state.currentUser = app.state.allUsers[app.state.userId];

                        if (!savedData) {
                            app.state.allChats.forEach(chat => {
                                const localIndex = chat.participantIds.indexOf('local_user_id');
                                if (localIndex > -1) {
                                    chat.participantIds[localIndex] = app.state.userId;
                                    chat.messages.forEach(msg => {
                                        if (msg.senderId === 'local_user_id') msg.senderId = app.state.userId;
                                    });
                                }
                            });
                            app.state.allOrders.forEach(order => {
                                if (order.buyerId === 'local_user_id') {
                                    order.buyerId = app.state.userId;
                                }
                            });
                        }
                        this.save();
                    },
                    clear() {
                        localStorage.removeItem(STORAGE_KEY);
                    }
                },

                data: {
                    async fetchCities() {
                        if (app.state.russianCities.length > 0) return;
                        try {
                            const response = await fetch('https://raw.githubusercontent.com/pensnarik/russian-cities/master/russian-cities.json');
                            if (!response.ok) throw new Error('Network response was not ok');
                            const cities = await response.json();
                            app.state.russianCities = cities.map(c => ({ name: c.name, subject: c.subject })).sort((a,b) => a.name.localeCompare(b.name));
                        } catch (error) {
                            console.error("Failed to fetch cities:", error);
                        }
                    },
                    async reverseGeocode(lat, lon) {
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ru`);
                            if (!response.ok) throw new Error('Reverse geocoding failed');
                            const data = await response.json();
                            return data.address.city || data.address.town || data.address.village || 'Не определен';
                        } catch (error) {
                            console.error("Reverse geocoding error:", error);
                            return null;
                        }
                    },
                    getUserProfile(userId) {
                        return app.state.allUsers[userId] || null;
                    },
                    getListingById(itemId) {
                        return app.state.allListings.find(i => i.id === itemId) || null;
                    },
                    getOrderById(orderId) {
                        return app.state.allOrders.find(o => o.orderId === orderId) || null;
                    },
                    saveListing(data) {
                        if (data.id && !data.id.startsWith('local-')) {
                            const index = app.state.allListings.findIndex(l => l.id === data.id);
                            if (index !== -1) app.state.allListings[index] = { ...app.state.allListings[index], ...data };
                        } else {
                            const newItem = { ...data, id: `local-${Date.now()}`, ownerId: app.state.userId, createdAt: new Date(), status: 'active' };
                            app.state.allListings.unshift(newItem);
                        }
                        app.storage.save();
                    },
                    deleteListing(id) {
                        app.state.allListings = app.state.allListings.filter(l => l.id !== id);
                        app.storage.save();
                    },
                    toggleFavorite(itemId) {
                        const favIndex = app.state.currentUser.favorites.indexOf(itemId);
                        if (favIndex > -1) {
                            app.state.currentUser.favorites.splice(favIndex, 1);
                            app.storage.save();
                            return false;
                        } else {
                            app.state.currentUser.favorites.push(itemId);
                            app.storage.save();
                            return true;
                        }
                    },
                    saveUserSettings(data) {
                        app.state.currentUser = {...app.state.currentUser, ...data};
                        app.storage.save();
                    },
                    clearUserData() {
                        app.state.allListings = app.state.allListings.filter(l => l.ownerId !== app.state.userId);
                        app.state.currentUser.favorites = [];
                        app.state.currentUser.balance = 0;
                        app.state.allChats = app.state.allChats.filter(c => !c.participantIds.includes(app.state.userId));
                        app.state.allOrders = app.state.allOrders.filter(o => o.buyerId !== app.state.userId && o.sellerId !== app.state.userId);
                        app.storage.save();
                    },
                    getChatsForUser(userId) {
                        return app.state.allChats
                            .filter(c => c.participantIds.includes(userId))
                            .sort((a,b) => {
                                const lastMsgA = a.messages[a.messages.length - 1];
                                const lastMsgB = b.messages[b.messages.length - 1];
                                if (!lastMsgA) return 1;
                                if (!lastMsgB) return -1;
                                return new Date(lastMsgB.timestamp) - new Date(lastMsgA.timestamp);
                            });
                    },
                    getUnreadCount(chatId) {
                        const chat = app.state.allChats.find(c => c.chatId === chatId);
                        return chat ? (chat.unreadCount || 0) : 0;
                    },
                    markChatAsRead(chatId) {
                        const chat = app.state.allChats.find(c => c.chatId === chatId);
                        if (chat) chat.unreadCount = 0;
                        app.storage.save();
                    }
                },

                actions: {
                    handleShare({ type, id }) {
                        if (!tg || !tg.openTelegramLink) {
                            app.ui.showToast("Функция доступна только в Telegram.", true);
                            return;
                        }
                        const botUsername = 'trollbay_bot';
                        const startappParam = `${type}:${id}`;
                        const shareUrl = `https://t.me/${botUsername}?startapp=${startappParam}`;
                        
                        let text = '';
                        if (type === 'product') {
                            const item = app.data.getListingById(id);
                            text = `Смотри, что я нашел на Trollbay: ${item.title} за ${item.price.toLocaleString('ru-RU')} ₽!`;
                        } else if (type === 'profile') {
                            const user = app.data.getUserProfile(id);
                            text = `Смотри профиль продавца ${user.firstName} на Trollbay!`;
                        }

                        const telegramShareUrl = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(text)}`;
                        tg.openTelegramLink(telegramShareUrl);
                    },
                    handleCardClick(e) {
                        if (e.target.closest('button, .favorite-btn')) return;
                        const cardWrapper = e.currentTarget;
                        tg?.HapticFeedback.impactOccurred('light');
                        app.navigateTo('details', { itemId: cardWrapper.dataset.id });
                    },
                    handleFavoriteClick(e) {
                        e.stopPropagation();
                        const button = e.currentTarget;
                        const itemId = button.dataset.id;
                        tg?.HapticFeedback.impactOccurred('light');
                        const isNowFavorited = app.data.toggleFavorite(itemId);
                        app.ui.showToast(isNowFavorited ? "Добавлено в избранное" : "Удалено из избранного");
                        
                        if (app.state.currentView === 'favorites') {
                            app.views.renderFavorites();
                        } else {
                            document.querySelectorAll(`[data-id="${itemId}"] .favorite-btn svg, .favorite-btn-details[data-id="${itemId}"] svg`).forEach(svg => {
                                svg.setAttribute('fill', isNowFavorited ? 'var(--tg-danger)' : 'none');
                                svg.setAttribute('stroke', isNowFavorited ? 'var(--tg-danger)' : 'currentColor');
                            });
                            button.classList.add('pop');
                            setTimeout(() => button.classList.remove('pop'), 300);
                        }
                    },
                    handleEditClick(e) {
                        e.stopPropagation();
                        app.navigateTo('create', { editingItemId: e.currentTarget.dataset.id });
                    },
                    handleDeleteClick(e) {
                        e.stopPropagation();
                        const itemId = e.currentTarget.dataset.id;
                        app.ui.showModal('confirm', {
                            title: 'Удалить объявление?', message: 'Это действие нельзя будет отменить.',
                            confirmText: 'Удалить', isDanger: true,
                            onConfirm: () => {
                                app.data.deleteListing(itemId);
                                app.ui.showToast("Объявление удалено");
                                tg?.HapticFeedback.notificationOccurred('success');
                                app._renderCurrentView();
                            }
                        });
                    },
                    handleTogglePublish(e) {
                        const itemId = e.currentTarget.dataset.id;
                        const item = app.data.getListingById(itemId);
                        if (!item) return;
                        
                        item.status = item.status === 'active' ? 'archived' : 'active';
                        app.storage.save();
                        app.ui.showToast(item.status === 'active' ? 'Объявление снова в публикации' : 'Объявление снято с публикации');
                        app._renderCurrentView();
                    },
                    handleContactSeller(sellerId, listingId) {
                        let chat = app.state.allChats.find(c => c.participantIds.includes(sellerId) && c.listingId === listingId);
                        if (!chat) {
                            chat = {
                                chatId: `chat-${sellerId}-${listingId}-${Date.now()}`,
                                participantIds: [app.state.userId, sellerId],
                                listingId: listingId,
                                messages: [],
                                unreadCount: 0,
                            };
                            app.state.allChats.unshift(chat);
                            app.storage.save();
                        }
                        app.navigateTo('chat', { chatId: chat.chatId });
                    },
                    handleSendMessage() {
                        const input = document.getElementById('chat-message-input');
                        const text = input.value.trim();
                        if (!text) return;

                        const chatId = app.state.viewParams.chatId;
                        const chat = app.state.allChats.find(c => c.chatId === chatId);
                        if (chat) {
                            const newMessage = { senderId: app.state.userId, text: text, timestamp: new Date() };
                            chat.messages.push(newMessage);
                            app.storage.save();
                            
                            input.value = '';
                            document.getElementById('chat-send-btn').disabled = true;
                            
                            const wrapper = document.querySelector('.messages-wrapper');
                            wrapper.innerHTML += app.views._renderMessageBubble(newMessage);
                            const container = document.getElementById('chat-messages-container');
                            container.scrollTop = container.scrollHeight;
                            input.focus();

                            this.simulateBotResponse(chatId, text);
                        }
                    },
                    simulateBotResponse(chatId, userMessage) {
                        const chat = app.state.allChats.find(c => c.chatId === chatId);
                        if (!chat) return;
                        
                        const otherUserId = chat.participantIds.find(id => id !== app.state.userId);
                        
                        setTimeout(() => {
                            let botReplyText = "Интересно. Расскажите подробнее.";
                            if (/привет|здравствуй/i.test(userMessage)) botReplyText = "Добрый день!";
                            else if (/продаете|актуально|в продаже/i.test(userMessage)) botReplyText = "Да, еще актуально.";
                            else if (/доставк/i.test(userMessage)) botReplyText = "Да, могу отправить. Куда?";
                            else if (/торг/i.test(userMessage)) botReplyText = "Торг минимальный.";
                            else if (/состоян/i.test(userMessage)) botReplyText = "Состояние отличное, как на фото.";

                            const botMessage = { senderId: otherUserId, text: botReplyText, timestamp: new Date() };
                            chat.messages.push(botMessage);
                            
                            if (app.state.currentView !== 'chat' || app.state.viewParams.chatId !== chatId) {
                                chat.unreadCount = (chat.unreadCount || 0) + 1;
                            }
                            
                            app.storage.save();

                            if (app.state.currentView === 'chat' && app.state.viewParams.chatId === chatId) {
                                const wrapper = document.querySelector('.messages-wrapper');
                                wrapper.innerHTML += app.views._renderMessageBubble(botMessage);
                                const container = document.getElementById('chat-messages-container');
                                container.scrollTop = container.scrollHeight;
                                tg?.HapticFeedback.notificationOccurred('success');
                            }
                        }, 1500 + Math.random() * 1000);
                    },
                    handleBuyClick(itemId) {
                        const item = app.data.getListingById(itemId);
                        if (!item || item.status !== 'active') return;

                        app.ui.showModal('confirm', {
                            title: 'Подтверждение покупки',
                            message: `Вы уверены, что хотите купить "${item.title}" за ${item.price.toLocaleString('ru-RU')} ₽?`,
                            confirmText: 'Купить',
                            onConfirm: () => {
                                const newOrder = {
                                    orderId: `order-${Date.now()}`,
                                    listingId: item.id,
                                    buyerId: app.state.userId,
                                    sellerId: item.ownerId,
                                    createdAt: new Date().toISOString(),
                                    status: 'processing'
                                };
                                
                                app.state.allOrders.unshift(newOrder);
                                
                                const listingToUpdate = app.data.getListingById(itemId);
                                if (listingToUpdate) {
                                    listingToUpdate.status = 'sold'; // NEW: Статус "продано"
                                }
                                
                                app.storage.save();
                                
                                tg?.HapticFeedback.notificationOccurred('success');
                                app.ui.showToast('Заказ успешно оформлен!');
                                
                                app.navigateTo('profile', { userId: app.state.userId, initialTab: 'orders' });
                            }
                        });
                    },
                    // NEW: Обработчик клика по заказу
                    handleOrderClick(orderId) {
                        app.ui.showModal('orderDetails', { orderId });
                    },
                    // NEW: Обработчик смены статуса заказа
                    handleOrderStatusChange(orderId, newStatus) {
                        const order = app.data.getOrderById(orderId);
                        if (!order) return;

                        const oldStatus = order.status;
                        order.status = newStatus;

                        // NEW: Логика начисления баланса
                        if (newStatus === 'delivered' && oldStatus !== 'delivered') {
                            const seller = app.data.getUserProfile(order.sellerId);
                            const item = app.data.getListingById(order.listingId);
                            if (seller && item) {
                                seller.balance = (seller.balance || 0) + item.price;
                                app.ui.showToast(`Баланс продавца ${seller.firstName} пополнен на ${item.price} ₽`);
                            }
                        }

                        app.storage.save();
                        app.ui.hideModal();
                        app.ui.showToast('Статус заказа обновлен');
                        tg?.HapticFeedback.notificationOccurred('success');
                        
                        // Re-render the current view to reflect changes
                        app._renderCurrentView();
                    },
                    handleSaveSettings() {
                        const newName = document.getElementById('settings-name-input').value;
                        const newCity = document.getElementById('settings-city-input').value;
                        if (!newName || !newCity) {
                            app.ui.showToast('Имя и город не могут быть пустыми', true); return;
                        }
                        app.data.saveUserSettings({ 
                            firstName: newName,
                            tgUsername: document.getElementById('settings-username-input').value,
                            city: newCity,
                            settings: { notifications: document.getElementById('settings-notifications-toggle').checked }
                        });
                        app.ui.showToast("Настройки сохранены");
                        tg?.HapticFeedback.notificationOccurred('success');
                    },
                    handleClearData() {
                        app.ui.showModal('confirm', {
                            title: 'Очистить все данные?', message: 'Все ваши объявления, чаты, заказы и баланс будут удалены. Это действие необратимо.',
                            confirmText: 'Очистить', isDanger: true,
                            onConfirm: () => {
                                app.data.clearUserData();
                                app.ui.showToast("Все ваши данные были удалены.");
                                tg?.HapticFeedback.notificationOccurred('success');
                                app.navigateTo('feed');
                            }
                        });
                    },
                    
                    initCreateForm() {
                        const editingItemId = app.state.viewParams.editingItemId || null;
                        const itemToEdit = editingItemId ? app.data.getListingById(editingItemId) : null;
                        
                        app.state.createAdState = itemToEdit
                            ? { ...itemToEdit, images: [...(itemToEdit.images || [])], isCityValidated: true }
                            : { city: app.state.currentUser.city || '', images: [], isCityValidated: false };
                        
                        app.state.createAdCurrentStep = 1;
                        app.elements.root.innerHTML = `<div id="create-view" class="view active p-4"></div>`;
                        this.renderCreateStep();
                    },
                    renderCreateStep() {
                        const step = app.state.createAdCurrentStep;
                        const itemToEdit = app.state.viewParams.editingItemId ? app.data.getListingById(app.state.viewParams.editingItemId) : null;
                        const state = app.state.createAdState;

                        let stepHtml = '';
                        switch(step) {
                            case 1:
                                stepHtml = `<div class="space-y-5"><div><label class="form-label">Что продаете?</label><input type="text" name="title" placeholder="Например, Ролики Seba FR1" required class="form-input" value="${state.title || ''}"></div><div><label class="form-label">Категория</label><select name="category" required class="form-input"></select></div><div><label class="form-label">Состояние</label><select name="condition" required class="form-input"><option value="" disabled ${!state.condition ? 'selected' : ''}>Выберите состояние</option><option value="new" ${state.condition === 'new' ? 'selected' : ''}>Новое</option><option value="used" ${state.condition === 'used' ? 'selected' : ''}>Б/у</option></select></div></div>`;
                                break;
                            case 2:
                                stepHtml = `<div><label class="form-label">Фотографии (до 10 шт.)</label><input type="file" id="image-input" class="hidden" accept="image/*" multiple><div class="grid grid-cols-3 sm:grid-cols-4 gap-3 items-center"><div id="photo-thumbnails" class="col-span-3 sm:col-span-4 grid grid-cols-subgrid"></div><button type="button" id="photo-picker" class="w-full aspect-square border-2 border-dashed border-[var(--tg-hint)] rounded-lg flex items-center justify-center text-[var(--tg-hint)]"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button></div></div>`;
                                break;
                            case 3:
                                stepHtml = `<div class="space-y-5"><div><label class="form-label">Описание</label><textarea name="description" placeholder="Расскажите подробнее о товаре..." rows="5" required class="form-input">${state.description || ''}</textarea></div><div><label class="form-label">Цена, ₽</label><input type="number" name="price" placeholder="0" required class="form-input" value="${state.price || ''}"></div></div>`;
                                break;
                            case 4:
                                stepHtml = `<div><label class="form-label">Город продажи</label><div class="flex items-center space-x-2"><input type="text" id="city-search-input" placeholder="Начните вводить город..." class="form-input flex-grow" value="${state.city || ''}" autocomplete="off"><button type="button" id="geolocate-btn" class="p-3 rounded-lg bg-[var(--tg-secondary-bg)] flex items-center justify-center aspect-square"><span id="geolocate-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></span><div id="geolocate-spinner" class="spinner hidden"></div></button></div><div id="city-search-results" class="bg-[var(--tg-bg)]"></div></div>`;
                                break;
                        }

                        document.getElementById('create-view').innerHTML = `<div class="mb-4"><h2 class="text-3xl font-bold tracking-tighter">${itemToEdit ? 'Редактировать' : 'Новое объявление'}</h2><p id="create-step-indicator" class="text-sm font-medium" style="color: var(--tg-hint);">Шаг ${step} из 4</p></div><form id="create-form" class="flex-grow"><div id="create-step-${step}" class="create-step active">${stepHtml}</div></form>`;

                        if (step === 1) {
                            const categorySelect = document.querySelector('select[name="category"]');
                            const categoryOptions = app.state.categories.map(cat => `<option value="${cat}" ${state.category === cat ? 'selected' : ''}>${cat}</option>`).join('');
                            categorySelect.innerHTML = `<option value="" disabled ${!state.category ? 'selected' : ''}>Выберите категорию</option>` + categoryOptions;
                        } else if (step === 2) {
                            this.renderPhotoThumbnails();
                            document.getElementById('photo-picker').addEventListener('click', () => document.getElementById('image-input').click());
                            document.getElementById('image-input').addEventListener('change', e => this.handlePhotoUpload(e));
                            document.getElementById('photo-thumbnails').addEventListener('click', e => {
                                if (e.target.closest('.thumbnail-delete')) this.handlePhotoDelete(parseInt(e.target.closest('.thumbnail-delete').dataset.index, 10));
                            });
                        } else if (step === 4) {
                            const cityInput = document.getElementById('city-search-input');
                            cityInput.addEventListener('input', e => {
                                app.state.createAdState.isCityValidated = false;
                                app.utils.debounce(() => this.renderCitySearchResults(e.target.value), 200)();
                            });
                             cityInput.addEventListener('focus', () => this.renderCitySearchResults(cityInput.value));
                            document.getElementById('city-search-results').addEventListener('click', e => {
                                const cityItem = e.target.closest('.city-result-item');
                                if (cityItem) this.handleCitySelect(cityItem.dataset.city);
                            });
                            document.getElementById('geolocate-btn').addEventListener('click', () => this.handleGeolocateClick());
                        }
                        app._updateUIChrome();
                    },
                    handleCreateStepChange(direction) {
                        const currentStep = app.state.createAdCurrentStep;
                        if (direction === 'next') {
                            if (!this.validateCreateStep(currentStep)) return;
                            this.saveCreateStepState(currentStep);
                            if (currentStep < 4) {
                                app.state.createAdCurrentStep++;
                                this.renderCreateStep();
                            } else {
                                this.handlePublishClick();
                            }
                        } else if (direction === 'back') {
                            if (currentStep > 1) {
                                this.saveCreateStepState(currentStep);
                                app.state.createAdCurrentStep--;
                                this.renderCreateStep();
                            } else {
                                app.navigateBack();
                            }
                        }
                    },
                    validateCreateStep(step) {
                        const form = document.getElementById('create-form');
                        let isValid = true;
                        let errorMessage = 'Пожалуйста, заполните все поля.';
                        form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
                        
                        const checkField = (selector) => {
                            const field = form.querySelector(selector);
                            if (!field.value) { field.classList.add('invalid'); isValid = false; }
                        };

                        switch(step) {
                            case 1:
                                checkField('[name="title"]');
                                checkField('[name="category"]');
                                checkField('[name="condition"]');
                                break;
                            case 2:
                                if (!app.state.createAdState.images?.length) { isValid = false; errorMessage = 'Пожалуйста, загрузите хотя бы одно фото.'; }
                                break;
                            case 3:
                                checkField('[name="description"]');
                                const price = form.querySelector('[name="price"]');
                                if (!price.value || parseInt(price.value) <= 0) { price.classList.add('invalid'); isValid = false; }
                                break;
                            case 4:
                                const cityInput = document.getElementById('city-search-input');
                                if (!cityInput.value) { cityInput.classList.add('invalid'); isValid = false; errorMessage = 'Пожалуйста, укажите город.'; }
                                else if (!app.state.createAdState.isCityValidated) { cityInput.classList.add('invalid'); isValid = false; errorMessage = 'Пожалуйста, выберите город из списка.'; }
                                break;
                        }
                        if (!isValid) {
                            tg?.HapticFeedback.notificationOccurred('error');
                            app.ui.showToast(errorMessage, true);
                        }
                        return isValid;
                    },
                    saveCreateStepState(step) {
                        const form = document.getElementById('create-form');
                        const state = app.state.createAdState;
                        switch(step) {
                            case 1: 
                                state.title = form.querySelector('[name="title"]').value;
                                state.category = form.querySelector('[name="category"]').value;
                                state.condition = form.querySelector('[name="condition"]').value;
                                break;
                            case 3: 
                                state.description = form.querySelector('[name="description"]').value;
                                state.price = parseInt(form.querySelector('[name="price"]').value, 10);
                                break;
                            case 4: 
                                state.city = document.getElementById('city-search-input').value;
                                break;
                        }
                    },
                    handlePublishClick() {
                        if(!tg) return;
                        tg.MainButton.showProgress();
                        setTimeout(() => {
                            try {
                                const listingData = { ...app.state.createAdState, id: app.state.viewParams.editingItemId };
                                app.data.saveListing(listingData);
                                tg?.HapticFeedback.notificationOccurred('success');
                                app.ui.showToast(app.state.viewParams.editingItemId ? 'Объявление обновлено!' : 'Объявление опубликовано!');
                                app.navigateTo('profile');
                            } catch (e) {
                                console.error("Error saving listing:", e);
                                app.ui.showToast('Ошибка сохранения', true);
                            } finally {
                                tg.MainButton.hideProgress();
                            }
                        }, 500);
                    },
                    renderPhotoThumbnails() {
                        const container = document.getElementById('photo-thumbnails');
                        const picker = document.getElementById('photo-picker');
                        const images = app.state.createAdState.images || [];
                        container.innerHTML = images.map((imgSrc, index) => `<div class="thumbnail-container col-span-1"><img src="${imgSrc}" class="thumbnail-img"><button type="button" class="thumbnail-delete" data-index="${index}">&times;</button></div>`).join('');
                        picker.style.display = images.length < 10 ? 'flex' : 'none';
                    },
                    handlePhotoUpload(e) {
                        const files = e.target.files;
                        if (!files) return;
                        const currentCount = app.state.createAdState.images.length;
                        const remainingSlots = 10 - currentCount;
                        if (files.length > remainingSlots) {
                            app.ui.showToast(`Можно загрузить еще ${remainingSlots} фото.`, true);
                        }
                        for (let i = 0; i < Math.min(files.length, remainingSlots); i++) {
                            const reader = new FileReader();
                            reader.onload = (ev) => {
                                app.state.createAdState.images.push(ev.target.result);
                                this.renderPhotoThumbnails();
                            };
                            reader.readAsDataURL(files[i]);
                        }
                        e.target.value = '';
                    },
                    handlePhotoDelete(index) {
                        app.state.createAdState.images?.splice(index, 1);
                        this.renderPhotoThumbnails();
                    },
                    renderCitySearchResults(query) {
                        const resultsContainer = document.getElementById('city-search-results');
                        if (!query) { resultsContainer.innerHTML = ''; return; }
                        const filteredCities = app.state.russianCities.filter(c => c.name.toLowerCase().startsWith(query.toLowerCase())).slice(0, 50);
                        resultsContainer.innerHTML = filteredCities.length > 0
                            ? filteredCities.map(c => `<div class="city-result-item" data-city="${c.name}"><div><p class="font-medium">${c.name}</p><p class="text-sm" style="color: var(--tg-hint);">${c.subject}</p></div></div>`).join('')
                            : `<div class="p-3 text-center text-sm" style="color: var(--tg-hint);">Ничего не найдено</div>`;
                    },
                    handleCitySelect(cityName) {
                        const cityInput = document.getElementById('city-search-input');
                        app.state.createAdState.city = cityName;
                        app.state.createAdState.isCityValidated = true;
                        cityInput.value = cityName;
                        cityInput.classList.remove('invalid');
                        document.getElementById('city-search-results').innerHTML = '';
                    },
                    async handleGeolocateClick() {
                        if (!navigator.geolocation) { app.ui.showToast("Геолокация не поддерживается", true); return; }
                        const icon = document.getElementById('geolocate-icon');
                        const spinner = document.getElementById('geolocate-spinner');
                        icon.classList.add('hidden'); spinner.classList.remove('hidden');
                        try {
                            const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 }));
                            const cityName = await app.data.reverseGeocode(position.coords.latitude, position.coords.longitude);
                            if (cityName) this.handleCitySelect(cityName);
                            else app.ui.showToast("Не удалось определить город", true);
                        } catch (error) {
                            console.error("Geolocation error:", error);
                            app.ui.showToast("Ошибка геолокации: " + error.message, true);
                        } finally {
                            icon.classList.remove('hidden'); spinner.classList.add('hidden');
                        }
                    }
                },

                ui: {
                    _modalConfirmCallback: null,
                    showModal(type, options = {}) {
                        let contentHtml = '';
                        this._modalConfirmCallback = null;
                        switch(type) {
                            case 'filter':
                                contentHtml = `<h3 class="text-xl font-bold mb-5">Сортировка и фильтры</h3><div class="space-y-5"><div><label class="form-label">Сортировать по</label><select id="sort-select" class="form-input">${Object.entries(app.state.sortOptions).map(([k, v]) => `<option value="${k}" ${app.state.filter.sort === k ? 'selected' : ''}>${v}</option>`).join('')}</select></div><div><label class="form-label">Город</label><input type="text" id="city-filter-input" placeholder="Любой город" class="form-input" value="${app.state.filter.city}"></div><div><label class="form-label">Цена</label><div class="flex items-center space-x-2"><input type="number" id="min-price-filter" placeholder="от" class="form-input" value="${app.state.filter.minPrice}"><input type="number" id="max-price-filter" placeholder="до" class="form-input" value="${app.state.filter.maxPrice}"></div></div><div><label class="form-label">Состояние</label><select id="condition-filter" class="form-input"><option value="all" ${app.state.filter.condition === 'all' ? 'selected' : ''}>Любое</option><option value="new" ${app.state.filter.condition === 'new' ? 'selected' : ''}>Новое</option><option value="used" ${app.state.filter.condition === 'used' ? 'selected' : ''}>Б/у</option></select></div></div><div class="flex items-center space-x-3 mt-6"><button id="reset-filters-btn" class="w-full px-4 py-3 rounded-lg bg-[var(--tg-secondary-bg)] font-semibold">Сбросить</button><button id="apply-filters-btn" class="action-button w-full">Применить</button></div>`;
                                break;
                            case 'alert':
                                contentHtml = `<h3 class="text-xl font-bold mb-2">${options.title || 'Внимание'}</h3><p class="mb-5" style="color: var(--tg-hint);">${options.message}</p><div class="flex items-center mt-6"><button class="modal-close-btn action-button w-full">${options.buttonText || 'ОК'}</button></div>`;
                                break;
                            case 'confirm':
                                contentHtml = `<h3 class="text-xl font-bold mb-2">${options.title || 'Подтверждение'}</h3><p class="mb-5" style="color: var(--tg-hint);">${options.message}</p><div class="flex items-center space-x-3 mt-6"><button class="modal-close-btn w-full px-4 py-3 rounded-lg bg-[var(--tg-secondary-bg)] font-semibold">Отмена</button><button id="modal-confirm-btn" class="action-button w-full ${options.isDanger ? 'danger-button' : ''}">${options.confirmText || 'ОК'}</button></div>`;
                                if (typeof options.onConfirm === 'function') this._modalConfirmCallback = options.onConfirm;
                                break;
                            // NEW: Modal for order details
                            case 'orderDetails':
                                const order = app.data.getOrderById(options.orderId);
                                if (!order) { contentHtml = 'Заказ не найден.'; break; }
                                const item = app.data.getListingById(order.listingId);
                                const otherParty = app.data.getUserProfile(app.state.userId === order.buyerId ? order.sellerId : order.buyerId);
                                const isSeller = app.state.userId === order.sellerId;
                                
                                const statuses = { processing: 'В обработке', shipped: 'Отправлен', delivered: 'Доставлен', cancelled: 'Отменен' };
                                const statusOptions = Object.entries(statuses).map(([key, value]) => `<option value="${key}" ${order.status === key ? 'selected' : ''}>${value}</option>`).join('');

                                contentHtml = `
                                    <h3 class="text-xl font-bold mb-4">Детали заказа #${order.orderId.slice(-6)}</h3>
                                    <div class="flex items-center gap-4 p-3 bg-[var(--tg-secondary-bg)] rounded-lg mb-4">
                                        <img src="${item.images[0]}" class="w-16 h-16 object-cover rounded-md">
                                        <div class="overflow-hidden">
                                            <p class="font-semibold truncate">${item.title}</p>
                                            <p class="font-bold text-lg">${item.price.toLocaleString('ru-RU')} ₽</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>${isSeller ? 'Покупатель' : 'Продавец'}:</span><span class="font-semibold">${otherParty.firstName}</span></div>
                                        <div class="flex justify-between"><span>Дата заказа:</span><span class="font-semibold">${new Date(order.createdAt).toLocaleDateString('ru-RU')}</span></div>
                                        <div class="flex justify-between items-center"><span>Статус:</span><span class="order-status-badge status-${order.status}">${app.utils.getOrderStatusText(order.status)}</span></div>
                                    </div>
                                    ${isSeller ? `
                                        <div class="mt-6 border-t pt-4" style="border-color: var(--tg-secondary-bg);">
                                            <label class="form-label">Изменить статус заказа</label>
                                            <select id="order-status-select" class="form-input">${statusOptions}</select>
                                            <button id="save-order-status-btn" data-order-id="${order.orderId}" class="action-button w-full mt-4">Сохранить статус</button>
                                        </div>
                                    ` : ''}
                                `;
                                break;
                        }
                        app.elements.modalContent.innerHTML = contentHtml;
                        app.elements.modalOverlay.classList.add('visible');
                    },
                    hideModal() {
                        app.elements.modalOverlay.classList.remove('visible');
                        this._modalConfirmCallback = null;
                    },
                    showToast(message, isError = false) {
                        const toast = document.createElement('div');
                        toast.className = 'toast';
                        if (isError) toast.style.backgroundColor = 'var(--tg-danger)';
                        toast.textContent = message;
                        app.elements.toastContainer.appendChild(toast);
                        setTimeout(() => toast.remove(), 4000);
                    },
                    showLightbox(images, startIndex = 0) {
                        const { overlay, slider } = app.elements.lightbox;
                        slider.innerHTML = images.map(src => `<div class="lightbox-slide"><img src="${src}" alt="Фото товара"></div>`).join('');
                        overlay.classList.add('visible');
                        app.state.isLightboxOpen = true;
                        tg.BackButton.show();
                        if (startIndex > 0) {
                            slider.scrollTo({ left: slider.clientWidth * startIndex, behavior: 'instant' });
                        }
                    },
                    hideLightbox() {
                        app.elements.lightbox.overlay.classList.remove('visible');
                        app.state.isLightboxOpen = false;
                        app._updateUIChrome();
                    }
                },
                
                telegram: {
                    init() {
                        if (!tg) return;
                        tg.ready();
                        tg.expand();
                        tg.onEvent('backButtonClicked', () => {
                            tg.HapticFeedback.impactOccurred('light');
                            if (app.state.isLightboxOpen) {
                                app.ui.hideLightbox();
                            } else if (app.state.currentView === 'create' && app.state.createAdCurrentStep > 1) {
                                app.actions.handleCreateStepChange('back');
                            } else {
                                app.navigateBack();
                            }
                        });
                        tg.onEvent('mainButtonClicked', () => {
                            tg.HapticFeedback.impactOccurred('heavy');
                            if (app.state.currentView === 'create') {
                                app.actions.handleCreateStepChange('next');
                            }
                        });
                    }
                },

                utils: {
                    getOrderStatusText(status) {
                        const statuses = { processing: 'В обработке', shipped: 'Отправлен', delivered: 'Доставлен', cancelled: 'Отменен' };
                        return statuses[status] || status;
                    },
                    formatTimestamp(date) {
                        const now = new Date();
                        const then = new Date(date);
                        const diffSeconds = Math.round((now - then) / 1000);
                        const diffDays = Math.floor(diffSeconds / 86400);

                        if (diffSeconds < 60) return 'только что';
                        if (diffSeconds < 3600) return `${Math.floor(diffSeconds / 60)} мин. назад`;
                        if (now.getDate() === then.getDate() && diffDays === 0) return then.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                        if (now.getDate() - 1 === then.getDate() && diffDays < 2) return `Вчера, ${then.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
                        return then.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
                    },
                    debounce(func, delay) {
                        let timeout;
                        return function(...args) {
                            clearTimeout(timeout);
                            timeout = setTimeout(() => func.apply(this, args), delay);
                        };
                    }
                },

                initEventListeners() {
                    this.elements.bottomNavbar.addEventListener('click', e => {
                        const navItem = e.target.closest('.nav-item');
                        if (navItem && navItem.dataset.view !== this.state.currentView) {
                            tg?.HapticFeedback.selectionChanged();
                            this.navigateTo(navItem.dataset.view);
                        }
                    });

                    this.elements.createAdFab.addEventListener('click', () => {
                        tg?.HapticFeedback.impactOccurred('heavy');
                        this.navigateTo('create');
                    });
                    
                    this.elements.modalOverlay.addEventListener('click', e => {
                        const target = e.target;
                        if (target.closest('.modal-close-btn') || target === this.elements.modalOverlay) { this.ui.hideModal(); return; }
                        
                        if (target.closest('#modal-confirm-btn')) {
                            if (typeof this.ui._modalConfirmCallback === 'function') this.ui._modalConfirmCallback();
                            this.ui.hideModal();
                        } else if (target.closest('#apply-filters-btn')) {
                            this.state.filter.sort = document.getElementById('sort-select').value;
                            this.state.filter.city = document.getElementById('city-filter-input').value;
                            this.state.filter.minPrice = document.getElementById('min-price-filter').value;
                            this.state.filter.maxPrice = document.getElementById('max-price-filter').value;
                            this.state.filter.condition = document.getElementById('condition-filter').value;
                            this.views._updateFeedContent(); this.ui.hideModal();
                        } else if (target.closest('#reset-filters-btn')) {
                            this.state.filter = { query: this.state.filter.query, category: 'all', city: '', sort: 'newest', minPrice: '', maxPrice: '', condition: 'all' };
                            this.views._updateFeedContent(); this.ui.hideModal();
                        } else if (target.closest('#save-order-status-btn')) {
                            const orderId = target.dataset.orderId;
                            const newStatus = document.getElementById('order-status-select').value;
                            app.actions.handleOrderStatusChange(orderId, newStatus);
                        }
                    });

                    this.elements.lightbox.closeBtn.addEventListener('click', () => this.ui.hideLightbox());
                    this.elements.lightbox.overlay.addEventListener('click', (e) => {
                        if (e.target === this.elements.lightbox.overlay) this.ui.hideLightbox();
                    });
                }
            };
            
            app.init();
        }
    </script>
</body>
</html>
