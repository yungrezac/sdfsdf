<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TerraRun | Обновление</title>

    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ПОДКЛЮЧЕНИЕ YANDEX MAPS API -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=6559b722-5ab3-4376-b85c-ce2c99df7d46&lang=ru_RU" type="text/javascript"></script>

    <!-- Подключение Turf.js для гео-анализа -->
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    
    <!-- Подключение Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Подключение Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Подключение QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!-- Иконочные шрифты -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <!-- Шрифты Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f3f4f6;
            --secondary-bg-color: #ffffff;
            --text-color: #1f2937;
            --hint-color: #6b7280;
            --button-color: #3b82f6;
            --button-text-color: #ffffff;
            --destructive-color: #ef4444;
            --success-color: #22c55e;
            --star-color: #facc15;
            --border-color: #e5e7eb;
            --button-color-rgb: 59, 130, 246;
            --secondary-bg-color-rgb: 255, 255, 255;
        }

        /* Адаптация под безопасные зоны iOS */
        body {
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
        }

        body {
            overscroll-behavior: none;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Inter', sans-serif;
        }
        .mini-map, #detail-mini-map, #event-map-picker {
            z-index: 10;
            background-color: var(--bg-color);
        }
        
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .view {
            display: none;
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transition: opacity 0.3s ease-in-out;
            background-color: var(--bg-color);
            box-sizing: border-box;
        }
        
        #feed-view, #top-view, #profile-view, #teams-view {
            padding-bottom: calc(80px + 1rem + env(safe-area-inset-bottom));
        }

        .view.active {
            display: block;
        }
        .nav-btn.active i, .nav-btn.active span {
            color: var(--button-color);
        }
        .nav-btn span, .nav-btn i {
             color: var(--hint-color);
        }
        .card-bg {
            background-color: var(--secondary-bg-color);
        }
        #bottom-navbar {
            height: calc(80px + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
            background-color: rgba(var(--secondary-bg-color-rgb), 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .avatar-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 15px rgba(0,0,0,0.4);
            background-size: cover;
            background-position: center;
            transition: transform 0.2s ease-in-out, left 0.5s linear, top 0.5s linear;
        }
        .avatar-marker:hover {
            transform: scale(1.1);
        }
        .current-user-marker {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 2px 15px rgba(0,0,0,0.4), 0 0 0 0 rgba(var(--button-color-rgb), 0.7); }
            70% { box-shadow: 0 2px 15px rgba(0,0,0,0.4), 0 0 0 15px rgba(var(--button-color-rgb), 0); }
            100% { box-shadow: 0 2px 15px rgba(0,0,0,0.4), 0 0 0 0 rgba(var(--button-color-rgb), 0); }
        }
        .like-btn.liked i {
            color: var(--destructive-color);
            font-weight: 900; /* Solid heart */
        }
        #initial-loader {
            background-color: var(--bg-color);
        }
        #map-top-panel {
            position: fixed;
            top: calc(1rem + env(safe-area-inset-top));
            left: 0;
            right: 0;
            z-index: 20;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0 1rem;
            pointer-events: none;
        }
        #mode-switcher {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 9999px;
            padding: 0.25rem;
            display: flex;
            gap: 0.25rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            pointer-events: all;
        }
        #map-controls-right {
            pointer-events: all;
        }
        .mode-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--hint-color);
            transition: all 0.2s ease-in-out;
            border: none;
            background-color: transparent;
        }
        .mode-btn.active {
            background-color: var(--button-color);
            color: var(--button-text-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        #map-action-container {
            position: fixed;
            left: 0;
            right: 0;
            z-index: 20;
            display: flex;
            justify-content: center;
            pointer-events: none;
            bottom: calc(80px + 1rem + env(safe-area-inset-bottom));
            transition: bottom 0.3s ease-in-out;
        }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* FIX: Prevent background scroll when modal is open */
        body.modal-open .view.active {
            overflow-y: hidden;
        }

        .bottom-sheet-modal {
            align-items: flex-end;
        }
        .bottom-sheet-content {
            width: 100%;
            background-color: var(--secondary-bg-color);
            border-radius: 1.5rem 1.5rem 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.visible .bottom-sheet-content {
            transform: translateY(0);
        }
        .grabber {
            width: 3rem;
            height: 0.375rem;
            background-color: #d1d5db;
            border-radius: 9999px;
            margin: 0.75rem auto;
            flex-shrink: 0;
        }
        
        .profile-tab, .feed-tab, .top-tab {
            flex-grow: 1;
            text-align: center;
            padding: 0.75rem 0.5rem;
            font-weight: 600;
            color: var(--hint-color);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .profile-tab.active, .feed-tab.active, .top-tab.active {
            color: var(--button-color);
            border-bottom-color: var(--button-color);
        }
        .profile-tab-content, .feed-tab-content, .top-tab-content {
            display: none;
        }
        .profile-tab-content.active, .feed-tab-content.active, .top-tab-content.active {
            display: block;
        }
        
        #detail-comments-section, #event-comments-section {
            border-top: 1px solid var(--border-color);
        }
        #detail-comment-input-form, #event-comment-input-form {
            padding: 0.5rem 1rem 1rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--secondary-bg-color);
        }

        .skeleton {
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            animation: pulse-bg 1.5s infinite;
        }
        @keyframes pulse-bg {
            50% { background-color: #f0f3f8; }
        }
        
        .form-input, .form-textarea, .form-select {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--button-color);
            box-shadow: 0 0 0 2px rgba(var(--button-color-rgb), 0.2);
        }
        /* Стили для кастомного инпута даты-времени */
        .datetime-input-wrapper {
            position: relative;
        }
        .datetime-input-wrapper input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            color: transparent;
            background: transparent;
            cursor: pointer;
        }
    </style>
</head>
<body class="font-sans antialiased overflow-hidden">
    
    <!-- Начальный загрузчик -->
    <div id="initial-loader" class="fixed inset-0 flex flex-col items-center justify-center z-50">
        <svg class="animate-spin h-10 w-10 mb-4" style="color: var(--button-color);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p id="loader-text" class="text-lg font-semibold" style="color: var(--text-color);">Загрузка TerraRun...</p>
    </div>

    <!-- Экран-заглушка / Ошибка -->
    <div id="fallback-screen" class="fixed inset-0 flex items-center justify-center p-4 z-40 hidden">
        <div id="fallback-content" class="text-center card-bg p-8 rounded-2xl shadow-lg max-w-sm"></div>
    </div>

    <!-- Основной контейнер приложения -->
    <div id="app-container" class="hidden">
        <!-- Вид 1: Карта -->
        <div id="map-view" class="view active">
            <div id="map"></div>
            
            <div id="map-center-controls" class="fixed inset-0 z-20 flex justify-center items-center pointer-events-none hidden">
                <button id="request-geo-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg flex items-center gap-2 pointer-events-auto">
                    <i class="fa-solid fa-location-arrow h-5 w-5"></i>
                    <span id="request-geo-text">Дать доступ к гео</span>
                    <svg id="request-geo-loader" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>
            
            <div id="map-top-panel">
                <div class="w-12"></div>
                <div class="flex-grow flex justify-center">
                     <div id="mode-switcher" class="hidden">
                         <button id="mode-capture" class="mode-btn active">Захват</button>
                         <button id="mode-spots" class="mode-btn">Споты</button>
                         <button id="mode-routes" class="mode-btn">Маршруты</button>
                     </div>
                </div>
                <div id="map-controls-right" class="flex flex-col items-end gap-2">
                    <button id="recenter-btn" class="hidden bg-white/80 backdrop-blur-md p-3 rounded-full shadow-lg pointer-events-all">
                        <i class="fa-solid fa-location-crosshairs h-6 w-6 text-gray-700"></i>
                    </button>
                </div>
            </div>
            
            <div id="map-action-container" class="hidden">
                <button id="map-action-btn" class="text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 flex items-center gap-2 pointer-events-auto">
                    <i id="map-action-icon" class="fa-solid fa-play h-5 w-5"></i>
                    <span id="map-action-text"></span>
                </button>
            </div>
        </div>

        <!-- Вид 2: Лента -->
        <div id="feed-view" class="view p-4 fade-in">
            <div class="flex justify-between items-center mb-4 px-2">
                <h1 class="text-3xl font-bold">Лента</h1>
                <button id="feed-create-btn" class="p-2 rounded-full hover:bg-gray-200" style="background-color: var(--secondary-bg-color);">
                    <i class="fa-solid fa-plus h-7 w-7" style="color: var(--button-color);"></i>
                </button>
            </div>
            
            <div class="flex border-b sticky top-0 z-10 overflow-x-auto" style="background-color: var(--bg-color);">
                <div id="feed-tab-posts" class="feed-tab active" onclick="switchFeedTab('posts')">Посты</div>
                <div id="feed-tab-events" class="feed-tab" onclick="switchFeedTab('events')">Покатушки</div>
                <div id="feed-tab-spots" class="feed-tab" onclick="switchFeedTab('spots')">Споты</div>
                <div id="feed-tab-routes" class="feed-tab" onclick="switchFeedTab('routes')">Маршруты</div>
            </div>

            <div id="feed-content-posts" class="feed-tab-content active mt-4 space-y-4"></div>
            <div id="feed-content-events" class="feed-tab-content mt-4 space-y-4"></div>
            <div id="feed-content-spots" class="feed-tab-content mt-4 space-y-4"></div>
            <div id="feed-content-routes" class="feed-tab-content mt-4 space-y-4"></div>
        </div>

        <!-- Вид 3: Топ пользователей -->
        <div id="top-view" class="view p-4 fade-in">
            <div class="flex justify-between items-center mb-4 px-2">
                <h1 class="text-3xl font-bold">Рейтинги</h1>
                <button id="scan-qr-btn" class="p-2 rounded-full hover:bg-gray-200" style="background-color: var(--secondary-bg-color);">
                    <i class="fa-solid fa-qrcode h-7 w-7" style="color: var(--hint-color);"></i>
                </button>
            </div>
            <!-- NEW: Табы для рейтинга -->
            <div class="flex border-b sticky top-0 z-10" style="background-color: var(--bg-color);">
                <div id="top-tab-users" class="top-tab active" onclick="switchTopTab('users')">Игроки</div>
                <div id="top-tab-teams" class="top-tab" onclick="switchTopTab('teams')">Команды</div>
            </div>
            <div id="top-content-users" class="top-tab-content active mt-4 space-y-3"></div>
            <div id="top-content-teams" class="top-tab-content mt-4 space-y-3"></div>
        </div>

        <!-- NEW: Вид 4: Команды -->
        <div id="teams-view" class="view p-4 fade-in">
            <div class="flex justify-between items-center mb-6 px-2">
                <h1 class="text-3xl font-bold">Команды</h1>
                <button id="team-create-btn" class="p-2 rounded-full hover:bg-gray-200" style="background-color: var(--secondary-bg-color);">
                    <i class="fa-solid fa-plus h-7 w-7" style="color: var(--button-color);"></i>
                </button>
            </div>
            <div id="teams-list" class="space-y-3"></div>
        </div>


        <!-- Вид 5: Профиль -->
        <div id="profile-view" class="view p-4 fade-in">
            <h1 class="text-3xl font-bold mb-6 px-2">Профиль</h1>
            <div class="card-bg rounded-2xl shadow-lg p-6 flex flex-col items-center space-y-4">
                <div id="profile-avatar-wrapper" class="w-24 h-24 rounded-full border-4 flex-shrink-0">
                    <img src="https://placehold.co/96x96/E2E8F0/4A5568?text=?" id="profile-avatar-img" class="w-full h-full rounded-full object-cover" alt="avatar">
                </div>
                <div class="text-center">
                    <h2 id="profile-name" class="text-2xl font-bold">Загрузка...</h2>
                    <!-- NEW: Отображение команды -->
                    <div id="profile-team-badge" class="mt-2 cursor-pointer"></div>
                    <p class="text-sm mt-2" style="color: var(--hint-color);">Общая площадь</p>
                    <p id="profile-area" class="text-3xl font-bold" style="color: var(--button-color);">0 м²</p>
                </div>
                <div class="w-full pt-4 mt-4 border-t" style="border-color: var(--border-color);">
                    <div class="flex justify-center gap-8 w-full">
                        <button id="share-profile-btn" class="flex flex-col items-center space-y-1 transition-opacity hover:opacity-70">
                            <div class="p-3 rounded-full" style="background-color: rgba(var(--button-color-rgb), 0.15);"><i class="fa-solid fa-arrow-up-from-bracket h-6 w-6" style="color: var(--button-color);"></i></div>
                            <span class="text-xs font-medium" style="color: var(--hint-color);">Поделиться</span>
                        </button>
                        <button id="show-qr-btn" class="flex flex-col items-center space-y-1 transition-opacity hover:opacity-70">
                            <div class="p-3 rounded-full" style="background-color: rgba(var(--button-color-rgb), 0.15);"><i class="fa-solid fa-qrcode h-6 w-6" style="color: var(--button-color);"></i></div>
                            <span class="text-xs font-medium" style="color: var(--hint-color);">Мой QR</span>
                        </button>
                    </div>
                </div>
            </div>
             <!-- Табы -->
            <div class="flex border-b mt-6 sticky top-0 z-10" style="background-color: var(--bg-color);">
                <div id="profile-tab-posts" class="profile-tab active" onclick="switchMainProfileTab('posts')">Посты</div>
                <div id="profile-tab-events" class="profile-tab" onclick="switchMainProfileTab('events')">Покатушки</div>
                <div id="profile-tab-spots" class="profile-tab" onclick="switchMainProfileTab('spots')">Споты</div>
                <div id="profile-tab-routes" class="profile-tab" onclick="switchMainProfileTab('routes')">Маршруты</div>
            </div>

            <div id="profile-content-posts" class="profile-tab-content active mt-4 space-y-4"></div>
            <div id="profile-content-events" class="profile-tab-content mt-4 space-y-4"></div>
            <div id="profile-content-spots" class="profile-tab-content mt-4 space-y-4"></div>
            <div id="profile-content-routes" class="profile-tab-content mt-4 space-y-4"></div>
        </div>
    </div>

    <!-- Нижний навбар -->
    <nav id="bottom-navbar" class="hidden fixed bottom-0 left-0 right-0 flex justify-around items-center z-20">
        <button class="nav-btn active flex flex-col items-center space-y-1 transition-transform transform hover:scale-110" onclick="showView('map-view')"><i class="fa-solid fa-map-location-dot h-7 w-7"></i><span>Карта</span></button>
        <button class="nav-btn flex flex-col items-center space-y-1 transition-transform transform hover:scale-110" onclick="showView('feed-view')"><i class="fa-solid fa-newspaper h-7 w-7"></i><span>Лента</span></button>
        <button class="nav-btn flex flex-col items-center space-y-1 transition-transform transform hover:scale-110" onclick="showView('top-view')"><i class="fa-solid fa-ranking-star h-7 w-7"></i><span>Рейтинг</span></button>
        <!-- NEW: Кнопка Команды -->
        <button class="nav-btn flex flex-col items-center space-y-1 transition-transform transform hover:scale-110" onclick="showView('teams-view')"><i class="fa-solid fa-users h-7 w-7"></i><span>Команды</span></button>
        <button class="nav-btn flex flex-col items-center space-y-1 transition-transform transform hover:scale-110" onclick="showView('profile-view')"><i class="fa-solid fa-user h-7 w-7"></i><span>Профиль</span></button>
    </nav>
    
    <!-- Модальное окно создания простого поста -->
    <div id="simple-post-modal" class="modal-overlay bottom-sheet-modal" onclick="if(event.target === this) hideSimplePostModal()">
        <div id="simple-post-content" class="bottom-sheet-content" style="height: auto; max-height: 90vh;">
            <div class="grabber" onclick="hideSimplePostModal()"></div>
            <div class="p-4 space-y-4 flex flex-col flex-grow">
                <div class="flex justify-between items-center flex-shrink-0">
                    <h2 class="text-2xl font-bold">Новый пост</h2>
                    <button onclick="hideSimplePostModal()" class="p-2 rounded-full hover:bg-gray-200"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto space-y-4">
                    <p style="color: var(--hint-color);">Поделитесь своими мыслями с сообществом.</p>
                    <textarea id="simple-post-details" class="form-textarea mt-1 block w-full" rows="4" placeholder="Что у вас нового?"></textarea>
                    <div id="simple-post-filename" class="text-sm text-gray-500 truncate"></div>
                </div>
                <div class="flex justify-between items-center pt-4 flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <button id="simple-post-gallery-btn" class="cursor-pointer p-2 rounded-full hover:bg-gray-200">
                            <i class="fa-solid fa-images h-7 w-7" style="color: var(--hint-color);"></i>
                        </button>
                        <button id="simple-post-camera-btn" class="cursor-pointer p-2 rounded-full hover:bg-gray-200">
                            <i class="fa-solid fa-camera h-7 w-7" style="color: var(--hint-color);"></i>
                        </button>
                    </div>
                    <button onclick="handleSimplePostSave()" class="text-white font-bold py-2 px-6 rounded-full transition-all" style="background-color: var(--button-color);">Опубликовать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно создания Спота/Маршрута/Поста (захват) -->
    <div id="creation-modal" class="modal-overlay bottom-sheet-modal" onclick="if(event.target === this) hideCreationModal()">
        <div class="bottom-sheet-content" style="height: 75%; max-height: calc(100vh - env(safe-area-inset-top) - 1rem);">
            <div class="grabber" onclick="hideCreationModal()"></div>
            <div id="creation-modal-body" class="flex-grow overflow-y-auto p-4 space-y-4">
                <h2 id="creation-modal-title" class="text-2xl font-bold"></h2>
                <p id="creation-modal-description" style="color: var(--hint-color);"></p>
                <div>
                    <label for="creation-modal-name" class="block text-sm font-medium mb-1">Название</label>
                    <input type="text" id="creation-modal-name" class="form-input w-full" placeholder="Например, 'Красивый вид'">
                </div>
                <div id="creation-modal-details-section">
                    <label for="creation-modal-details" class="block text-sm font-medium mb-1">Описание</label>
                    <textarea id="creation-modal-details" rows="3" class="form-textarea w-full" placeholder="Опишите это место или маршрут..."></textarea>
                </div>
                <div id="creation-modal-photo-section">
                    <label class="block text-sm font-medium mb-1">Фото</label>
                    <div class="mt-1">
                        <img id="creation-modal-photo-preview" src="" alt="Предпросмотр фото" class="hidden w-full h-auto mb-4 rounded-lg object-cover max-h-48">
                        <div class="flex gap-3">
                            <button id="creation-gallery-btn" class="w-full flex items-center justify-center gap-2 p-3 rounded-xl" style="background-color: var(--bg-color); color: var(--text-color);">
                                <i class="fa-solid fa-images"></i>
                                <span>Из галереи</span>
                            </button>
                            <button id="creation-camera-btn" class="w-full flex items-center justify-center gap-2 p-3 rounded-xl text-white" style="background-color: var(--button-color);">
                                <i class="fa-solid fa-camera"></i>
                                <span>Сделать снимок</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button onclick="hideCreationModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-all">Отмена</button>
                    <button id="save-creation-btn" class="text-white font-bold py-2 px-4 rounded-full transition-all" style="background-color: var(--button-color);">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно создания Покатушки (Мероприятия) -->
    <div id="event-creation-modal" class="modal-overlay bottom-sheet-modal" onclick="if(event.target === this) hideEventCreationModal()">
        <div class="bottom-sheet-content" style="height: 90%; max-height: calc(100vh - env(safe-area-inset-top) - 1rem);">
            <div class="grabber" onclick="hideEventCreationModal()"></div>
            <div class="p-4 flex-shrink-0">
                 <h2 class="text-2xl font-bold">Новое мероприятие</h2>
            </div>
            <div id="event-creation-modal-body" class="flex-grow overflow-y-auto p-4 space-y-4">
                <div>
                    <label for="event-title" class="block text-sm font-medium mb-1">Название</label>
                    <input type="text" id="event-title" class="form-input" placeholder="Вечерний прохват">
                </div>
                <div>
                    <label for="event-description" class="block text-sm font-medium mb-1">Описание</label>
                    <textarea id="event-description" rows="3" class="form-textarea" placeholder="Собираемся, общаемся, катаемся!"></textarea>
                </div>
                <div>
                    <label for="event-datetime" class="block text-sm font-medium mb-1">Дата и время</label>
                    <div class="datetime-input-wrapper">
                        <input type="datetime-local" id="event-datetime" class="form-input">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Точка сбора</label>
                    <div id="event-map-picker" class="h-48 w-full rounded-lg bg-gray-200 mt-1"></div>
                    <p id="event-map-hint" class="text-xs text-gray-500 mt-1">Кликните на карту, чтобы выбрать точку сбора.</p>
                </div>
                <div>
                    <label for="event-route-select" class="block text-sm font-medium mb-1">Маршрут (необязательно)</label>
                    <select id="event-route-select" class="form-select"></select>
                </div>
            </div>
            <div class="p-4 flex-shrink-0 border-t" style="border-color: var(--border-color);">
                 <button onclick="handleEventSave()" class="w-full text-white font-bold py-3 px-6 rounded-full transition-all" style="background-color: var(--button-color);">Создать мероприятие</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно деталей (универсальное) -->
    <div id="detail-modal" class="modal-overlay bottom-sheet-modal" onclick="if(event.target === this) hideDetailModal()">
        <div class="bottom-sheet-content" style="height: 90%; max-height: calc(100vh - env(safe-area-inset-top) - 1rem);">
            <div class="grabber" onclick="hideDetailModal()"></div>
            <div id="detail-modal-body" class="flex-grow overflow-y-auto"></div>
        </div>
    </div>

    <!-- Модальное окно с комментариями (ДЛЯ ПОСТОВ) -->
    <div id="comments-modal" class="modal-overlay bottom-sheet-modal" onclick="if(event.target === this) hideCommentsModal()">
        <div class="bottom-sheet-content" style="height: 75%;">
             <div class="grabber" onclick="hideCommentsModal()"></div>
             <h2 id="comments-modal-title" class="text-xl font-bold px-4 pb-2 flex-shrink-0">Комментарии</h2>
            <div id="comments-modal-body" class="flex-grow overflow-y-auto p-4"></div>
            <div id="comment-input-container" class="flex-shrink-0 p-2 border-t" style="background-color: var(--secondary-bg-color); border-color: var(--border-color);">
                <div id="reply-indicator" class="hidden text-xs px-2 pb-1 flex justify-between items-center" style="color: var(--hint-color);">
                    <span id="reply-indicator-text"></span>
                    <button onclick="cancelReply()" class="font-bold text-xl">&times;</button>
                </div>
                <div class="flex items-center space-x-2">
                    <textarea id="main-comment-input" class="form-textarea w-full" rows="1" placeholder="Написать комментарий..."></textarea>
                    <button id="main-comment-send-btn" onclick="postComment()" class="flex-shrink-0 text-white rounded-full p-2 hover:opacity-80 disabled:opacity-50" style="background-color: var(--button-color);">
                        <i class="fa-solid fa-paper-plane h-6 w-6"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно списка участников -->
    <div id="participants-modal" class="modal-overlay bottom-sheet-modal" onclick="if(event.target === this) hideParticipantsModal()">
        <div class="bottom-sheet-content" style="height: 75%;">
            <div class="grabber" onclick="hideParticipantsModal()"></div>
            <h2 id="participants-modal-title" class="text-xl font-bold px-4 pb-2 flex-shrink-0">Участники</h2>
            <div id="participants-modal-body" class="flex-grow overflow-y-auto p-4 space-y-3"></div>
        </div>
    </div>

    <!-- Модальное окно для QR-кода -->
    <div id="qr-modal" class="modal-overlay justify-center items-center p-4" onclick="if(event.target === this) hideQrModal()">
        <div class="card-bg rounded-2xl shadow-2xl p-6 w-full max-w-xs fade-in space-y-4 flex flex-col items-center">
            <h2 class="text-2xl font-bold">Мой QR-код</h2>
            <div id="qrcode" class="p-2 bg-white rounded-lg"></div>
            <p class="text-center text-sm" style="color: var(--hint-color);">Покажите этот код другу, чтобы он отсканировал его в приложении.</p>
            <button onclick="hideQrModal()" class="w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-all">Закрыть</button>
        </div>
    </div>
    
    <!-- NEW: Модальное окно создания Команды -->
    <div id="team-creation-modal" class="modal-overlay bottom-sheet-modal" onclick="if(event.target === this) hideTeamCreationModal()">
        <div class="bottom-sheet-content" style="height: auto; max-height: 90vh;">
            <div class="grabber" onclick="hideTeamCreationModal()"></div>
            <div class="p-4 flex-shrink-0">
                 <h2 class="text-2xl font-bold">Новая команда</h2>
            </div>
            <div class="flex-grow overflow-y-auto p-4 space-y-4">
                <div>
                    <label for="team-name" class="block text-sm font-medium mb-1">Название команды</label>
                    <input type="text" id="team-name" class="form-input" placeholder="Например, 'Ночные Бегуны'">
                </div>
                <div>
                    <label for="team-description" class="block text-sm font-medium mb-1">Описание</label>
                    <textarea id="team-description" rows="2" class="form-textarea" placeholder="Кратко опишите вашу команду"></textarea>
                </div>
                 <div>
                    <label for="team-color" class="block text-sm font-medium mb-1">Цвет команды</label>
                    <input type="color" id="team-color" class="form-input h-12 p-1">
                </div>
            </div>
            <div class="p-4 flex-shrink-0 border-t" style="border-color: var(--border-color);">
                 <button onclick="handleTeamSave()" class="w-full text-white font-bold py-3 px-6 rounded-full transition-all" style="background-color: var(--button-color);">Создать команду</button>
            </div>
        </div>
    </div>

    <input id="gallery-input" type="file" class="sr-only" accept="image/*">
    <input id="camera-input" type="file" class="sr-only" accept="image/*" capture="user">


    <script type="module">
        // --- КОНФИГУРАЦИЯ И КОНСТАНТЫ ---
        const SUPABASE_URL = 'https://jsnahjtoqwuwbjdmisuj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzbmFoanRvcXd1d2JqZG1pc3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzOTQxMDQsImV4cCI6MjA2ODk3MDEwNH0.M3TWsNJppj1f-Cmj6nGCAUswy1HZgBLW8yJZfTwkrpI';
        const BOT_USERNAME = 'TerraRunBot';
        const FEED_PAGE_SIZE = 10; // Количество постов на страницу для пагинации

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И СОСТОЯНИЕ ---
        const tg = window.Telegram.WebApp;
        let map;
        let eventPickerMap; // Карта для выбора точки сбора
        let supabase;
        let telegramUser = null;
        let locationWatchId = null;
        let scrollToPostId = null; 
        let countdownTimers = []; // Массив для хранения интервалов таймеров
        let spotClusterer; // NEW: Кластеризатор для спотов

        const AppState = {
            currentMapMode: 'capture', // 'capture', 'spots', 'routes'
            currentFeedTab: 'posts', // 'posts', 'events', 'spots', 'routes'
            currentTopTab: 'users', // 'users', 'teams'
            isRunning: false,
            lastKnownLocation: null,
            userProfile: {
                id: null, name: '', color: '#3b82f6', territory: null, photo_url: null, area: 0, team_id: null, teams: null
            },
            currentRunPath: [],
            currentPathPolyline: null,
            currentUserMarker: null,
            allUserLayers: {},
            allSpots: [],
            allRoutes: [],
            allEvents: [],
            allProfilesData: [],
            allTeamsData: [], // NEW
            currentEditContext: {},
            currentDetailContext: {},
            currentReplyTarget: { type: null, id: null, parentCommentId: null },
            photoContext: null,
            simplePostContext: {},
            eventCreationContext: {},
            feedPagination: { // NEW: Состояние пагинации
                posts: { page: 0, loading: false, finished: false },
                events: { page: 0, loading: false, finished: false },
                spots: { page: 0, loading: false, finished: false },
                routes: { page: 0, loading: false, finished: false },
            },
            intersectionObserver: null, // NEW: Наблюдатель для пагинации
        };
        
        let territoriesCollection, spotCollection, routeCollection, eventCollection;
        
        // --- ЭЛЕМЕНТЫ DOM ---
        const initialLoader = document.getElementById('initial-loader');
        const loaderText = document.getElementById('loader-text');
        const fallbackScreen = document.getElementById('fallback-screen');
        const fallbackContent = document.getElementById('fallback-content');
        const appContainer = document.getElementById('app-container');
        const bottomNavbar = document.getElementById('bottom-navbar');
        const modeSwitcher = document.getElementById('mode-switcher');
        const feedCreateBtn = document.getElementById('feed-create-btn');
        
        // Модальные окна
        const detailModal = document.getElementById('detail-modal');
        const commentsModal = document.getElementById('comments-modal');
        const simplePostModal = document.getElementById('simple-post-modal');
        const creationModal = document.getElementById('creation-modal');
        const qrModal = document.getElementById('qr-modal');
        const eventCreationModal = document.getElementById('event-creation-modal');
        const participantsModal = document.getElementById('participants-modal');
        const teamCreationModal = document.getElementById('team-creation-modal'); // NEW

        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---
        
        function shadeColor(color, percent) {
            if (!color || !color.startsWith('#')) return '#e5e7eb'; 
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);
            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);
            R = (R < 255) ? R : 255;
            G = (G < 255) ? G : 255;
            B = (B < 255) ? B : 255;
            R = (R > 0) ? R : 0;
            G = (G > 0) ? G : 0;
            B = (B > 0) ? B : 0;
            const RR = ((R.toString(16).length === 1) ? "0" + R.toString(16) : R.toString(16));
            const GG = ((G.toString(16).length === 1) ? "0" + G.toString(16) : G.toString(16));
            const BB = ((B.toString(16).length === 1) ? "0" + B.toString(16) : B.toString(16));
            return "#" + RR + GG + BB;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : null;
        }

        function shareContent(type, id, ownerId) {
            tg.HapticFeedback.impactOccurred('light');
            const isOwner = telegramUser && ownerId.toString() === telegramUser.id.toString();
            let text = '';
            switch (type) {
                case 'post': text = isOwner ? 'Оцени мой пост в TerraRun!' : 'Смотри какой интересный пост в TerraRun!'; break;
                case 'route': text = isOwner ? 'Зацени мой маршрут в TerraRun!' : 'Смотри какой интересный маршрут в TerraRun!'; break;
                case 'spot': text = isOwner ? 'Смотри какой интересный спот в TerraRun!' : 'Смотри какой интересный спот в TerraRun!'; break;
                case 'event': text = isOwner ? 'Присоединяйся к моей покатушке в TerraRun!' : 'Смотри, какая покатушка намечается в TerraRun!'; break;
                case 'user': text = isOwner ? 'Это мой профиль в TerraRun, присоединяйся!' : 'Смотри профиль этого бегуна в TerraRun!'; break;
                case 'team': text = 'Присоединяйся к нашей команде в TerraRun!'; break;
            }
            const url = `https://t.me/${BOT_USERNAME}/app?startapp=${type}_${id}`;
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`);
        }

        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        // --- ФУНКЦИИ UI ---
        function showView(viewId) {
            tg.HapticFeedback.selectionChanged();
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="showView('${viewId}')"]`).classList.add('active');
            
            const isMapView = viewId === 'map-view';
            
            if (isMapView && AppState.lastKnownLocation) {
                mapActionContainer.classList.remove('hidden');
            } else {
                mapActionContainer.classList.add('hidden');
            }
            modeSwitcher.classList.toggle('hidden', !isMapView || !AppState.lastKnownLocation);
            
            if (isMapView) {
                setTimeout(() => map?.container.fitToViewport(), 100);
            }
        }
        
        // Переключение табов в ленте
        function switchFeedTab(tabName) {
            if (AppState.currentFeedTab === tabName) return;
            tg.HapticFeedback.selectionChanged();
            AppState.currentFeedTab = tabName;

            document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.feed-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`feed-tab-${tabName}`).classList.add('active');
            const contentContainer = document.getElementById(`feed-content-${tabName}`);
            contentContainer.classList.add('active');

            // Обновляем видимость и назначение кнопки создания
            const createIcon = feedCreateBtn.querySelector('i');
            if (tabName === 'posts') {
                feedCreateBtn.classList.remove('hidden');
                feedCreateBtn.onclick = showSimplePostModal;
                createIcon.className = 'fa-solid fa-plus h-7 w-7';
            } else if (tabName === 'events') {
                feedCreateBtn.classList.remove('hidden');
                feedCreateBtn.onclick = showEventCreationModal;
                createIcon.className = 'fa-solid fa-calendar-plus h-7 w-7';
            } else { // Для 'spots' и 'routes'
                feedCreateBtn.classList.add('hidden');
            }
            
            // Сбрасываем и загружаем контент для нового таба
            resetAndLoadFeed(tabName);
        }
        
        // NEW: Переключение табов в рейтинге
        function switchTopTab(tabName) {
            if (AppState.currentTopTab === tabName) return;
            tg.HapticFeedback.selectionChanged();
            AppState.currentTopTab = tabName;

            document.querySelectorAll('.top-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.top-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`top-tab-${tabName}`).classList.add('active');
            document.getElementById(`top-content-${tabName}`).classList.add('active');

            if (tabName === 'users') {
                renderLeaderboard(AppState.allProfilesData);
            } else if (tabName === 'teams') {
                renderTeamLeaderboard(AppState.allTeamsData);
            }
        }

        async function setMapMode(newMode) {
            if (AppState.currentMapMode === newMode || !map) return;
            
            if (AppState.isRunning) {
                showCustomAlert("Сначала завершите текущую активность (захват или запись маршрута).");
                return;
            }
            tg.HapticFeedback.selectionChanged();
            AppState.currentMapMode = newMode;
            
            tg.CloudStorage.setItem('currentMapMode', newMode);

            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.id === `mode-${newMode}`);
            });

            map.events.remove('click', handleMapClickForSpot);

            territoriesCollection.options.set('visible', newMode === 'capture');
            spotClusterer.options.set('visible', newMode === 'spots'); // Управляем видимостью кластеризатора
            routeCollection.options.set('visible', newMode === 'routes');
            
            if (newMode === 'spots') {
                map.events.add('click', handleMapClickForSpot);
            }

            updateMapActionButton();
        }

        function updateMapActionButton() {
            const icon = document.getElementById('map-action-icon');
            const text = document.getElementById('map-action-text');

            if (!AppState.lastKnownLocation) {
                mapActionContainer.classList.add('hidden');
                return;
            }
            
            mapActionContainer.classList.remove('hidden');

            switch (AppState.currentMapMode) {
                case 'capture':
                    if (AppState.isRunning) {
                        text.textContent = "Остановить захват";
                        mapActionBtn.style.backgroundColor = 'var(--destructive-color)';
                        icon.className = 'fa-solid fa-stop h-5 w-5';
                    } else {
                        text.textContent = "Начать захват";
                        mapActionBtn.style.backgroundColor = 'var(--button-color)';
                        icon.className = 'fa-solid fa-play h-5 w-5';
                    }
                    break;
                case 'spots':
                    text.textContent = "Добавить спот здесь";
                    mapActionBtn.style.backgroundColor = 'var(--success-color)';
                    icon.className = 'fa-solid fa-location-dot h-5 w-5';
                    break;
                case 'routes':
                    if (AppState.isRunning) {
                        text.textContent = "Завершить маршрут";
                        mapActionBtn.style.backgroundColor = 'var(--destructive-color)';
                        icon.className = 'fa-solid fa-stop h-5 w-5';
                    } else {
                        text.textContent = "Начать запись маршрута";
                        mapActionBtn.style.backgroundColor = 'var(--button-color)';
                        icon.className = 'fa-solid fa-route h-5 w-5';
                    }
                    break;
            }
        }
        
        async function mapActionButtonHandler() {
            mapActionBtn.disabled = true; 
            try {
                switch (AppState.currentMapMode) {
                    case 'capture':
                        AppState.isRunning ? await stopRun() : startRun();
                        break;
                    case 'spots':
                        if(AppState.lastKnownLocation) {
                            handleMapClickForSpot({ get: (key) => key === 'coords' ? AppState.lastKnownLocation : null });
                        } else {
                            showCustomAlert("Определяем ваше местоположение...");
                        }
                        break;
                    case 'routes':
                        AppState.isRunning ? await stopRouteRecording() : startRouteRecording();
                        break;
                }
            } finally {
                mapActionBtn.disabled = false;
            }
        }
        
        function generateColorFromId(id) {
            const strId = String(id);
            let hash = 0;
            for (let i = 0; i < strId.length; i++) {
                hash = strId.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = hash % 360;
            return `hsl(${h}, 80%, 65%)`;
        }
        
        // --- ОСНОВНАЯ ЛОГИКА И ИНИЦИАЛИЗАЦИЯ ---
        async function runApp() {
            try {
                tg.ready();
                tg.expand();
                tg.enableClosingConfirmation();
                applyTheme(tg.themeParams);
                setupStaticEventListeners();

                if (!tg.initDataUnsafe?.user) {
                    showFallbackScreen('Требуется Telegram', 'Это приложение предназначено для работы исключительно внутри Telegram.', false);
                    return;
                }
                telegramUser = tg.initDataUnsafe.user;
                
                loaderText.textContent = 'Подключение к базе данных...';
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                loaderText.textContent = 'Инициализация карты...';
                await ymaps.ready();
                initMap({ latitude: 55.751244, longitude: 37.618423 });
                
                loaderText.textContent = 'Загрузка профиля...';
                await upsertUserProfile();
                updateUI();
                
                loaderText.textContent = 'Загрузка данных...';
                await Promise.all([
                    fetchAllInitialData(),
                    renderMyProfileContent(),
                ]);

                listenToRealtimeChanges();
                setupDynamicEventListeners();
                initializeGeolocation();
                handleStartParam();

                initialLoader.classList.add('hidden');
                appContainer.classList.remove('hidden');
                bottomNavbar.classList.remove('hidden');
                
                tg.CloudStorage.getItem('currentMapMode', (error, value) => {
                    if (error) {
                        console.error("CloudStorage error:", error);
                        setMapMode('capture');
                        return;
                    }
                    setMapMode(value || 'capture');
                });
                
                // Инициализация первой вкладки ленты
                resetAndLoadFeed(AppState.currentFeedTab);

            } catch (error) {
                console.error("Критическая ошибка инициализации:", error);
                let message = error.message || "Не удалось запустить приложение. Пожалуйста, попробуйте перезагрузить его.";
                showFallbackScreen("Ошибка инициализации", message, true);
            }
        }

        function initMap(coords) {
            if (map) return;
            const latLng = [coords.latitude, coords.longitude];
            map = new ymaps.Map('map', { 
                center: latLng, 
                zoom: 5,
                controls: []
            });
            
            territoriesCollection = new ymaps.GeoObjectCollection();
            spotCollection = new ymaps.GeoObjectCollection(); // Споты будут добавляться в кластеризатор
            routeCollection = new ymaps.GeoObjectCollection();
            eventCollection = new ymaps.GeoObjectCollection();

            // NEW: Создаем кластеризатор для спотов
            spotClusterer = new ymaps.Clusterer({
                preset: 'islands#violetClusterIcons',
                groupByCoordinates: false,
                clusterDisableClickZoom: true,
                clusterHideIconOnBalloonOpen: false,
                geoObjectHideIconOnBalloonOpen: false
            });
            
            map.geoObjects.add(territoriesCollection);
            map.geoObjects.add(spotClusterer); // Добавляем кластеризатор на карту
            map.geoObjects.add(routeCollection);
            map.geoObjects.add(eventCollection);
            
            setTimeout(() => map?.container.fitToViewport(), 100);
        }

        function updateUI() {
            const name = escapeHTML(telegramUser.first_name);
            document.getElementById('profile-name').textContent = name;
            
            if (telegramUser.photo_url) {
                document.getElementById('profile-avatar-img').src = telegramUser.photo_url;
            } else {
                const initial = name.charAt(0).toUpperCase();
                document.getElementById('profile-avatar-img').src = `https://placehold.co/96x96/E2E8F0/4A5568?text=${initial}`;
            }
            document.getElementById('profile-avatar-wrapper').style.borderColor = AppState.userProfile.color;
            updateMapActionButton();
            refreshAllStats();
            renderMyProfileContent();
            updateProfileTeamBadge();
        }
        
        // --- ЛОГИКА ГЕОЛОКАЦИИ (без изменений) ---
        async function initializeGeolocation() {
             if (!navigator.geolocation) {
                 showCustomAlert("Геолокация не поддерживается вашим устройством.");
                 return;
             }
             try {
                 const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                 const handlePermissionChange = () => {
                     if (permissionStatus.state === 'granted') {
                         startGeoTracking();
                     } else {
                         AppState.lastKnownLocation = null;
                         mapActionContainer.classList.add('hidden');
                         modeSwitcher.classList.add('hidden');
                         document.getElementById('map-center-controls').classList.remove('hidden');
                     }
                 };
                 permissionStatus.onchange = handlePermissionChange;
                 handlePermissionChange();
             } catch (e) {
                 console.warn("API разрешений не поддерживается, используем старый метод.", e);
                 document.getElementById('map-center-controls').classList.remove('hidden');
             }
        }
        function handleGeoRequest() {
             const geoLoader = document.getElementById('request-geo-loader');
             const geoText = document.getElementById('request-geo-text');
             geoText.textContent = 'Ждем ответа...';
             geoLoader.classList.remove('hidden');
             document.getElementById('request-geo-btn').disabled = true;
             startGeoTracking();
        }
        function startGeoTracking() {
              navigator.geolocation.getCurrentPosition(
                 (position) => {
                     tg.HapticFeedback.notificationOccurred('success');
                     const latLng = [position.coords.latitude, position.coords.longitude];
                     if (!AppState.lastKnownLocation) {
                         map.panTo(latLng, {flying: true, duration: 1500}).then(() => map.setZoom(16));
                     }
                     AppState.lastKnownLocation = latLng;
                     
                     updateCurrentUserMarker(latLng);
                     document.getElementById('map-center-controls').classList.add('hidden');
                     document.getElementById('recenter-btn').classList.remove('hidden');
                     modeSwitcher.classList.remove('hidden');
                     mapActionContainer.classList.remove('hidden');
                     
                     updateMapActionButton();
                     startWatchingLocation();
                 },
                 (error) => {
                     tg.HapticFeedback.notificationOccurred('error');
                     console.error("Geolocation error:", error);
                     showCustomAlert("Не удалось получить геолокацию. Проверьте разрешения в настройках вашего устройства.");
                     const geoText = document.getElementById('request-geo-text');
                     const geoLoader = document.getElementById('request-geo-loader');
                     geoText.textContent = 'Дать доступ к гео';
                     geoLoader.classList.add('hidden');
                     document.getElementById('request-geo-btn').disabled = false;
                 },
                 { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
             );
        }
        function startWatchingLocation() {
             if (locationWatchId) {
                 navigator.geolocation.clearWatch(locationWatchId);
             }
             locationWatchId = navigator.geolocation.watchPosition(
                 (position) => {
                     const latLng = [position.coords.latitude, position.coords.longitude];
                     AppState.lastKnownLocation = latLng;
                     updateCurrentUserMarker(latLng);

                     if (AppState.isRunning && AppState.currentPathPolyline) {
                         const newPoint = [latLng[1], latLng[0]]; // lng, lat для Turf.js
                         AppState.currentRunPath.push(newPoint);
                         AppState.currentPathPolyline.geometry.append(latLng);
                     }
                 },
                 (error) => {
                     console.warn("Ошибка отслеживания геолокации:", error.message);
                 },
                 { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
             );
        }
        
        // --- ЗАГРУЗКА ДАННЫХ ---
        async function fetchAllInitialData() {
            const [profiles, spots, routes, events, teams] = await Promise.all([
                supabase.from('profiles').select('*, team_id, teams(*), territory_wkt:territory::text'),
                supabase.from('spots').select('*, location_wkt:location::text'),
                supabase.from('routes').select('*, path_wkt:path::text'),
                supabase.from('events').select('*, meeting_point_wkt:meeting_point::text'),
                supabase.rpc('get_team_stats') // NEW: Загружаем статистику команд
            ]);

            if (profiles.error) console.error("Error fetching profiles:", profiles.error);
            else {
                AppState.allProfilesData = profiles.data;
                drawAllTerritories();
                renderLeaderboard(profiles.data);
            }
            
            if (teams.error) console.error("Error fetching teams:", teams.error);
            else {
                AppState.allTeamsData = teams.data;
                renderTeamLeaderboard(teams.data);
                renderTeamsView();
            }

            if (spots.error) console.error("Ошибка загрузки спотов:", spots.error);
            else {
                AppState.allSpots = spots.data;
                spotClusterer.removeAll();
                const spotPlacemarks = AppState.allSpots.map(createSpotPlacemark).filter(Boolean);
                spotClusterer.add(spotPlacemarks);
            }

            if (routes.error) console.error("Ошибка загрузки маршрутов:", routes.error);
            else {
                AppState.allRoutes = routes.data;
                routeCollection.removeAll();
                AppState.allRoutes.forEach(addRouteToMap);
            }
            
            if (events.error) console.error("Ошибка загрузки мероприятий:", events.error);
            else {
                AppState.allEvents = events.data;
                eventCollection.removeAll();
                AppState.allEvents.forEach(addEventToMap);
            }
        }
        
        // --- SUPABASE и ОБРАБОТЧИКИ ---
        function listenToRealtimeChanges() {
            supabase.channel('public-changes')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, fetchAllInitialData)
              .on('postgres_changes', { event: '*', schema: 'public', table: 'teams' }, fetchAllInitialData)
              .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, () => resetAndLoadFeed('posts'))
              .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'likes' }, payload => handleLikeChange(payload.new.post_id))
              .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'likes' }, payload => handleLikeChange(payload.old.post_id))
              .on('postgres_changes', { event: '*', schema: 'public', table: 'spots' }, fetchAllInitialData)
              .on('postgres_changes', { event: '*', schema: 'public', table: 'routes' }, fetchAllInitialData)
              .on('postgres_changes', { event: '*', schema: 'public', table: 'events' }, fetchAllInitialData)
              .on('postgres_changes', { event: '*', schema: 'public', table: 'event_participants' }, (payload) => {
                  const eventId = payload.new?.event_id || payload.old?.event_id;
                  if (eventId) {
                      updateEventCard(eventId);
                      if (participantsModal.classList.contains('visible') && AppState.currentDetailContext.id === eventId) {
                          showParticipants(eventId);
                      }
                  }
              })
              .subscribe();
        }

        function setupStaticEventListeners() {
            // ... (существующие обработчики без изменений)
        }

        function setupDynamicEventListeners() {
            // ... (существующие обработчики)
            // NEW: Обработчики для команд
            document.getElementById('team-create-btn').addEventListener('click', showTeamCreationModal);
        }

        // --- ЛОГИКА КОМАНД (NEW) ---
        function showTeamCreationModal() {
            if (AppState.userProfile.team_id) {
                showCustomAlert("Вы уже состоите в команде. Сначала покиньте текущую команду.");
                return;
            }
            tg.HapticFeedback.impactOccurred('light');
            document.getElementById('team-name').value = '';
            document.getElementById('team-description').value = '';
            document.getElementById('team-color').value = '#3b82f6';
            teamCreationModal.classList.add('visible');
            document.body.classList.add('modal-open');
            tg.BackButton.show();
        }

        function hideTeamCreationModal() {
            teamCreationModal.classList.remove('visible');
            document.body.classList.remove('modal-open');
            tg.BackButton.hide();
        }
        
        async function handleTeamSave() {
            const name = document.getElementById('team-name').value.trim();
            const description = document.getElementById('team-description').value.trim();
            const color = document.getElementById('team-color').value;

            if (!name) {
                showCustomAlert("Название команды обязательно.");
                return;
            }

            const { data, error } = await supabase.rpc('create_team', {
                p_owner_id: telegramUser.id,
                p_name: name,
                p_description: description,
                p_color: color
            });

            if (error) {
                console.error("Ошибка создания команды:", error);
                showCustomAlert(error.message || "Не удалось создать команду.");
            } else {
                showCustomAlert("Команда успешно создана!");
                hideTeamCreationModal();
                await fetchAllInitialData(); // Обновляем все данные
            }
        }
        
        function renderTeamsView() {
            const container = document.getElementById('teams-list');
            if (!AppState.allTeamsData || AppState.allTeamsData.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-8">Команд пока нет. Создайте первую!</p>`;
                return;
            }
            container.innerHTML = AppState.allTeamsData.map(team => generateTeamCardHTML(team)).join('');
        }
        
        function generateTeamCardHTML(team) {
            const area = team.total_area || 0;
            const formattedArea = area > 10000 ? `${(area / 1000000).toFixed(2)} км²` : `${Math.round(area)} м²`;
            return `
                <div class="card-bg rounded-xl shadow-md p-4 flex items-center space-x-4 cursor-pointer hover:bg-gray-50 transition" onclick="showDetailModal('team', ${team.id})">
                    <div class="w-12 h-12 rounded-lg flex-shrink-0" style="background-color: ${team.color};"></div>
                    <div class="flex-grow">
                        <p class="font-bold">${escapeHTML(team.name)}</p>
                        <p class="text-sm" style="color: var(--hint-color);"><i class="fa-solid fa-users"></i> ${team.member_count} · <i class="fa-solid fa-chart-area"></i> ${formattedArea}</p>
                    </div>
                </div>`;
        }
        
        async function joinTeam(teamId) {
            if (AppState.userProfile.team_id) {
                showCustomAlert("Вы уже состоите в команде.");
                return;
            }
            const { error } = await supabase.rpc('join_team', { p_team_id: teamId, p_user_id: telegramUser.id });
            if (error) {
                showCustomAlert("Не удалось вступить в команду.");
            } else {
                showCustomAlert("Вы вступили в команду!");
                await upsertUserProfile(); // Обновить локальный профиль
                updateProfileTeamBadge();
                hideDetailModal();
            }
        }

        async function leaveTeam() {
            showCustomConfirm("Вы уверены, что хотите покинуть команду?", async () => {
                const { error } = await supabase.rpc('leave_team', { p_user_id: telegramUser.id });
                 if (error) {
                    showCustomAlert("Не удалось покинуть команду.");
                } else {
                    showCustomAlert("Вы покинули команду.");
                    await upsertUserProfile(); // Обновить локальный профиль
                    updateProfileTeamBadge();
                }
            });
        }
        
        function updateProfileTeamBadge() {
            const container = document.getElementById('profile-team-badge');
            const team = AppState.userProfile.teams;
            if (team) {
                container.innerHTML = `
                    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold" style="background-color: ${team.color}20; color: ${team.color};" onclick="showDetailModal('team', ${team.id})">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${team.color};"></div>
                        ${escapeHTML(team.name)}
                    </span>`;
            } else {
                container.innerHTML = '';
            }
        }
        
        // --- ЛОГИКА КАРТЫ (С УЛУЧШЕНИЯМИ) ---
        
        function drawAllTerritories() {
            territoriesCollection.removeAll();
            AppState.allProfilesData.forEach(profile => {
                const territoryGeoJson = parseWKT(profile.territory_wkt || profile.territory);
                if (territoryGeoJson) {
                    // NEW: Цвет команды имеет приоритет
                    const color = profile.teams?.color || profile.color;
                    const territoryObject = ymaps.geoQuery(territoryGeoJson).addTo(territoriesCollection);
                    territoryObject.setOptions({
                        fillColor: color, fillOpacity: 0.4,
                        strokeColor: color, strokeWidth: 2, strokeOpacity: 0.8
                    });
                }
            });
        }
        
        function createSpotPlacemark(spot) {
            try {
                const wkt = spot.location_wkt || spot.location;
                const geoJsonPoint = parseWKT(wkt);
                if (!geoJsonPoint || geoJsonPoint.type !== 'Point') return null;
                
                const coords = [geoJsonPoint.coordinates[1], geoJsonPoint.coordinates[0]];
                const spotPlacemark = new ymaps.Placemark(coords, {
                    hintContent: escapeHTML(spot.name)
                }, {
                    preset: 'islands#violetDotIcon'
                });
                spotPlacemark.events.add('click', () => showDetailModal('spot', spot.id));
                return spotPlacemark;
            } catch (e) {
                console.error(`Ошибка при создании метки спота ${spot.id}.`, e, spot);
                return null;
            }
        }
        
        // --- ПАГИНАЦИЯ ЛЕНТЫ (NEW) ---
        
        function resetAndLoadFeed(tabName) {
            const paginationState = AppState.feedPagination[tabName];
            if (paginationState) {
                paginationState.page = 0;
                paginationState.loading = false;
                paginationState.finished = false;
            }
            
            const container = document.getElementById(`feed-content-${tabName}`);
            container.innerHTML = ''; // Очищаем контейнер
            
            // Устанавливаем наблюдатель
            setupIntersectionObserver(container, tabName);
            
            // Загружаем первую порцию данных
            loadMoreFeedContent(tabName);
        }

        function setupIntersectionObserver(container, tabName) {
            if (AppState.intersectionObserver) {
                AppState.intersectionObserver.disconnect();
            }
            
            const options = {
                root: null, // viewport
                rootMargin: '0px',
                threshold: 1.0
            };

            AppState.intersectionObserver = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    loadMoreFeedContent(tabName);
                }
            }, options);

            // Создаем и наблюдаем за "якорем" в конце списка
            let anchor = container.querySelector('.load-more-anchor');
            if (!anchor) {
                anchor = document.createElement('div');
                anchor.className = 'load-more-anchor h-1';
                container.appendChild(anchor);
            }
            AppState.intersectionObserver.observe(anchor);
        }

        async function loadMoreFeedContent(tabName) {
            const paginationState = AppState.feedPagination[tabName];
            if (!paginationState || paginationState.loading || paginationState.finished) {
                return;
            }

            paginationState.loading = true;
            const container = document.getElementById(`feed-content-${tabName}`);
            const anchor = container.querySelector('.load-more-anchor');
            
            // Показываем скелетоны во время загрузки
            if (paginationState.page === 0) {
                 container.insertBefore(renderFeedSkeleton(3), anchor);
            }

            try {
                const from = paginationState.page * FEED_PAGE_SIZE;
                const to = from + FEED_PAGE_SIZE - 1;
                
                let query;
                let renderFunction;

                switch(tabName) {
                    case 'posts':
                        query = supabase.from('posts').select('*, profiles(id, name, photo_url)').order('created_at', { ascending: false });
                        renderFunction = async (items) => {
                            const postIds = items.map(p => p.id);
                            const { data: likes } = await supabase.from('likes').select('*').in('post_id', postIds);
                            const { data: comments } = await supabase.from('comments').select('id, post_id').in('post_id', postIds);
                            const likesByPost = (likes || []).reduce((acc, like) => { (acc[like.post_id] = acc[like.post_id] || []).push(like); return acc; }, {});
                            const commentsByPost = (comments || []).reduce((acc, comment) => { (acc[comment.post_id] = acc[comment.post_id] || []).push(comment); return acc; }, {});
                            return items.map(post => generatePostHTML(post, likesByPost[post.id] || [], commentsByPost[post.id] || [])).join('');
                        };
                        break;
                    // TODO: Добавить логику пагинации для других вкладок
                    default:
                        // Для других вкладок пока оставляем старую логику без пагинации
                        paginationState.loading = false;
                        paginationState.finished = true;
                         if (paginationState.page === 0) {
                            container.innerHTML = ''; // Убираем скелетоны
                            // Вызываем старые функции рендера
                            if (tabName === 'events') renderFeedEvents();
                            if (tabName === 'spots') renderFeedSpots();
                            if (tabName === 'routes') renderFeedRoutes();
                         }
                        return;
                }

                const { data, error } = await query.range(from, to);

                if (error) throw error;
                
                if (paginationState.page === 0) {
                    container.innerHTML = ''; // Убираем скелетоны
                    container.appendChild(anchor); // Возвращаем якорь
                }

                if (data && data.length > 0) {
                    const html = await renderFunction(data);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    while (tempDiv.firstChild) {
                        container.insertBefore(tempDiv.firstChild, anchor);
                    }
                    paginationState.page++;
                }

                if (!data || data.length < FEED_PAGE_SIZE) {
                    paginationState.finished = true;
                    if(anchor) anchor.remove(); // Убираем якорь, если все загружено
                }

            } catch (error) {
                console.error(`Ошибка загрузки для ${tabName}:`, error);
                if (paginationState.page === 0) {
                    container.innerHTML = `<p class="text-center text-red-500 py-8">Не удалось загрузить данные.</p>`;
                }
            } finally {
                paginationState.loading = false;
            }
        }
        
        // --- СКЕЛЕТОНЫ (NEW) ---
        function renderLeaderboardSkeleton(count = 5) {
            const container = document.getElementById('top-content-users');
            let skeletonHTML = '';
            for (let i = 0; i < count; i++) {
                skeletonHTML += `
                <div class="card-bg rounded-xl p-4 flex items-center space-x-4">
                    <div class="w-8 h-8 skeleton"></div>
                    <div class="w-12 h-12 rounded-full skeleton"></div>
                    <div class="flex-grow space-y-2">
                        <div class="h-4 w-3/4 skeleton"></div>
                        <div class="h-3 w-1/2 skeleton"></div>
                    </div>
                </div>`;
            }
            container.innerHTML = skeletonHTML;
        }
        
        function renderFeedSkeleton(count = 2) {
            let skeletonHTML = '';
            for (let i = 0; i < count; i++) {
                skeletonHTML += `
                <div class="card-bg rounded-2xl shadow-lg overflow-hidden space-y-4 p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full skeleton"></div>
                        <div class="flex-grow space-y-2">
                            <div class="h-4 w-1/2 skeleton"></div>
                            <div class="h-3 w-1/4 skeleton"></div>
                        </div>
                    </div>
                    <div class="h-4 w-full skeleton"></div>
                    <div class="h-4 w-3/4 skeleton"></div>
                    <div class="h-48 w-full skeleton"></div>
                </div>`;
            }
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = skeletonHTML;
            return tempDiv;
        }


        // --- ОБНОВЛЕНИЕ СУЩЕСТВУЮЩИХ ФУНКЦИЙ ---
        
        async function upsertUserProfile() {
            if (!telegramUser) throw new Error("Пользователь Telegram не определен для upsertUserProfile.");

            const { data, error } = await supabase.from('profiles').select('*, teams(*)').eq('id', telegramUser.id).single();
            
            if (error && error.code !== 'PGRST116') {
                console.error("Ошибка получения профиля:", error); 
                throw error; 
            } 
            
            if (data) {
                AppState.userProfile = { ...AppState.userProfile, ...data };
                AppState.userProfile.territory = parseWKT(data.territory_wkt) || parseWKT(data.territory) || data.territory;
            } else {
                AppState.userProfile.color = generateColorFromId(telegramUser.id);
                const { data: insertData, error: insertError } = await supabase.from('profiles').insert({ 
                    id: telegramUser.id, 
                    name: telegramUser.first_name, 
                    color: AppState.userProfile.color, 
                    area: 0, 
                    photo_url: telegramUser.photo_url || null, 
                    territory: null 
                }).select('*, teams(*)').single();
                if (insertError) { 
                    console.error("Ошибка создания профиля:", insertError); 
                    throw insertError; 
                }
                AppState.userProfile = { ...AppState.userProfile, ...insertData };
            }
        }
        
        function renderLeaderboard(profiles) {
            const container = document.getElementById('top-content-users');
            if (!profiles) {
                renderLeaderboardSkeleton();
                return;
            }
            profiles.sort((a, b) => (b.area || 0) - (a.area || 0));
            container.innerHTML = profiles.map((u, index) => {
                // ... (существующий HTML для пользователя)
            }).join('');
        }

        function renderTeamLeaderboard(teams) {
             const container = document.getElementById('top-content-teams');
             if (!teams) {
                 // Можно добавить скелетон и для команд
                 container.innerHTML = '<p>Загрузка...</p>';
                 return;
             }
             // Сортировка уже должна быть сделана в RPC
             container.innerHTML = teams.map(generateTeamCardHTML).join('');
        }

        // --- Глобальные функции и запуск ---
        window.showView = showView;
        window.switchFeedTab = switchFeedTab;
        window.switchTopTab = switchTopTab;
        window.joinTeam = joinTeam;
        window.leaveTeam = leaveTeam;
        window.handleTeamSave = handleTeamSave;
        window.hideTeamCreationModal = hideTeamCreationModal;
        // ... (остальные глобальные функции)
        
        // Запускаем приложение
        runApp();

    </script>
</body>
</html>
