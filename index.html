<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TerraRun | Захват Территории</title>

    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Подключение Leaflet JS и CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Подключение Turf.js для гео-анализа -->
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    
    <!-- Подключение плагина Leaflet.TextPath для текста вдоль линии -->
    <script src="https://unpkg.com/leaflet-textpath/leaflet.textpath.js"></script>
    
    <!-- Подключение Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Подключение Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Подключение QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --bg-color: #f3f4f6;
            --secondary-bg-color: #ffffff;
            --text-color: #1f2937;
            --hint-color: #6b7280;
            --button-color: #3b82f6;
            --button-text-color: #ffffff;
            --destructive-color: #ef4444;
            --success-color: #28a745;
        }

        /* Адаптация под безопасные зоны iOS */
        body {
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }

        body {
            overscroll-behavior: none;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        #map, .mini-map {
            z-index: 10;
            background-color: var(--bg-color);
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 80px; /* Высота навбара */
        }
        .view {
            display: none;
            height: calc(100vh - 80px - env(safe-area-inset-bottom));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transition: opacity 0.3s ease-in-out;
            background-color: var(--bg-color);
        }
        .view.active {
            display: block;
        }
        .nav-btn.active svg, .nav-btn.active span {
            color: var(--button-color);
        }
        .nav-btn span {
             color: var(--hint-color);
        }
        .nav-btn.active span {
            color: var(--button-color);
        }
        .card-bg {
            background-color: var(--secondary-bg-color);
        }
        #bottom-navbar {
            height: calc(80px + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
            background-color: color-mix(in srgb, var(--secondary-bg-color) 80%, transparent);
            backdrop-filter: blur(10px);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .avatar-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 15px rgba(0,0,0,0.4);
            background-size: cover;
            background-position: center;
            transition: transform 0.2s ease-in-out;
        }
        .avatar-marker:hover {
            transform: scale(1.1);
        }
        .current-user-marker {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 2px 15px rgba(0,0,0,0.4), 0 0 0 0 color-mix(in srgb, var(--button-color) 70%, transparent); }
            70% { box-shadow: 0 2px 15px rgba(0,0,0,0.4), 0 0 0 15px color-mix(in srgb, var(--button-color) 0%, transparent); }
            100% { box-shadow: 0 2px 15px rgba(0,0,0,0.4), 0 0 0 0 color-mix(in srgb, var(--button-color) 0%, transparent); }
        }
        .like-btn.liked svg {
            fill: var(--destructive-color);
            color: var(--destructive-color);
        }
        #initial-loader {
            background-color: var(--bg-color);
        }
        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal.visible .modal-content {
            transform: scale(1);
        }
        .bottom-sheet {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: flex-end;
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .bottom-sheet.visible {
            opacity: 1;
            visibility: visible;
        }
        .bottom-sheet-content {
            width: 100%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        .bottom-sheet.visible .bottom-sheet-content {
            transform: translateY(0);
        }
    </style>
</head>
<body class="font-sans antialiased overflow-hidden">
    
    <!-- Начальный загрузчик -->
    <div id="initial-loader" class="fixed inset-0 flex flex-col items-center justify-center z-50">
        <svg class="animate-spin h-10 w-10 mb-4" style="color: var(--button-color);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p class="text-lg font-semibold" style="color: var(--text-color);">Загрузка TerraRun...</p>
    </div>

    <!-- Экран-заглушка / Вход -->
    <div id="auth-screen" class="fixed inset-0 flex items-center justify-center p-4 z-40 hidden">
        <div id="login-map-bg" class="absolute inset-0 z-10 filter blur-sm brightness-90"></div>
        <div id="auth-content" class="z-20 text-center card-bg p-8 rounded-2xl shadow-lg">
            <!-- Содержимое будет сгенерировано JS -->
        </div>
    </div>

    <!-- Основной контейнер приложения -->
    <div id="app-container" class="hidden">
        <!-- Вид 1: Карта -->
        <div id="map-view" class="view active">
            <div id="map"></div>
            <button id="recenter-btn" class="z-20 fixed top-4 right-4 bg-white/80 backdrop-blur-md p-3 rounded-full shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0zM15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
            <div id="run-info" class="fixed top-4 left-0 right-0 p-4 z-20 pointer-events-none">
                 <div class="max-w-md mx-auto card-bg backdrop-blur-md rounded-2xl shadow-xl p-3 flex items-center justify-center fade-in">
                    <div class="text-center">
                        <span id="username-display" class="font-bold text-lg">TerraRun</span>
                        <span id="area-display" class="text-sm block" style="color: var(--hint-color);">Площадь: 0 м²</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Вид 2: Лента -->
        <div id="feed-view" class="view p-4 fade-in">
            <h1 class="text-3xl font-bold mb-6 px-2">Лента</h1>
            <div id="feed-container" class="space-y-4"></div>
        </div>

        <!-- Вид 3: Топ пользователей -->
        <div id="top-view" class="view p-4 fade-in">
            <div class="flex justify-between items-center mb-6 px-2">
                <h1 class="text-3xl font-bold">Топ Бегунов</h1>
                <button id="scan-qr-btn" class="p-2 rounded-full hover:bg-gray-200" style="background-color: var(--secondary-bg-color);">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" style="color: var(--hint-color);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v.01M16 4v.01M20 4v.01M4 8h.01M8 8h.01M12 8h.01M16 8h.01M20 8h.01M4 12h.01M8 12h.01M12 12h.01M16 12h.01M20 12h.01M4 16h.01M8 16h.01M12 16h.01M4 20h.01M8 20h.01M12 20h.01M16 20h.01M20 20h.01" /></svg>
                </button>
            </div>
            <div id="leaderboard" class="space-y-3"></div>
        </div>

        <!-- Вид 4: Профиль -->
        <div id="profile-view" class="view p-4 fade-in">
            <h1 class="text-3xl font-bold mb-6 px-2">Профиль</h1>
            <div class="card-bg rounded-2xl shadow-lg p-6 space-y-6">
                <div class="flex items-center space-x-4">
                    <div id="profile-avatar-wrapper" class="w-20 h-20 rounded-full border-4 flex-shrink-0">
                        <img src="https://placehold.co/80x80/E2E8F0/4A5568?text=?" id="profile-avatar-img" class="w-full h-full rounded-full object-cover" alt="avatar">
                    </div>
                    <div>
                        <h2 id="profile-name" class="text-2xl font-bold">Загрузка...</h2>
                        <div class="flex items-center cursor-pointer" id="edit-status-btn">
                            <p id="profile-status" class="text-sm" style="color: var(--hint-color);">Энтузиаст захвата территорий</p>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1.5" style="color: var(--hint-color);" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                        </div>
                    </div>
                </div>
                <div class="rounded-lg p-4 text-center" style="background-color: color-mix(in srgb, var(--button-color) 15%, transparent)">
                    <p class="text-sm" style="color: var(--button-color)">Общая площадь</p>
                    <p id="profile-area" class="text-3xl font-bold" style="color: var(--button-color)">0 м²</p>
                </div>
                <div class="space-y-3">
                    <button id="invite-friend-btn" class="w-full text-white font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-center" style="background-color: var(--button-color); color: var(--button-text-color);"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 11a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1v-1z" /></svg>Пригласить друга</button>
                    <button id="show-qr-btn" class="w-full font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-center card-bg border" style="color: var(--text-color);"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v.01M16 4v.01M20 4v.01M4 8h.01M8 8h.01M12 8h.01M16 8h.01M20 8h.01M4 12h.01M8 12h.01M12 12h.01M16 12h.01M20 12h.01M4 16h.01M8 16h.01M12 16h.01M4 20h.01M8 20h.01M12 20h.01M16 20h.01M20 20h.01" /></svg>Поделиться профилем (QR)</button>
                    <button id="donate-btn" class="w-full text-white font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-center" style="background-color: var(--success-color); color: var(--button-text-color);"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>Поддержать проект</button>
                </div>
            </div>
            <h2 class="text-2xl font-bold my-6 px-2">Мои посты</h2>
            <div id="profile-feed-container" class="space-y-4"></div>
        </div>
    </div>

    <!-- Нижний навбар -->
    <nav id="bottom-navbar" class="hidden fixed bottom-0 left-0 right-0 flex justify-around items-center z-20">
        <button class="nav-btn active flex flex-col items-center space-y-1 transition-transform transform hover:scale-110 p-2" onclick="App.showView('map-view')"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span>Карта</span></button>
        <button class="nav-btn flex flex-col items-center space-y-1 transition-transform transform hover:scale-110 p-2" onclick="App.showView('feed-view')"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3h2m0 0h2" /></svg><span>Лента</span></button>
        <button class="nav-btn flex flex-col items-center space-y-1 transition-transform transform hover:scale-110 p-2" onclick="App.showView('top-view')"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg><span>Топ</span></button>
        <button class="nav-btn flex flex-col items-center space-y-1 transition-transform transform hover:scale-110 p-2" onclick="App.showView('profile-view')"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><span>Профиль</span></button>
    </nav>
    
    <!-- Модальные окна -->
    <div id="create-post-modal" class="modal">
        <div class="modal-content card-bg rounded-2xl shadow-2xl p-6 w-full max-w-md space-y-4">
            <h2 class="text-2xl font-bold">Новое достижение!</h2>
            <p style="color: var(--hint-color);">Дайте название вашей новой территории и поделитесь с другими.</p>
            <div>
                <label for="post-title" class="block text-sm font-medium">Название</label>
                <input type="text" id="post-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Например, 'Утренний захват парка'">
            </div>
            <div>
                <label for="post-photo-input" class="block text-sm font-medium">Фото (по желанию)</label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                    <div class="space-y-1 text-center">
                        <img id="post-photo-preview" src="" alt="Предпросмотр фото" class="hidden mx-auto h-24 w-auto mb-4 rounded">
                        <svg id="post-photo-icon" class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                        <div class="flex text-sm text-gray-600">
                            <label for="post-photo-input" class="relative cursor-pointer rounded-md font-medium" style="color: var(--button-color)">
                                <span>Загрузите файл</span>
                                <input id="post-photo-input" name="post-photo-input" type="file" class="sr-only" accept="image/*">
                            </label>
                            <p class="pl-1">или перетащите</p>
                        </div>
                        <p class="text-xs text-gray-500">PNG, JPG до 5MB</p>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-post-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-all">Пропустить</button>
                <button id="save-post-btn" class="text-white font-bold py-2 px-4 rounded-full transition-all flex items-center justify-center" style="background-color: var(--button-color); color: var(--button-text-color)">
                    <span id="save-post-text">Опубликовать</span>
                    <svg id="save-post-loader" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="user-detail-modal" class="bottom-sheet">
        <div class="bottom-sheet-content card-bg rounded-t-2xl shadow-2xl p-4">
            <div class="w-full flex justify-center mb-2 flex-shrink-0" ontouchstart="UI.handleTouchStart(event, 'user-detail-modal')" ontouchmove="UI.handleTouchMove(event, 'user-detail-modal')" ontouchend="UI.handleTouchEnd('user-detail-modal')">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>
            <div id="user-detail-header" class="flex items-center space-x-4 mb-4 flex-shrink-0"></div>
            <div id="detail-map" class="w-full flex-grow bg-gray-200 rounded-lg mb-4"></div>
            <div id="user-detail-stats" class="text-center flex-shrink-0"></div>
             <button id="share-profile-btn" class="mt-4 w-full text-white font-bold py-3 px-4 rounded-full transition-all" style="background-color: var(--button-color); color: var(--button-text-color)">Поделиться профилем</button>
        </div>
    </div>
    
    <div id="comments-modal" class="bottom-sheet">
        <div class="bottom-sheet-content card-bg rounded-t-2xl shadow-2xl">
            <div class="w-full flex justify-center py-3 flex-shrink-0 cursor-grab" onclick="UI.hideCommentsModal()">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
            </div>
            <h2 class="text-xl font-bold px-4">Комментарии</h2>
            <div id="comments-modal-body" class="flex-grow overflow-y-auto p-4">
                <!-- Комментарии будут отрендерены здесь -->
            </div>
            <div id="comment-input-container" class="flex-shrink-0 p-2 border-t" style="background-color: var(--secondary-bg-color);">
                 <div id="reply-indicator" class="hidden text-xs px-2 pb-1 flex justify-between items-center" style="color: var(--hint-color);">
                    <span id="reply-indicator-text"></span>
                    <button onclick="Feed.cancelReply()" class="font-bold text-xl">&times;</button>
                </div>
                <div class="flex items-center space-x-2">
                    <textarea id="main-comment-input" class="w-full p-2 border rounded-lg flex-grow" rows="1" placeholder="Написать комментарий..."></textarea>
                    <button id="main-comment-send-btn" onclick="Feed.postComment()" class="flex-shrink-0 text-white rounded-full p-2 disabled:opacity-50" style="background-color: var(--button-color);">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="qr-code-modal" class="modal">
        <div class="modal-content card-bg rounded-2xl shadow-2xl p-6 w-full max-w-xs text-center space-y-4">
            <h2 class="text-xl font-bold">Ваш QR-код</h2>
            <p style="color: var(--hint-color);">Покажите этот QR-код другу, чтобы он мог посмотреть ваш профиль!</p>
            <div id="qrcode-container" class="flex justify-center items-center p-2 bg-white rounded-lg"></div>
            <button onclick="UI.hideModal('qr-code-modal')" class="w-full font-bold py-2 px-4 rounded-full" style="background-color: var(--button-color); color: var(--button-text-color);">Закрыть</button>
        </div>
    </div>


    <script type="module">
        // --- КОНФИГУРАЦИЯ И КОНСТАНТЫ ---
        const SUPABASE_URL = 'https://jsnahjtoqwuwbjdmisuj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpzbmFoanRvcXd1d2JqZG1pc3VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzOTQxMDQsImV4cCI6MjA2ODk3MDEwNH0.M3TWsNJppj1f-Cmj6nGCAUswy1HZgBLW8yJZfTwkrpI';
        const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoieXVuZ3JlemFjIiwiYSI6ImNtOW10ZzJ6bDBjNHUyanI3ejc5eXo1d2MifQ._tryk9cXjfReUGLGnNkm6Q';
        const MAP_STYLE_URL = 'https://api.mapbox.com/styles/v1/mapbox/streets-v12/tiles/512/{z}/{x}/{y}?access_token={accessToken}';

        // --- ГЛОБАЛЬНОЕ СОСТОЯНИЕ ПРИЛОЖЕНИЯ ---
        const State = {
            tg: window.Telegram.WebApp,
            supabase: null,
            map: null,
            detailMap: null,
            
            telegramUser: null,
            currentUserProfile: null,
            
            isRunning: false,
            geoWatchId: null,
            currentRunPath: [],
            currentPathPolyline: null,
            lastKnownLocation: null,
            initialLocationSet: false,

            allUserLayers: {},
            allProfilesData: new Map(), // Используем Map для быстрого доступа по ID
            
            lastCaptureData: null,
            currentReplyTarget: { postId: null, parentCommentId: null },
            deepLinkedUserId: null,
            
            activeModal: null, // Отслеживаем активное модальное окно
        };

        // --- МОДУЛЬ UI ---
        const UI = {
            init() {
                // Привязка основных обработчиков событий к элементам UI
                document.getElementById('recenter-btn').addEventListener('click', MapModule.recenterMap);
                document.getElementById('scan-qr-btn').addEventListener('click', TelegramModule.showQrScanner);
                document.getElementById('invite-friend-btn').addEventListener('click', TelegramModule.inviteFriend);
                document.getElementById('donate-btn').addEventListener('click', TelegramModule.showDonation);
                document.getElementById('edit-status-btn').addEventListener('click', App.editStatus);
                document.getElementById('show-qr-btn').addEventListener('click', UI.showMyQrCode);
                
                // Модальное окно поста
                document.getElementById('save-post-btn').addEventListener('click', Feed.handlePostSubmission);
                document.getElementById('cancel-post-btn').addEventListener('click', () => UI.hideModal('create-post-modal'));
                document.getElementById('post-photo-input').addEventListener('change', UI.previewPostPhoto);

                // Закрытие модалок по клику на фон
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target.id === modal.id) UI.hideModal(modal.id);
                    });
                });
                document.querySelectorAll('.bottom-sheet').forEach(sheet => {
                    sheet.addEventListener('click', (e) => {
                        if (e.target.id === sheet.id) UI.hideBottomSheet(sheet.id);
                    });
                });
            },

            showView(viewId) {
                State.tg.HapticFeedback.selectionChanged();
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(viewId).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`button[onclick="App.showView('${viewId}')"]`).classList.add('active');
                
                TelegramModule.updateMainButton(viewId);

                if (viewId === 'map-view') {
                    setTimeout(() => State.map?.invalidateSize(), 100);
                }
                
                State.tg.CloudStorage.setItem('lastView', viewId, (err) => {
                    if(err) console.error("Cloud storage error:", err);
                });
            },

            updateProfileUI(profile) {
                const name = profile.name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                document.getElementById('profile-name').textContent = name;
                document.getElementById('username-display').textContent = name;
                document.getElementById('profile-status').textContent = profile.status || 'Энтузиаст захвата территорий';

                if (profile.photo_url) {
                    document.getElementById('profile-avatar-img').src = profile.photo_url;
                } else {
                    const initial = name.charAt(0).toUpperCase();
                    document.getElementById('profile-avatar-img').src = `https://placehold.co/80x80/E2E8F0/4A5568?text=${initial}`;
                }
                document.getElementById('profile-avatar-wrapper').style.borderColor = profile.color;
                UI.updateStats(profile.area);
            },
            
            updateStats(area = 0) {
                const formattedArea = UI.formatArea(area);
                document.getElementById('area-display').textContent = `Площадь: ${formattedArea}`;
                document.getElementById('profile-area').textContent = formattedArea;
            },

            updateLeaderboard(profiles) {
                const sortedProfiles = [...profiles.values()].sort((a, b) => (b.area || 0) - (a.area || 0));
                const leaderboardDiv = document.getElementById('leaderboard');
                
                leaderboardDiv.innerHTML = sortedProfiles.map((u, index) => {
                    const isCurrentUser = u.id === State.telegramUser.id;
                    const name = u.name.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const displayName = isCurrentUser ? `${name} (Вы)` : name;
                    const avatar = u.photo_url || `https://placehold.co/50x50/E5E7EB/4B5563?text=${name.charAt(0)}`;
                    const formattedArea = UI.formatArea(u.area);

                    return `<div class="card-bg rounded-xl shadow-md p-4 flex items-center space-x-4 cursor-pointer hover:bg-gray-50 transition" onclick="UI.showUserDetailModal(${u.id})">
                        <span class="text-xl font-bold w-8" style="color: var(--hint-color);">${index + 1}</span>
                        <img src="${avatar}" class="w-12 h-12 rounded-full" alt="avatar">
                        <div class="flex-grow">
                            <p class="font-bold">${displayName}</p>
                            <p class="text-sm" style="color: var(--hint-color);">${formattedArea}</p>
                        </div>
                    </div>`;
                }).join('');
            },

            // --- Управление модальными окнами ---
            showModal(modalId) {
                State.activeModal = modalId;
                const modal = document.getElementById(modalId);
                modal.classList.add('visible');
                TelegramModule.updateBackButton();
            },
            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.remove('visible');
                if (State.activeModal === modalId) {
                    State.activeModal = null;
                    TelegramModule.updateBackButton();
                }
            },
            showBottomSheet(sheetId) {
                State.activeModal = sheetId;
                const sheet = document.getElementById(sheetId);
                const content = sheet.querySelector('.bottom-sheet-content');
                sheet.classList.add('visible');
                content.classList.remove('translate-y-full');
                TelegramModule.updateBackButton();
            },
            hideBottomSheet(sheetId) {
                const sheet = document.getElementById(sheetId);
                const content = sheet.querySelector('.bottom-sheet-content');
                content.classList.add('translate-y-full');
                setTimeout(() => sheet.classList.remove('visible'), 300);

                if (State.activeModal === sheetId) {
                    State.activeModal = null;
                    TelegramModule.updateBackButton();
                }
            },

            showCreatePostModal(newCapture) {
                State.lastCaptureData = newCapture;
                document.getElementById('post-title').value = '';
                document.getElementById('post-photo-input').value = '';
                document.getElementById('post-photo-preview').classList.add('hidden');
                document.getElementById('post-photo-icon').classList.remove('hidden');
                UI.showModal('create-post-modal');
            },

            async showUserDetailModal(userId) {
                const profile = State.allProfilesData.get(userId);
                if (!profile) {
                    State.tg.showAlert("Профиль пользователя не найден.");
                    return;
                }

                State.tg.HapticFeedback.impactOccurred('medium');
                
                const header = document.getElementById('user-detail-header');
                const stats = document.getElementById('user-detail-stats');
                const avatar = profile.photo_url || `https://placehold.co/50x50/E5E7EB/4B5563?text=${profile.name.charAt(0)}`;
                
                header.innerHTML = `<img src="${avatar}" class="w-16 h-16 rounded-full" alt="avatar"><div><p class="text-2xl font-bold">${profile.name}</p><p class="text-sm" style="color: var(--hint-color);">${profile.status || 'Завоеватель'}</p></div>`;
                stats.innerHTML = `<p class="text-sm" style="color: var(--hint-color);">Общая площадь</p><p class="text-4xl font-bold">${UI.formatArea(profile.area)}</p>`;
                document.getElementById('share-profile-btn').onclick = () => TelegramModule.shareProfile(profile.id, profile.name);

                UI.showBottomSheet('user-detail-modal');

                setTimeout(() => {
                    if (State.detailMap) State.detailMap.remove();
                    State.detailMap = L.map('detail-map', { zoomControl: false, attributionControl: false });
                    L.tileLayer(MAP_STYLE_URL, { maxZoom: 19, accessToken: MAPBOX_ACCESS_TOKEN, tileSize: 512, zoomOffset: -1 }).addTo(State.detailMap);
                    
                    if (profile.territory) {
                        const territoryLayer = L.geoJSON(profile.territory, { style: { color: profile.color, weight: 2, opacity: 0.8, fillColor: profile.color, fillOpacity: 0.5 } }).addTo(State.detailMap);
                        State.detailMap.fitBounds(territoryLayer.getBounds(), { padding: [20, 20], maxZoom: 16 });
                    } else {
                        State.detailMap.setView([55.75, 37.61], 5);
                    }
                }, 300);
            },
            hideUserDetailModal() {
                UI.hideBottomSheet('user-detail-modal');
                setTimeout(() => {
                    if (State.detailMap) {
                        State.detailMap.remove();
                        State.detailMap = null;
                        document.getElementById('detail-map').innerHTML = '';
                    }
                }, 300);
            },
            
            showMyQrCode() {
                State.tg.HapticFeedback.impactOccurred('light');
                const deepLink = `https://t.me/${State.tg.initDataUnsafe.bot_username || 'TerraRunBot'}/app?startapp=user${State.telegramUser.id}`;
                const qrContainer = document.getElementById('qrcode-container');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: deepLink,
                    width: 192,
                    height: 192,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                UI.showModal('qr-code-modal');
            },
            
            showCommentsModal(postId) {
                State.tg.HapticFeedback.impactOccurred('medium');
                Feed.currentReplyTarget = { postId: postId, parentCommentId: null };
                Feed.cancelReply();
                document.getElementById('comments-modal-body').innerHTML = '<div class="text-center p-8"><svg class="animate-spin mx-auto h-8 w-8 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';
                UI.showBottomSheet('comments-modal');
                Feed.renderComments(postId);
            },
            hideCommentsModal() {
                UI.hideBottomSheet('comments-modal');
                setTimeout(() => {
                    document.getElementById('comments-modal-body').innerHTML = '';
                }, 300);
            },

            previewPostPhoto() {
                const file = document.getElementById('post-photo-input').files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('post-photo-preview').src = e.target.result;
                        document.getElementById('post-photo-preview').classList.remove('hidden');
                        document.getElementById('post-photo-icon').classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            },

            formatArea(area = 0) {
                if (area > 10000) {
                    return `${(area / 1000000).toFixed(2)} км²`;
                }
                return `${Math.round(area)} м²`;
            },
            
            // --- Управление свайпом для закрытия ---
            touchState: { startY: 0, currentY: 0, isDragging: false, targetId: null },
            handleTouchStart(e, targetId) {
                this.touchState.isDragging = true;
                this.touchState.targetId = targetId;
                this.touchState.startY = e.touches[0].clientY;
                document.getElementById(targetId).querySelector('.bottom-sheet-content').style.transition = 'none';
            },
            handleTouchMove(e, targetId) {
                if (!this.touchState.isDragging || this.touchState.targetId !== targetId) return;
                this.touchState.currentY = e.touches[0].clientY;
                const deltaY = this.touchState.currentY - this.touchState.startY;
                if (deltaY > 0) {
                    document.getElementById(targetId).querySelector('.bottom-sheet-content').style.transform = `translateY(${deltaY}px)`;
                }
            },
            handleTouchEnd(targetId) {
                if (!this.touchState.isDragging || this.touchState.targetId !== targetId) return;
                this.touchState.isDragging = false;
                const contentEl = document.getElementById(targetId).querySelector('.bottom-sheet-content');
                contentEl.style.transition = 'transform 0.3s ease-in-out';
                const deltaY = this.touchState.currentY - this.touchState.startY;

                if (deltaY > contentEl.clientHeight * 0.3) {
                    if (targetId === 'user-detail-modal') this.hideUserDetailModal();
                    if (targetId === 'comments-modal') this.hideCommentsModal();
                } else {
                    contentEl.style.transform = '';
                }
            }
        };

        // --- МОДУЛЬ КАРТЫ ---
        const MapModule = {
            init() {
                if (State.map) return;
                State.map = L.map('map', { zoomControl: false, attributionControl: false }).setView([55.75, 37.61], 13);
                L.tileLayer(MAP_STYLE_URL, {
                    maxZoom: 19,
                    tileSize: 512,
                    zoomOffset: -1,
                    accessToken: MAPBOX_ACCESS_TOKEN
                }).addTo(State.map);
                setTimeout(() => State.map?.invalidateSize(), 100);
            },

            requestAndWatchGeo() {
                return new Promise((resolve, reject) => {
                    if (State.geoWatchId) return resolve();
                    
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            State.geoWatchId = navigator.geolocation.watchPosition(
                                MapModule.onGeoSuccess,
                                MapModule.onGeoError,
                                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                            );
                            MapModule.onGeoSuccess(pos); // Первый вызов с текущей позицией
                            resolve();
                        },
                        (err) => reject(err),
                        { enableHighAccuracy: true }
                    );
                });
            },

            onGeoSuccess(position) {
                const { latitude, longitude } = position.coords;
                const latLng = [latitude, longitude];
                State.lastKnownLocation = latLng;

                if (!State.initialLocationSet && State.map) {
                    State.map.flyTo(latLng, 16);
                    State.initialLocationSet = true;
                }

                MapModule.updateCurrentUserMarker(latLng);

                if (State.isRunning) {
                    State.currentRunPath.push([longitude, latitude]);
                    if (State.currentPathPolyline) {
                        State.currentPathPolyline.addLatLng(latLng);
                    }
                }
            },

            onGeoError(err) {
                console.error("Geolocation watch error:", err);
                State.tg.showAlert("Потерян доступ к геолокации. Проверьте разрешения.");
            },
            
            updateCurrentUserMarker(latLng) {
                const userAvatarUrl = State.telegramUser.photo_url || `https://placehold.co/40x40/E2E8F0/4A5568?text=${State.telegramUser.first_name.charAt(0)}`;
                const icon = L.divIcon({
                    html: `<div class="avatar-marker current-user-marker" style="background-image: url(${userAvatarUrl}); width: 40px; height: 40px; border-color: ${State.currentUserProfile.color};"></div>`,
                    className: '',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                const markerLayer = State.allUserLayers[State.telegramUser.id];
                if (markerLayer) {
                     // Предполагаем, что маркер - первый слой в группе
                    const marker = markerLayer.getLayers()[0];
                    if(marker && marker instanceof L.Marker) {
                        marker.setLatLng(latLng);
                    } else {
                        // Если маркера нет, создаем его
                         markerLayer.clearLayers(); // Очищаем старые слои (если там была территория)
                         L.marker(latLng, { icon: icon, zIndexOffset: 1000 }).addTo(markerLayer);
                    }
                }
            },

            drawAllUserTerritories() {
                // Очищаем все слои, кроме маркера текущего пользователя
                for (const [userId, layerGroup] of Object.entries(State.allUserLayers)) {
                    if (Number(userId) !== State.telegramUser.id) {
                         if (layerGroup) State.map.removeLayer(layerGroup);
                    }
                }
                State.allUserLayers = { [State.telegramUser.id]: State.allUserLayers[State.telegramUser.id] || L.layerGroup().addTo(State.map) };


                State.allProfilesData.forEach(profile => {
                    const isCurrentUser = profile.id === State.telegramUser.id;
                    const userLayerGroup = isCurrentUser ? State.allUserLayers[profile.id] : L.layerGroup();

                    if (profile.territory) {
                        const territoryLayer = L.geoJSON(profile.territory, { 
                            style: { color: profile.color, weight: 2, opacity: 0.8, fillColor: profile.color, fillOpacity: 0.4 } 
                        });
                        
                        // Добавляем территорию в группу слоев
                        if(isCurrentUser) {
                            // Для текущего пользователя, добавляем территорию, сохраняя маркер
                            const marker = userLayerGroup.getLayers()[0];
                            userLayerGroup.clearLayers();
                            if(marker) marker.addTo(userLayerGroup);
                            territoryLayer.addTo(userLayerGroup);
                        } else {
                            territoryLayer.addTo(userLayerGroup);
                        }
                        
                        // Добавляем имя пользователя на контур
                        try {
                            const perimeterCoords = profile.territory.geometry.coordinates[0].map(p => [p[1], p[0]]);
                            const label = L.polyline(perimeterCoords, {opacity: 0});
                            label.setText(`\u25BA ${profile.name} `, {
                                repeat: true, center: true,
                                attributes: { 'font-weight': 'bold', 'font-size': '14', 'fill': '#000', 'text-shadow': '1px 1px 1px #fff, -1px -1px 1px #fff, 1px -1px 1px #fff, -1px 1px 1px #fff' }
                            });
                            label.addTo(userLayerGroup);
                        } catch(e) { console.warn("Could not draw text path for user", profile.id, e); }
                    }

                    if (!isCurrentUser) {
                        userLayerGroup.addTo(State.map);
                        State.allUserLayers[profile.id] = userLayerGroup;
                    }
                });
            },

            recenterMap() {
                State.tg.HapticFeedback.impactOccurred('medium');
                if (State.lastKnownLocation) {
                    State.map.flyTo(State.lastKnownLocation, 16);
                } else {
                    State.tg.showAlert("Определяем ваше местоположение...");
                    MapModule.requestAndWatchGeo().catch(() => {
                        State.tg.showAlert("Не удалось получить доступ к геолокации. Пожалуйста, проверьте разрешения для Telegram.");
                    });
                }
            },

            focusOnUser(userId) {
                App.showView('map-view');
                const userLayerGroup = State.allUserLayers[userId];
                if (userLayerGroup && State.map && userLayerGroup.getLayers().length > 0) {
                    const profile = State.allProfilesData.get(userId);
                    if(profile && profile.territory) {
                        setTimeout(() => {
                            State.map.flyToBounds(L.geoJSON(profile.territory).getBounds(), { padding: [50, 50], duration: 1, maxZoom: 16 });
                        }, 100);
                    }
                } else {
                    State.tg.showAlert("У этого пользователя еще нет захваченных территорий.");
                }
            }
        };

        // --- МОДУЛЬ ИГРОВОЙ ЛОГИКИ (БЕГ) ---
        const Game = {
            startRun() {
                if (!State.initialLocationSet) {
                    State.tg.showAlert("Сначала нужно определить ваше местоположение. Если вы отказали в доступе, перезапустите приложение.");
                    return;
                }

                State.isRunning = true;
                State.tg.HapticFeedback.impactOccurred('heavy');
                State.tg.isClosingConfirmationEnabled = true;
                TelegramModule.updateMainButton('map-view');
                
                State.currentRunPath = [];
                if (State.currentPathPolyline) State.map.removeLayer(State.currentPathPolyline);
                State.currentPathPolyline = L.polyline([], { color: 'var(--destructive-color)', weight: 5, opacity: 0.9 }).addTo(State.map);
            },

            stopRun() {
                if (!State.isRunning) return;

                State.tg.showConfirm("Завершить пробежку и захватить территорию?", (ok) => {
                    if (ok) Game.processStop();
                });
            },
            
            processStop() {
                State.isRunning = false;
                State.tg.HapticFeedback.notificationOccurred('success');
                State.tg.isClosingConfirmationEnabled = false;
                TelegramModule.updateMainButton('map-view');

                if (State.currentRunPath.length > 3) {
                    Game.processRunPath();
                } else {
                    State.tg.showAlert('Слишком короткий маршрут для захвата.');
                }
                if (State.currentPathPolyline) {
                    setTimeout(() => { 
                        if(State.currentPathPolyline) State.map.removeLayer(State.currentPathPolyline); 
                        State.currentPathPolyline = null; 
                    }, 2000);
                }
            },

            processRunPath() {
                const startPoint = State.currentRunPath[0];
                const endPoint = State.currentRunPath[State.currentRunPath.length - 1];
                const distance = turf.distance(turf.point(startPoint), turf.point(endPoint), { units: 'meters' });
                
                if (distance > 50) { // Порог замыкания
                    State.tg.showAlert('Маршрут не замкнут. Вернитесь к точке старта для захвата (или ближе).');
                    return;
                }
                State.currentRunPath.push(startPoint); // Замыкаем путь

                try {
                    const line = turf.lineString(State.currentRunPath);
                    const polygonized = turf.polygonize(line);

                    if (polygonized.features.length === 0) {
                        State.tg.showAlert('Не удалось сформировать замкнутую территорию. Вероятно, маршрут пересекал сам себя. Попробуйте снова.');
                        return;
                    }

                    let newCapture = polygonized.features[0];
                    if (polygonized.features.length > 1) {
                        newCapture = turf.union(...polygonized.features);
                    }
                    
                    Game.updateTerritory(newCapture);
                } catch (error) {
                    console.error("Turf.js processing error:", error);
                    State.tg.showAlert("Произошла ошибка при обработке вашего маршрута. Возможно, он был слишком сложным.");
                }
            },

            async updateTerritory(newCapture) {
                try {
                    let combinedTerritory;
                    const currentTerritory = State.currentUserProfile.territory;

                    if (!currentTerritory) {
                        combinedTerritory = newCapture;
                    } else {
                        combinedTerritory = turf.union(currentTerritory, newCapture);
                    }
                    const newTotalTerritory = turf.cleanCoords(combinedTerritory);

                    // Вычитаем новую территорию у других игроков
                    const affectedUsersUpdates = [];
                    for (const profile of State.allProfilesData.values()) {
                        if (profile.id !== State.telegramUser.id && profile.territory) {
                            const intersection = turf.intersect(profile.territory, newTotalTerritory);
                            if (intersection) {
                                const remainingTerritory = turf.difference(profile.territory, newTotalTerritory);
                                let finalTerritory = null;
                                let finalArea = 0;
                                if (remainingTerritory) {
                                    try {
                                        const area = turf.area(remainingTerritory);
                                        if (area > 1) {
                                            finalTerritory = remainingTerritory;
                                            finalArea = area;
                                        }
                                    } catch (e) { /* Игнорируем невалидную геометрию */ }
                                }
                                affectedUsersUpdates.push({ id: profile.id, territory: finalTerritory, area: finalArea });
                            }
                        }
                    }

                    State.currentUserProfile.territory = newTotalTerritory;
                    State.currentUserProfile.area = turf.area(newTotalTerritory);
                    await SupabaseModule.saveUserProfile(State.currentUserProfile);

                    if (affectedUsersUpdates.length > 0) {
                        await SupabaseModule.updateMultipleProfiles(affectedUsersUpdates);
                    }
                    
                    State.tg.HapticFeedback.notificationOccurred('success');
                    UI.showCreatePostModal(newCapture);

                } catch (error) {
                    console.error("Ошибка в updateTerritory:", error);
                    State.tg.showAlert("Ошибка обработки территории. Форма слишком сложная.");
                    State.tg.HapticFeedback.notificationOccurred('error');
                }
            }
        };

        // --- МОДУЛЬ SUPABASE ---
        const SupabaseModule = {
            init() {
                State.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            },

            async fetchInitialData() {
                let { data: profiles, error } = await State.supabase.from('profiles').select('*');
                if (error) {
                    console.error("Error fetching profiles:", error);
                    throw error;
                }
                
                profiles.forEach(p => State.allProfilesData.set(p.id, p));
                
                let userProfile = State.allProfilesData.get(State.telegramUser.id);
                
                if (!userProfile) {
                    userProfile = {
                        id: State.telegramUser.id,
                        name: State.telegramUser.first_name,
                        photo_url: State.telegramUser.photo_url || null,
                        color: App.generateColorFromId(State.telegramUser.id),
                        area: 0,
                        territory: null,
                        status: 'Новый игрок'
                    };
                    await this.saveUserProfile(userProfile);
                    State.allProfilesData.set(userProfile.id, userProfile);
                }
                State.currentUserProfile = userProfile;
            },
            
            async saveUserProfile(profileData) {
                const { error } = await State.supabase.from('profiles').upsert(profileData);
                if (error) {
                    console.error('Error saving user data:', error);
                    State.tg.showAlert("Ошибка сохранения прогресса.");
                    throw error;
                }
            },
            
            async updateMultipleProfiles(updates) {
                const { error } = await State.supabase.from('profiles').upsert(updates);
                if (error) {
                    console.error("Error updating territories of other users:", error);
                }
            },

            listenToChanges() {
                State.supabase.channel('public:profiles')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, (payload) => {
                        console.log('Profile change received!', payload);
                        const record = payload.new;
                        if(record) {
                            State.allProfilesData.set(record.id, record);
                            if(record.id === State.telegramUser.id) {
                                State.currentUserProfile = record;
                                UI.updateProfileUI(record);
                            }
                        }
                        UI.updateLeaderboard(State.allProfilesData);
                        MapModule.drawAllUserTerritories();
                    })
                    .subscribe();

                State.supabase.channel('public:posts_activity')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, Feed.renderAllFeeds)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'likes' }, Feed.renderAllFeeds)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, (payload) => {
                        Feed.renderAllFeeds();
                        const postId = payload.new?.post_id || payload.old?.post_id;
                        if (State.activeModal === 'comments-modal' && postId === Feed.currentReplyTarget.postId) {
                            Feed.renderComments(postId);
                        }
                    })
                    .subscribe();
            }
        };

        // --- МОДУЛЬ ЛЕНТЫ И ПОСТОВ ---
        const Feed = {
            currentReplyTarget: { postId: null, parentCommentId: null },

            async renderAllFeeds() {
                const { data: posts, error: postsError } = await State.supabase
                    .from('posts')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (postsError) { console.error("Error fetching posts:", postsError); return; }

                const postIds = posts.map(p => p.id);
                if (postIds.length === 0) {
                    document.getElementById('feed-container').innerHTML = '<p class="text-center text-gray-500">В ленте пока нет постов.</p>';
                    document.getElementById('profile-feed-container').innerHTML = '<p class="text-center text-gray-500">У вас еще нет постов.</p>';
                    return;
                }

                const { data: likes, error: likesError } = await State.supabase.from('likes').select('*').in('post_id', postIds);
                const { data: comments, error: commentsError } = await State.supabase.from('comments').select('id, post_id').in('post_id', postIds);
                if (likesError || commentsError) { console.error("Error fetching activity:", likesError, commentsError); return; }

                const likesByPost = likes.reduce((acc, like) => {
                    (acc[like.post_id] = acc[like.post_id] || []).push(like);
                    return acc;
                }, {});

                const commentsByPost = comments.reduce((acc, comment) => {
                    (acc[comment.post_id] = acc[comment.post_id] || []).push(comment);
                    return acc;
                }, {});

                const allPostsHTML = posts.map(post => this.generatePostHTML(post, likesByPost[post.id] || [], commentsByPost[post.id] || [])).join('');
                document.getElementById('feed-container').innerHTML = allPostsHTML || '<p class="text-center text-gray-500">В ленте пока нет постов.</p>';
                
                const userPostsHTML = posts.filter(p => p.user_id === State.telegramUser.id).map(post => this.generatePostHTML(post, likesByPost[post.id] || [], commentsByPost[post.id] || [])).join('');
                document.getElementById('profile-feed-container').innerHTML = userPostsHTML || '<p class="text-center text-gray-500">У вас еще нет постов.</p>';

                // Инициализация мини-карт
                posts.forEach(post => {
                    const mapContainer = document.getElementById(`mini-map-${post.id}`);
                    if (mapContainer && !mapContainer._leaflet_id) {
                        const miniMap = L.map(mapContainer, { zoomControl: false, attributionControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false });
                        L.tileLayer(MAP_STYLE_URL, { maxZoom: 19, accessToken: MAPBOX_ACCESS_TOKEN, tileSize: 512, zoomOffset: -1 }).addTo(miniMap);
                        const territoryLayer = L.geoJSON(post.territory_captured, { style: { color: post.user_color, weight: 2, opacity: 0.8, fillColor: post.user_color, fillOpacity: 0.5 } }).addTo(miniMap);
                        miniMap.fitBounds(territoryLayer.getBounds(), { padding: [10, 10] });
                    }
                });
            },
            
            generatePostHTML(post, likes, comments) {
                const avatar = post.user_avatar_url || `https://placehold.co/40x40/E5E7EB/4B5563?text=${post.user_name.charAt(0)}`;
                const formattedArea = UI.formatArea(post.area_captured);
                const userHasLiked = likes.some(like => like.user_id === State.telegramUser.id);
                
                return `
                    <div class="card-bg rounded-2xl shadow-lg overflow-hidden" id="post-${post.id}">
                        <div class="p-4">
                            <div class="flex items-center space-x-3">
                                <img src="${avatar}" class="w-10 h-10 rounded-full cursor-pointer" alt="avatar" onclick="UI.showUserDetailModal(${post.user_id})">
                                <div>
                                    <p class="font-bold cursor-pointer" onclick="UI.showUserDetailModal(${post.user_id})">${post.user_name}</p>
                                    <p class="text-xs" style="color: var(--hint-color);">${new Date(post.created_at).toLocaleString('ru-RU')}</p>
                                </div>
                            </div>
                            <p class="mt-4">${post.title.replace(/</g, "&lt;")}</p>
                        </div>
                        ${post.photo_url ? `<img src="${post.photo_url}" class="w-full h-64 object-cover" alt="Post photo">` : ''}
                        <div id="mini-map-${post.id}" class="h-48 w-full mini-map"></div>
                        <div class="p-4">
                            <p class="font-semibold">Захвачено: <span class="font-bold" style="color: var(--button-color);">${formattedArea}</span></p>
                            <div class="flex items-center space-x-6 mt-3" style="color: var(--hint-color);">
                                <button class="like-btn flex items-center space-x-1 hover:text-red-500 transition ${userHasLiked ? 'liked' : ''}" onclick="Feed.toggleLike(this, ${post.id})">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 016.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z" /></svg>
                                    <span>${likes.length}</span>
                                </button>
                                <button class="flex items-center space-x-1 hover:text-blue-500 transition" onclick="UI.showCommentsModal(${post.id})">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                                    <span>${comments.length}</span>
                                </button>
                                <button class="flex items-center space-x-1 hover:text-blue-500 transition" onclick="TelegramModule.sharePost(${post.id}, '${post.title.replace(/'/g, "\\'")}', '${formattedArea}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            async handlePostSubmission() {
                const title = document.getElementById('post-title').value.trim();
                if (!title) {
                    State.tg.showAlert("Пожалуйста, введите название.");
                    return;
                }
                if (!State.lastCaptureData) return;

                const saveBtn = document.getElementById('save-post-btn');
                saveBtn.disabled = true;
                document.getElementById('save-post-text').classList.add('hidden');
                document.getElementById('save-post-loader').classList.remove('hidden');

                try {
                    let photoUrl = null;
                    const file = document.getElementById('post-photo-input').files[0];
                    if (file) {
                        const filePath = `${State.telegramUser.id}/${Date.now()}_${file.name}`;
                        const { data, error } = await State.supabase.storage.from('photo').upload(filePath, file);
                        if (error) throw error;
                        const { data: urlData } = State.supabase.storage.from('photo').getPublicUrl(data.path);
                        photoUrl = urlData.publicUrl;
                    }

                    const areaCaptured = turf.area(State.lastCaptureData);
                    
                    const { error: postError } = await State.supabase.from('posts').insert({
                        user_id: State.telegramUser.id,
                        title: title,
                        photo_url: photoUrl,
                        territory_captured: State.lastCaptureData,
                        area_captured: areaCaptured,
                        user_name: State.currentUserProfile.name,
                        user_avatar_url: State.currentUserProfile.photo_url,
                        user_color: State.currentUserProfile.color
                    });

                    if (postError) throw postError;

                    State.tg.showAlert("Пост успешно опубликован!");
                    UI.hideModal('create-post-modal');

                } catch (error) {
                    console.error("Error saving post:", error);
                    State.tg.showAlert("Не удалось сохранить пост. " + error.message);
                } finally {
                    saveBtn.disabled = false;
                    document.getElementById('save-post-text').classList.remove('hidden');
                    document.getElementById('save-post-loader').classList.add('hidden');
                }
            },

            async toggleLike(buttonElement, postId) {
                State.tg.HapticFeedback.impactOccurred('light');
                
                const hasLiked = buttonElement.classList.contains('liked');
                const countSpan = buttonElement.querySelector('span');
                const currentCount = parseInt(countSpan.textContent);

                // Оптимистичное обновление UI
                buttonElement.classList.toggle('liked');
                countSpan.textContent = hasLiked ? currentCount - 1 : currentCount + 1;

                try {
                    if (hasLiked) {
                        const { error } = await State.supabase.from('likes').delete().match({ post_id: postId, user_id: State.telegramUser.id });
                        if (error) throw error;
                    } else {
                        const { error } = await State.supabase.from('likes').insert({ post_id: postId, user_id: State.telegramUser.id });
                        if (error) throw error;
                    }
                } catch (error) {
                    console.error("Ошибка лайка:", error);
                    // Откат UI в случае ошибки
                    buttonElement.classList.toggle('liked');
                    countSpan.textContent = currentCount;
                    State.tg.showAlert(`Не удалось обработать лайк.`);
                }
            },

            // --- Логика комментариев ---
            async renderComments(postId) {
                const modalBody = document.getElementById('comments-modal-body');
                try {
                    const { data: comments, error } = await State.supabase
                        .from('comments')
                        .select('*, profiles(name, photo_url)')
                        .eq('post_id', postId)
                        .order('created_at', { ascending: true });

                    if (error) throw error;
                    
                    const commentsByParent = (comments || []).reduce((acc, comment) => {
                        const parentId = comment.parent_comment_id || 'root';
                        (acc[parentId] = acc[parentId] || []).push(comment);
                        return acc;
                    }, {});
                    const rootComments = commentsByParent['root'] || [];

                    if (rootComments.length === 0) {
                        modalBody.innerHTML = '<p class="text-center text-gray-500 py-4">Пока нет комментариев. Будьте первым!</p>';
                    } else {
                        modalBody.innerHTML = rootComments.map(comment => this.generateCommentHTML(comment, commentsByParent)).join('');
                    }

                } catch(error) {
                    console.error("Ошибка загрузки комментариев:", error);
                    modalBody.innerHTML = '<p class="text-center text-red-500 p-4">Ошибка загрузки комментариев.</p>';
                }
            },

            generateCommentHTML(comment, commentsByParent) {
                const replies = commentsByParent[comment.id] || [];
                const profileName = comment.profiles ? comment.profiles.name : 'Аноним';
                const avatar = comment.profiles ? (comment.profiles.photo_url || `https://placehold.co/32x32/E5E7EB/4B5563?text=${profileName.charAt(0)}`) : 'https://placehold.co/32x32/E5E7EB/4B5563?text=?';
                
                return `
                    <div class="flex items-start space-x-3 mt-4">
                        <img src="${avatar}" class="w-8 h-8 rounded-full" alt="avatar">
                        <div class="flex-1">
                            <div class="rounded-lg p-2" style="background-color: color-mix(in srgb, var(--bg-color) 50%, white)">
                                <p class="font-bold text-sm" style="color: var(--text-color);">${profileName}</p>
                                <p class="text-sm" style="color: var(--text-color); opacity: 0.9;">${comment.content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
                            </div>
                            <div class="text-xs mt-1" style="color: var(--hint-color);">
                                <button class="hover:underline" onclick="Feed.setReplyMode(${comment.post_id}, ${comment.id}, '${profileName.replace(/'/g, "\\'")}')">Ответить</button>
                            </div>
                            <div class="pl-4 border-l-2 border-gray-200">
                                ${replies.map(reply => this.generateCommentHTML(reply, commentsByParent)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            setReplyMode(postId, parentCommentId, parentAuthorName) {
                this.currentReplyTarget = { postId, parentCommentId };
                document.getElementById('reply-indicator-text').textContent = `Ответ пользователю: ${parentAuthorName}`;
                document.getElementById('reply-indicator').classList.remove('hidden');
                document.getElementById('main-comment-input').focus();
            },

            cancelReply() {
                this.currentReplyTarget.parentCommentId = null;
                document.getElementById('reply-indicator').classList.add('hidden');
            },

            async postComment() {
                const { postId, parentCommentId } = this.currentReplyTarget;
                if (!postId) return;

                const input = document.getElementById('main-comment-input');
                const button = document.getElementById('main-comment-send-btn');
                const content = input.value.trim();
                if (!content) return;

                button.disabled = true;

                try {
                    const { error } = await State.supabase.from('comments').insert({
                        post_id: postId,
                        user_id: State.telegramUser.id,
                        parent_comment_id: parentCommentId,
                        content: content
                    });
                    if (error) throw error;
                    
                    input.value = '';
                    this.cancelReply();

                } catch (error) {
                    console.error('Ошибка отправки комментария:', error);
                    State.tg.showAlert(`Не удалось отправить комментарий.`);
                } finally {
                    button.disabled = false;
                }
            }
        };

        // --- МОДУЛЬ ИНТЕГРАЦИИ С TELEGRAM ---
        const TelegramModule = {
            init() {
                State.tg.ready();
                State.tg.expand();
                this.applyTheme(State.tg.themeParams);
                this.setupEventListeners();
            },

            applyTheme(themeParams) {
                const root = document.documentElement;
                root.style.setProperty('--bg-color', themeParams.bg_color || '#f3f4f6');
                root.style.setProperty('--secondary-bg-color', themeParams.secondary_bg_color || '#ffffff');
                root.style.setProperty('--text-color', themeParams.text_color || '#1f2937');
                root.style.setProperty('--hint-color', themeParams.hint_color || '#6b7280');
                root.style.setProperty('--button-color', themeParams.button_color || '#3b82f6');
                root.style.setProperty('--button-text-color', themeParams.button_text_color || '#ffffff');
                
                State.tg.setHeaderColor(themeParams.secondary_bg_color || '#ffffff');
                State.tg.setBackgroundColor(themeParams.bg_color || '#f3f4f6');
            },

            setupEventListeners() {
                State.tg.onEvent('themeChanged', () => this.applyTheme(State.tg.themeParams));
                State.tg.onEvent('backButtonClicked', this.handleBackButton);
                State.tg.onEvent('mainButtonClicked', this.handleMainButton);
                
                State.tg.SettingsButton.show();
                State.tg.onEvent('settingsButtonClicked', this.showSettings);

                State.tg.onEvent('qrTextReceived', (eventData) => {
                    State.tg.closeScanQrPopup();
                    try {
                        const urlPattern = /startapp=user(\d+)/;
                        const match = eventData.data.match(urlPattern);
                        if (match && match[1]) {
                            const userId = parseInt(match[1], 10);
                            UI.showUserDetailModal(userId);
                        } else {
                            State.tg.showAlert('Этот QR-код не поддерживается.');
                        }
                    } catch (e) {
                        State.tg.showAlert('Не удалось прочитать QR-код.');
                    }
                });
            },

            updateMainButton(viewId) {
                const tg_main_btn = State.tg.MainButton;
                tg_main_btn.offClick(this.handleMainButton); // Сбрасываем старый обработчик

                if (viewId === 'map-view') {
                    if (State.isRunning) {
                        tg_main_btn.setText('Остановить пробежку');
                        tg_main_btn.setParams({ color: 'var(--destructive-color)', text_color: '#ffffff' });
                    } else {
                        tg_main_btn.setText('Начать пробежку');
                        tg_main_btn.setParams({ color: 'var(--success-color)', text_color: '#ffffff' });
                    }
                    tg_main_btn.show();
                } else if (viewId === 'profile-view') {
                    tg_main_btn.setText('Редактировать статус');
                    tg_main_btn.setParams({ color: 'var(--button-color)', text_color: 'var(--button-text-color)' });
                    tg_main_btn.show();
                } else {
                    tg_main_btn.hide();
                }
                
                tg_main_btn.onClick(this.handleMainButton);
            },
            
            handleMainButton() {
                const currentView = document.querySelector('.view.active').id;
                if (currentView === 'map-view') {
                    State.isRunning ? Game.stopRun() : Game.startRun();
                } else if (currentView === 'profile-view') {
                    App.editStatus();
                }
            },

            updateBackButton() {
                if (State.activeModal) {
                    State.tg.BackButton.show();
                } else {
                    State.tg.BackButton.hide();
                }
            },

            handleBackButton() {
                if (State.activeModal) {
                    UI.hideModal(State.activeModal);
                    UI.hideBottomSheet(State.activeModal); // Попытается скрыть и то, и другое
                }
            },

            showSettings() {
                State.tg.showPopup({
                    title: 'Настройки',
                    message: 'Здесь вы сможете изменить тему карты, единицы измерения и другие параметры. Эта функция в разработке.',
                    buttons: [{type: 'ok', text: 'Понятно'}]
                });
            },

            showQrScanner() {
                State.tg.HapticFeedback.impactOccurred('light');
                State.tg.showScanQrPopup({ text: 'Наведите на QR-код другого игрока' });
            },

            inviteFriend() {
                State.tg.HapticFeedback.impactOccurred('light');
                const botUsername = State.tg.initDataUnsafe.bot_username || 'TerraRunBot';
                const text = encodeURIComponent(`Присоединяйся ко мне в TerraRun и давай захватывать территории вместе!`);
                const url = `https://t.me/share/url?url=${encodeURIComponent(`https://t.me/${botUsername}/app`)}&text=${text}`;
                State.tg.openTelegramLink(url);
            },
            
            shareProfile(userId, userName) {
                 const botUsername = State.tg.initDataUnsafe.bot_username || 'TerraRunBot';
                 const url = `https://t.me/share/url?url=${encodeURIComponent(`https://t.me/${botUsername}/app?startapp=user${userId}`)}&text=${encodeURIComponent(`Посмотри на территорию, которую захватил(а) ${userName} в TerraRun!`)}`;
                 State.tg.openTelegramLink(url);
            },
            
            sharePost(postId, postTitle, postArea) {
                State.tg.switchInlineQuery(`Мое новое достижение в TerraRun: "${postTitle}" (${postArea})`);
            },
            
            showDonation() {
                State.tg.HapticFeedback.impactOccurred('light');
                // Замените на реальную ссылку на инвойс от @BotFather
                const invoiceLink = '...'; // Например: 'https://t.me/invoice/example_invoice'
                if(invoiceLink === '...') {
                    State.tg.showAlert('Функция доната в данный момент не настроена.');
                    return;
                }
                State.tg.openInvoice(invoiceLink, (status) => {
                    if (status === 'paid') {
                        State.tg.HapticFeedback.notificationOccurred('success');
                        State.tg.showAlert('Спасибо за вашу поддержку! Вы невероятны!');
                    } else if (status === 'failed') {
                        State.tg.HapticFeedback.notificationOccurred('error');
                        State.tg.showAlert('Не удалось обработать платеж.');
                    }
                });
            }
        };

        // --- ГЛАВНЫЙ МОДУЛЬ ПРИЛОЖЕНИЯ ---
        const App = {
            async init() {
                document.getElementById('initial-loader').classList.remove('hidden');
                
                TelegramModule.init();
                UI.init();
                
                const startParam = State.tg.initDataUnsafe.start_param;
                if (startParam && startParam.startsWith('user')) {
                    State.deepLinkedUserId = parseInt(startParam.substring(4), 10);
                }

                if (State.tg.initDataUnsafe?.user) {
                    State.telegramUser = State.tg.initDataUnsafe.user;
                    await this.initializeWithUser();
                } else {
                    document.getElementById('initial-loader').classList.add('hidden');
                    document.getElementById('auth-screen').classList.remove('hidden');
                    // Логика для входа через виджет, если приложение открыто в браузере
                }
            },

            async initializeWithUser() {
                try {
                    await MapModule.requestAndWatchGeo();
                    
                    SupabaseModule.init();
                    await SupabaseModule.fetchInitialData();
                    
                    MapModule.init();
                    UI.updateProfileUI(State.currentUserProfile);
                    UI.updateLeaderboard(State.allProfilesData);
                    MapModule.drawAllUserTerritories();
                    Feed.renderAllFeeds();
                    SupabaseModule.listenToChanges();

                    document.getElementById('initial-loader').classList.add('hidden');
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('bottom-navbar').classList.remove('hidden');

                    State.tg.CloudStorage.getItem('lastView', (err, value) => {
                        if (value) UI.showView(value);
                    });

                    if (State.deepLinkedUserId) {
                        // Задержка для гарантии рендера
                        setTimeout(() => UI.showUserDetailModal(State.deepLinkedUserId), 500);
                        State.deepLinkedUserId = null;
                    }

                } catch (error) {
                    console.error("Initialization failed:", error);
                    document.getElementById('initial-loader').classList.add('hidden');
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('auth-content').innerHTML = `
                        <h1 class="text-2xl font-bold mb-4 text-red-500">Ошибка инициализации</h1>
                        <p class="mb-6" style="color: var(--hint-color);">Не удалось запустить приложение. Проверьте разрешения на геолокацию и попробуйте снова.</p>
                        <p class="text-xs text-gray-400 mt-2">${error.message}</p>
                        <button onclick="window.location.reload()" class="mt-4 font-bold py-3 px-6 rounded-full" style="background-color: var(--button-color); color: var(--button-text-color);">Перезапустить</button>
                    `;
                }
            },
            
            async editStatus() {
                State.tg.HapticFeedback.impactOccurred('light');
                State.tg.showPrompt('Введите ваш новый статус', (newStatus) => {
                    if (newStatus && newStatus.trim().length > 0) {
                        const trimmedStatus = newStatus.trim().slice(0, 70);
                        const updatedProfile = { ...State.currentUserProfile, status: trimmedStatus };
                        
                        SupabaseModule.saveUserProfile(updatedProfile)
                            .then(() => {
                                State.currentUserProfile.status = trimmedStatus;
                                document.getElementById('profile-status').textContent = trimmedStatus;
                                State.tg.HapticFeedback.notificationOccurred('success');
                            })
                            .catch(() => {
                                State.tg.HapticFeedback.notificationOccurred('error');
                                State.tg.showAlert('Не удалось сохранить статус.');
                            });
                    }
                });
            },

            generateColorFromId(id) {
                const strId = String(id);
                let hash = 0;
                for (let i = 0; i < strId.length; i++) {
                    hash = strId.charCodeAt(i) + ((hash << 5) - hash);
                }
                const h = hash % 360;
                return `hsl(${h}, 80%, 65%)`;
            },

            // --- Публичные методы для вызова из HTML ---
            showView: UI.showView,
        };

        // --- Глобальные функции для вызова из HTML ---
        window.App = App;
        window.UI = UI;
        window.Feed = Feed;
        
        // --- ЗАПУСК ПРИЛОЖЕНИЯ ---
        document.addEventListener('DOMContentLoaded', () => App.init());

    </script>

</body>
</html>
